# 评价修改/删除规则优化方案

> **文档目的**: 分析当前实现，参考市面主流产品，提出优化建议  
> **创建时间**: 2025-10-13  
> **作者**: 家政平台技术团队

---

## 📋 目录

1. [当前实现分析](#当前实现分析)
2. [市面产品调研](#市面产品调研)
3. [问题分析](#问题分析)
4. [优化方案](#优化方案)
5. [实施建议](#实施建议)

---

## 当前实现分析

### 🔍 现有规则

**修改规则**:
- ✅ 支持修改
- ⏰ 时间限制：评价发布后 **7天内** 可修改
- 🔒 权限验证：只能修改自己的评价
- 📝 可修改内容：评分、详细评分、文字内容、图片、标签、匿名状态
- ❌ 限制：超过7天后无法修改

**删除规则**:
- ✅ 支持删除
- ⏰ 时间限制：评价发布后 **7天内** 可删除
- 🔒 权限验证：只能删除自己的评价
- 💥 删除方式：**物理删除**（直接从数据库删除）
- ❌ 限制：超过7天后无法删除

**代码实现**:
```java
// 修改评价 - 7天限制
if (rating.getCreatedTime().plusDays(7).isBefore(LocalDateTime.now())) {
    throw new BusinessException("评价修改期限已过");
}

// 删除评价 - 7天限制 + 物理删除
if (rating.getCreatedTime().plusDays(7).isBefore(LocalDateTime.now())) {
    throw new BusinessException("评价删除期限已过");
}
orderRatingMapper.deleteById(rating.getId()); // 物理删除
```

---

## 市面产品调研

### 1. 淘宝/天猫

**修改规则**:
- ⏰ 评价发布后 **30天内** 可修改
- 🔢 修改次数：**仅限1次**
- 📝 可修改内容：文字、图片、标签
- ❌ 不可修改：评分（星级）
- 💡 特色：修改后会显示"已修改"标签

**删除规则**:
- ❌ **不支持删除**
- 💡 原因：保护评价真实性，防止商家诱导删除差评

**优点**:
- 平衡了用户修改需求和评价真实性
- 限制修改次数防止频繁修改
- 评分不可修改保证核心指标稳定

### 2. 美团/大众点评

**修改规则**:
- ⏰ 评价发布后 **15天内** 可修改
- 🔢 修改次数：**不限次数**（但有频率限制）
- 📝 可修改内容：全部（评分、文字、图片）
- 💡 特色：修改后显示"已编辑"标签，且显示编辑时间

**删除规则**:
- ⏰ 评价发布后 **15天内** 可删除
- 💥 删除方式：**逻辑删除**（隐藏评价，不计入评分）
- 💡 特色：删除后不可恢复，但后台保留记录

**优点**:
- 时间窗口适中（15天）
- 修改灵活但有记录
- 逻辑删除保留数据用于风控

### 3. 京东

**修改规则**:
- ⏰ 评价发布后 **30天内** 可修改
- 🔢 修改次数：**不限次数**
- 📝 可修改内容：全部
- 💡 特色：修改历史可查看（用户自己可见）

**删除规则**:
- ⏰ 评价发布后 **30天内** 可删除
- 💥 删除方式：**逻辑删除**
- 💡 特色：删除后可在"已删除评价"中查看

**优点**:
- 时间窗口长，用户体验好
- 保留修改历史，透明度高
- 逻辑删除便于数据分析

### 4. 滴滴出行

**修改规则**:
- ⏰ 评价发布后 **24小时内** 可修改
- 🔢 修改次数：**仅限1次**
- 📝 可修改内容：文字、标签
- ❌ 不可修改：评分

**删除规则**:
- ❌ **不支持删除**
- 💡 原因：服务类评价，保护司机/乘客权益

**优点**:
- 时间窗口短，防止恶意修改
- 评分不可改，保证核心指标
- 适合即时服务场景

### 5. 小红书

**修改规则**:
- ⏰ 评价发布后 **永久可修改**
- 🔢 修改次数：**不限次数**
- 📝 可修改内容：全部
- 💡 特色：修改后显示"已编辑"，且显示编辑次数

**删除规则**:
- ⏰ **永久可删除**
- 💥 删除方式：**逻辑删除**
- 💡 特色：删除后可恢复（30天内）

**优点**:
- 用户体验最好
- 适合内容社区
- 但可能影响评价真实性

---

## 问题分析

### 🚨 当前实现的问题

#### 1. 时间窗口问题

**问题**: 7天时间窗口可能过短

**场景**:
- 用户可能在服务后一段时间才发现问题
- 用户可能因为忙碌错过修改期限
- 家政服务的效果可能需要更长时间才能显现

**影响**:
- 用户体验差
- 可能导致用户投诉
- 评价质量可能受影响（用户草率评价后无法修改）

#### 2. 物理删除问题

**问题**: 直接从数据库删除评价

**风险**:
- ❌ 数据丢失，无法追溯
- ❌ 影响评分统计的准确性
- ❌ 无法进行数据分析和风控
- ❌ 可能被商家利用（诱导删除差评）
- ❌ 阿姨的评分会突然变化

**场景示例**:
```
阿姨评分: 4.8 (100条评价)
用户删除1条差评 (1星)
↓
阿姨评分: 4.9 (99条评价)  ← 评分突然提升，不合理
```

#### 3. 修改限制问题

**问题**: 没有修改次数限制

**风险**:
- 用户可能频繁修改评价
- 可能被恶意利用（先好评后差评）
- 增加系统负担

#### 4. 缺少修改记录

**问题**: 没有记录修改历史

**影响**:
- 无法追溯评价变更
- 难以发现恶意修改
- 无法进行数据分析

#### 5. 评分可修改问题

**问题**: 评分（星级）可以修改

**风险**:
- 评分是核心指标，修改会影响商品/阿姨评分
- 可能被商家利用（诱导修改评分）
- 评分统计不稳定

---

## 优化方案

### 🎯 推荐方案（综合型）

基于家政服务的特点，推荐采用 **美团模式 + 淘宝限制** 的组合方案：

#### 方案A：平衡型（推荐）⭐

**修改规则**:
- ⏰ 时间窗口：**15天**（适中）
- 🔢 修改次数：**仅限1次**（防止频繁修改）
- 📝 可修改内容：
  - ✅ 文字评价
  - ✅ 图片
  - ✅ 标签
  - ✅ 详细评分（服务态度、质量等）
  - ❌ **综合评分（星级）不可修改**
- 💡 修改后显示"已编辑"标签
- 📝 记录修改历史（后台可见）

**删除规则**:
- ⏰ 时间窗口：**15天**
- 💥 删除方式：**逻辑删除**
  - 评价状态改为 `DELETED`
  - 不显示在列表中
  - 不计入评分统计
  - 后台保留记录
- 🔒 删除后不可恢复
- 📊 删除的评价仍保留在数据库中用于数据分析

**优点**:
- ✅ 时间窗口适中，用户体验好
- ✅ 限制修改次数，防止滥用
- ✅ 评分不可改，保证核心指标稳定
- ✅ 逻辑删除，保留数据用于风控
- ✅ 适合家政服务场景

**缺点**:
- ⚠️ 需要修改数据库结构（添加字段）
- ⚠️ 需要调整评分计算逻辑

---

#### 方案B：严格型（适合初期）

**修改规则**:
- ⏰ 时间窗口：**7天**（当前实现）
- 🔢 修改次数：**仅限1次**
- 📝 可修改内容：文字、图片、标签
- ❌ **评分不可修改**

**删除规则**:
- ⏰ 时间窗口：**7天**
- 💥 删除方式：**逻辑删除**
- ❌ 删除后不可恢复

**优点**:
- ✅ 改动最小，快速实现
- ✅ 保证评价真实性
- ✅ 防止恶意修改

**缺点**:
- ⚠️ 时间窗口较短
- ⚠️ 用户体验一般

---

#### 方案C：宽松型（适合后期）

**修改规则**:
- ⏰ 时间窗口：**30天**
- 🔢 修改次数：**不限**（但有频率限制：24小时内最多1次）
- 📝 可修改内容：全部（包括评分）
- 💡 显示修改次数和最后编辑时间

**删除规则**:
- ⏰ 时间窗口：**30天**
- 💥 删除方式：**逻辑删除**
- 🔄 删除后可恢复（30天内）

**优点**:
- ✅ 用户体验最好
- ✅ 灵活性高

**缺点**:
- ⚠️ 可能影响评价真实性
- ⚠️ 需要更复杂的风控机制

---

### 📊 方案对比

| 维度 | 当前实现 | 方案A（推荐）| 方案B（严格）| 方案C（宽松）|
|------|---------|------------|------------|------------|
| 修改时间 | 7天 | 15天 | 7天 | 30天 |
| 修改次数 | 无限制 | 1次 | 1次 | 不限（有频率限制）|
| 评分可改 | ✅ | ❌ | ❌ | ✅ |
| 删除方式 | 物理删除 | 逻辑删除 | 逻辑删除 | 逻辑删除 |
| 删除时间 | 7天 | 15天 | 7天 | 30天 |
| 删除恢复 | ❌ | ❌ | ❌ | ✅ (30天) |
| 修改记录 | ❌ | ✅ | ✅ | ✅ |
| 用户体验 | ⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| 真实性 | ⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ |
| 风控能力 | ⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| 实现难度 | - | ⭐⭐⭐ | ⭐⭐ | ⭐⭐⭐⭐ |

---

## 实施建议

### 🚀 分阶段实施

#### 阶段1：紧急修复（1周内）

**目标**: 解决物理删除问题

**任务**:
1. 将删除改为逻辑删除
2. 添加 `edit_count` 字段记录修改次数
3. 添加 `edit_time` 字段记录最后编辑时间

**数据库变更**:
```sql
-- 1. 添加修改次数字段
ALTER TABLE `order_rating`
ADD COLUMN `edit_count` INT DEFAULT 0 COMMENT '修改次数' AFTER `status`;

-- 2. 添加最后编辑时间字段
ALTER TABLE `order_rating`
ADD COLUMN `edit_time` DATETIME NULL COMMENT '最后编辑时间' AFTER `edit_count`;

-- 3. 添加删除时间字段
ALTER TABLE `order_rating`
ADD COLUMN `deleted_time` DATETIME NULL COMMENT '删除时间' AFTER `edit_time`;

-- 4. 添加 DELETED 状态（已有 status 字段）
-- status 可选值：DRAFT-草稿, PUBLISHED-已发布, HIDDEN-已隐藏, DELETED-已删除
```

**代码修改**:
```java
// 删除评价 - 改为逻辑删除
@Override
@Transactional(rollbackFor = Exception.class)
public void deleteRating(Long orderId, Long userId) {
    // ... 验证逻辑 ...
    
    // 逻辑删除：修改状态而非物理删除
    rating.setStatus("DELETED");
    rating.setDeletedTime(LocalDateTime.now());
    orderRatingMapper.updateById(rating);
    
    log.info("用户删除评价成功（逻辑删除），用户ID: {}, 订单ID: {}", userId, orderId);
}

// 修改评价 - 记录修改次数和时间
@Override
@Transactional(rollbackFor = Exception.class)
public void updateRating(Long orderId, Long userId, OrderRatingRequest request) {
    // ... 验证逻辑 ...
    
    // 更新评价
    rating.setContent(request.getContent());
    rating.setImages(request.getImages() != null ? JSON.toJSONString(request.getImages()) : null);
    rating.setTags(request.getTags() != null ? JSON.toJSONString(request.getTags()) : null);
    // ... 其他字段 ...
    
    // 记录修改
    rating.setEditCount(rating.getEditCount() + 1);
    rating.setEditTime(LocalDateTime.now());
    rating.setUpdatedTime(LocalDateTime.now());
    
    orderRatingMapper.updateById(rating);
    
    log.info("用户修改评价成功，用户ID: {}, 订单ID: {}, 修改次数: {}", 
        userId, orderId, rating.getEditCount());
}
```

**评分计算调整**:
```java
// ProductRatingUpdateTask.java 和 StaffRatingUpdateTask.java
// 查询时排除已删除的评价
List<OrderRating> ratings = orderRatingMapper.selectList(
    new LambdaQueryWrapper<OrderRating>()
        .eq(OrderRating::getProductId, product.getId())
        .eq(OrderRating::getStatus, "PUBLISHED")  // 只统计已发布的
        .ne(OrderRating::getStatus, "DELETED")    // 排除已删除的
);
```

---

#### 阶段2：功能优化（2-3周内）

**目标**: 实施方案A（推荐方案）

**任务**:
1. 修改时间窗口调整为15天
2. 限制修改次数为1次
3. 禁止修改综合评分
4. 添加"已编辑"标签显示

**代码修改**:
```java
// 1. 修改时间窗口调整为15天
if (rating.getCreatedTime().plusDays(15).isBefore(LocalDateTime.now())) {
    throw new BusinessException("评价修改期限已过（15天内可修改）");
}

// 2. 限制修改次数
if (rating.getEditCount() >= 1) {
    throw new BusinessException("评价仅可修改1次，您已达到修改次数上限");
}

// 3. 禁止修改综合评分
@Override
@Transactional(rollbackFor = Exception.class)
public void updateRating(Long orderId, Long userId, OrderRatingRequest request) {
    // ... 验证逻辑 ...
    
    // ❌ 不允许修改综合评分
    // rating.setScore(BigDecimal.valueOf(request.getScore()));
    
    // ✅ 允许修改详细评分
    rating.setServiceAttitudeScore(request.getServiceAttitudeScore());
    rating.setServiceQualityScore(request.getServiceQualityScore());
    rating.setPunctualityScore(request.getPunctualityScore());
    rating.setCleanlinessScore(request.getCleanlinessScore());
    
    // ✅ 允许修改文字、图片、标签
    rating.setContent(request.getContent());
    rating.setImages(request.getImages() != null ? JSON.toJSONString(request.getImages()) : null);
    rating.setTags(request.getTags() != null ? JSON.toJSONString(request.getTags()) : null);
    
    // 记录修改
    rating.setEditCount(rating.getEditCount() + 1);
    rating.setEditTime(LocalDateTime.now());
    rating.setUpdatedTime(LocalDateTime.now());
    
    orderRatingMapper.updateById(rating);
}
```

**响应DTO调整**:
```java
@Data
@Schema(description = "订单评价响应DTO")
public class OrderRatingResponse {
    // ... 现有字段 ...
    
    @Schema(description = "修改次数")
    private Integer editCount;
    
    @Schema(description = "最后编辑时间")
    private LocalDateTime editTime;
    
    @Schema(description = "是否已编辑")
    private Boolean isEdited;
    
    // 计算是否已编辑
    public Boolean getIsEdited() {
        return editCount != null && editCount > 0;
    }
}
```

**前端显示**:
```vue
<view class="rating-card">
  <!-- 评价内容 -->
  <view class="rating-content">{{ rating.content }}</view>
  
  <!-- 已编辑标签 -->
  <view v-if="rating.isEdited" class="edit-tag">
    已编辑
    <text class="edit-time">{{ formatTime(rating.editTime) }}</text>
  </view>
</view>
```

---

#### 阶段3：增强功能（1-2个月内）

**目标**: 添加修改历史和风控机制

**任务**:
1. 创建评价修改历史表
2. 记录每次修改的详细内容
3. 添加修改频率限制
4. 添加异常修改检测

**数据库变更**:
```sql
-- 创建评价修改历史表
CREATE TABLE `order_rating_history` (
  `id` BIGINT(20) NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `rating_id` BIGINT(20) NOT NULL COMMENT '评价ID',
  `user_id` BIGINT(20) NOT NULL COMMENT '用户ID',
  `action` VARCHAR(20) NOT NULL COMMENT '操作类型: CREATE-创建, UPDATE-修改, DELETE-删除',
  `old_score` DECIMAL(3,1) NULL COMMENT '修改前评分',
  `new_score` DECIMAL(3,1) NULL COMMENT '修改后评分',
  `old_content` VARCHAR(1000) NULL COMMENT '修改前内容',
  `new_content` VARCHAR(1000) NULL COMMENT '修改后内容',
  `old_images` VARCHAR(1000) NULL COMMENT '修改前图片',
  `new_images` VARCHAR(1000) NULL COMMENT '修改后图片',
  `ip_address` VARCHAR(50) NULL COMMENT 'IP地址',
  `user_agent` VARCHAR(500) NULL COMMENT '用户代理',
  `created_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '操作时间',
  PRIMARY KEY (`id`),
  KEY `idx_rating_id` (`rating_id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_created_time` (`created_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='评价修改历史表';
```

**风控机制**:
```java
// 异常修改检测
private void checkAbnormalEdit(OrderRating rating, OrderRatingRequest request) {
    // 1. 检测评分大幅变化（如5星改1星）
    if (rating.getScore() != null) {
        BigDecimal oldScore = rating.getScore();
        BigDecimal newScore = BigDecimal.valueOf(request.getScore());
        if (Math.abs(oldScore.doubleValue() - newScore.doubleValue()) >= 3) {
            log.warn("检测到评分大幅变化，用户ID: {}, 订单ID: {}, 旧评分: {}, 新评分: {}", 
                rating.getUserId(), rating.getOrderId(), oldScore, newScore);
            // 可以触发人工审核
        }
    }
    
    // 2. 检测频繁修改（虽然限制了1次，但可以检测尝试次数）
    // 3. 检测敏感词变化
    // 4. 检测图片变化
}
```

---

### 📝 配置化管理

将规则配置化，便于后续调整：

```sql
-- 在 system_config 表中添加配置
INSERT INTO `system_config` (`config_key`, `config_value`, `config_desc`, `config_type`) VALUES
('rating.edit.days', '15', '评价可修改天数', 'RATING'),
('rating.edit.max.count', '1', '评价最大修改次数', 'RATING'),
('rating.edit.score.allowed', 'false', '是否允许修改评分', 'RATING'),
('rating.delete.days', '15', '评价可删除天数', 'RATING'),
('rating.delete.type', 'LOGICAL', '删除方式：PHYSICAL-物理删除, LOGICAL-逻辑删除', 'RATING');
```

**代码中使用配置**:
```java
@Service
public class OrderRatingServiceImpl implements OrderRatingService {
    
    @Autowired
    private SystemConfigService systemConfigService;
    
    @Override
    public void updateRating(Long orderId, Long userId, OrderRatingRequest request) {
        // 从配置中获取规则
        int editDays = systemConfigService.getIntValue("rating.edit.days", 15);
        int maxEditCount = systemConfigService.getIntValue("rating.edit.max.count", 1);
        boolean scoreAllowed = systemConfigService.getBooleanValue("rating.edit.score.allowed", false);
        
        // 检查时间限制
        if (rating.getCreatedTime().plusDays(editDays).isBefore(LocalDateTime.now())) {
            throw new BusinessException(String.format("评价修改期限已过（%d天内可修改）", editDays));
        }
        
        // 检查修改次数
        if (rating.getEditCount() >= maxEditCount) {
            throw new BusinessException(String.format("评价最多可修改%d次", maxEditCount));
        }
        
        // 检查是否允许修改评分
        if (!scoreAllowed && request.getScore() != null) {
            throw new BusinessException("评分不可修改");
        }
        
        // ... 其他逻辑 ...
    }
}
```

---

## 总结与建议

### 🎯 推荐实施路径

1. **立即实施**（本周内）:
   - ✅ 将物理删除改为逻辑删除
   - ✅ 添加修改次数和时间字段
   - ✅ 调整评分计算逻辑（排除已删除评价）

2. **短期优化**（2-3周内）:
   - ✅ 实施方案A（15天窗口 + 1次修改 + 评分不可改）
   - ✅ 添加"已编辑"标签显示
   - ✅ 配置化管理

3. **中期增强**（1-2个月内）:
   - ✅ 添加修改历史记录
   - ✅ 实施风控机制
   - ✅ 数据分析和监控

### 📊 预期效果

**用户体验**:
- ✅ 15天窗口，足够用户修改
- ✅ 1次修改机会，防止频繁修改
- ✅ 评分不可改，保证核心指标

**平台利益**:
- ✅ 逻辑删除，保留数据用于分析
- ✅ 修改历史，便于风控
- ✅ 评价真实性得到保障

**阿姨权益**:
- ✅ 评分稳定，不会因删除突变
- ✅ 恶意修改可追溯
- ✅ 评价更真实可信

---

**文档版本**: v1.0.0  
**创建时间**: 2025-10-13  
**作者**: 家政平台技术团队

