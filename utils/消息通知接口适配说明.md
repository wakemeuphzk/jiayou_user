# 消息通知接口适配说明

## 📋 适配概述

已将消息通知工具类的所有接口路径从通用路径 `/notification/` 适配为用户端专用路径 `/user/notifications/`。

## 🔄 接口路径变更对照表

| 功能 | 原路径 | 新路径 | 方法 | 说明 |
|------|--------|--------|------|------|
| 消息统计 | `/notification/stat` | `/user/notifications/stat` | GET | 获取未读数等统计信息 |
| 消息列表 | `/notification/list` | `/user/notifications/list` | GET | 分页获取消息列表 |
| 消息详情 | `/notification/{id}` | `/user/notifications/{id}` | GET | 获取详情并自动标记已读 |
| 标记已读 | `/notification/{id}/read` | `/user/notifications/{id}/read` | PUT | 单条标记已读 |
| 批量已读 | `/notification/batch-read` | `/user/notifications/batch-read` | PUT | 批量标记已读 |
| 全部已读 | `/notification/read-all` | `/user/notifications/read-all` | PUT | 全部标记已读 |
| 删除消息 | `/notification/{id}` | `/user/notifications/{id}` | DELETE | 删除单条消息 |
| 保存订阅 | `/notification/subscribe` | `/user/notifications/subscribe` | POST | 保存微信订阅授权 |

## 🎯 关键变更

### 1. 消息详情接口优化
```javascript
// 原实现：需要先调用详情接口，再单独标记已读
static async getMessageDetail(messageId) {
  // 获取详情
  const res = await request({ url: `/notification/${messageId}` })
  return res.data
}

// 新实现：获取详情时后端自动标记已读
static async getMessageDetail(messageId) {
  const res = await request({ url: `/user/notifications/${messageId}` })
  
  if (res.code === 200) {
    // 后端已自动标记已读，更新徽标
    this.updateTabBarBadge()
    return res.data
  }
  return null
}
```

### 2. 消息点击处理优化
```javascript
// 原实现：点击后单独调用标记已读接口
static async handleMessageClick(message) {
  if (message.status === 'UNREAD') {
    await this.markAsRead(message.id)  // ❌ 单独调用
  }
  // 跳转...
}

// 新实现：利用获取详情接口的自动标记功能
static async handleMessageClick(message) {
  if (message.status === 'UNREAD') {
    await this.getMessageDetail(message.id)  // ✅ 获取详情时自动标记
  }
  // 跳转...
}
```

### 3. 订阅授权接口简化
```javascript
// 后端接口说明：不需要单独传 userId，从 token 中自动获取
POST /user/notifications/subscribe

请求体：
{
  "templateId": "模板ID",
  "templateCode": "模板编码"
}

// 后端会自动从 JWT token 中提取 userId
// 前端无需手动传递 userId
```

## 📝 完整的接口规范

### 1. GET /user/notifications/stat
**功能**: 获取消息统计

**请求**: 无参数

**响应**:
```json
{
  "code": 200,
  "data": {
    "unreadCount": 5,
    "orderUnreadCount": 2,
    "serviceUnreadCount": 1,
    "paymentUnreadCount": 1,
    "systemUnreadCount": 1
  }
}
```

### 2. GET /user/notifications/list
**功能**: 分页获取消息列表

**请求参数**:
- `type`: 消息类型（可选）
- `status`: 消息状态（可选）
- `page`: 页码
- `size`: 每页大小

**响应**:
```json
{
  "code": 200,
  "data": {
    "records": [
      {
        "id": 1,
        "type": "ORDER",
        "title": "订单已接单",
        "content": "您的订单已被阿姨接单",
        "status": "UNREAD",
        "jumpUrl": "/pages/order/detail",
        "jumpParams": { "orderId": 123 },
        "createdTime": "2024-01-01T10:00:00"
      }
    ],
    "total": 10,
    "current": 1,
    "pages": 1
  }
}
```

### 3. GET /user/notifications/{id}
**功能**: 获取消息详情（自动标记已读）

**请求**: 路径参数 `id`

**响应**:
```json
{
  "code": 200,
  "data": {
    "id": 1,
    "type": "ORDER",
    "title": "订单已接单",
    "content": "您的订单已被阿姨接单",
    "status": "READ",
    "jumpUrl": "/pages/order/detail",
    "jumpParams": { "orderId": 123 },
    "createdTime": "2024-01-01T10:00:00",
    "readTime": "2024-01-01T10:05:00"
  }
}
```

### 4. PUT /user/notifications/{id}/read
**功能**: 单条标记已读

**请求**: 路径参数 `id`

**响应**:
```json
{
  "code": 200,
  "message": "操作成功"
}
```

### 5. PUT /user/notifications/batch-read
**功能**: 批量标记已读

**请求体**: 消息ID数组
```json
[1, 2, 3, 4, 5]
```

**响应**:
```json
{
  "code": 200,
  "message": "操作成功"
}
```

### 6. PUT /user/notifications/read-all
**功能**: 全部标记已读

**请求体**:
```json
{
  "type": "ORDER"  // 可选，指定类型
}
```

**响应**:
```json
{
  "code": 200,
  "message": "操作成功"
}
```

### 7. DELETE /user/notifications/{id}
**功能**: 删除单条消息

**请求**: 路径参数 `id`

**响应**:
```json
{
  "code": 200,
  "message": "操作成功"
}
```

### 8. POST /user/notifications/subscribe
**功能**: 保存微信订阅授权

**请求体**:
```json
{
  "templateId": "模板ID",
  "templateCode": "ORDER_ACCEPTED"
}
```

**响应**:
```json
{
  "code": 200,
  "message": "操作成功"
}
```

**说明**: 
- ✅ 不需要传递 `userId`，后端从 JWT token 自动获取
- ✅ 支持批量保存，前端循环调用即可

## 🔧 使用示例

### 获取消息统计并更新徽标
```javascript
import NotificationUtil from '@/utils/notificationUtil.js'

// 获取未读数量
const stat = await NotificationUtil.getStat()
console.log('未读消息:', stat.unreadCount)

// 自动更新 TabBar 徽标
await NotificationUtil.updateTabBarBadge(2)  // 索引2是"我的"
```

### 获取消息列表
```javascript
// 获取全部消息
const result = await NotificationUtil.getMessageList({
  page: 1,
  size: 20
})

// 获取订单类消息
const orderMessages = await NotificationUtil.getMessageList({
  type: 'ORDER',
  page: 1,
  size: 20
})

// 获取未读消息
const unreadMessages = await NotificationUtil.getMessageList({
  status: 'UNREAD',
  page: 1,
  size: 20
})
```

### 点击消息处理
```javascript
// 点击消息时自动标记已读并跳转
await NotificationUtil.handleMessageClick(message)

// 内部流程：
// 1. 如果是未读消息，调用 getMessageDetail (自动标记已读)
// 2. 更新徽标
// 3. 根据 jumpUrl 跳转页面
```

### 标记消息已读
```javascript
// 单条标记
await NotificationUtil.markAsRead(messageId)

// 批量标记
await NotificationUtil.batchMarkAsRead([1, 2, 3, 4, 5])

// 全部标记
await NotificationUtil.markAllAsRead()

// 标记某类型全部已读
await NotificationUtil.markAllAsRead('ORDER')
```

### 订阅消息授权
```javascript
// 请求订阅授权（会自动保存到后端）
const result = await NotificationUtil.requestSubscribe([
  'ORDER_ACCEPTED',
  'SERVICE_STARTING',
  'ORDER_COMPLETED'
])

if (result.success) {
  console.log('订阅成功')
} else {
  console.log('订阅失败:', result.error)
}
```

## ✅ 适配完成清单

- ✅ 消息统计接口 - `/user/notifications/stat`
- ✅ 消息列表接口 - `/user/notifications/list`
- ✅ 消息详情接口 - `/user/notifications/{id}`（自动标记已读）
- ✅ 单条标记已读 - `/user/notifications/{id}/read`
- ✅ 批量标记已读 - `/user/notifications/batch-read`
- ✅ 全部标记已读 - `/user/notifications/read-all`
- ✅ 删除消息接口 - `/user/notifications/{id}`
- ✅ 订阅授权接口 - `/user/notifications/subscribe`（无需传 userId）
- ✅ 消息点击处理优化（利用详情接口的自动标记功能）
- ✅ 徽标自动更新机制

## 🎯 注意事项

1. **Token 认证**: 所有接口都需要在 header 中携带 JWT token
2. **自动标记**: 获取消息详情接口会自动标记该消息为已读
3. **徽标更新**: 所有修改消息状态的操作都会自动更新 TabBar 徽标
4. **userId 自动获取**: 后端从 token 中提取 userId，前端无需传递

## 📞 技术支持

如有问题，请联系开发团队。

