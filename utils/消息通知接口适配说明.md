# æ¶ˆæ¯é€šçŸ¥æ¥å£é€‚é…è¯´æ˜

## ğŸ“‹ é€‚é…æ¦‚è¿°

å·²å°†æ¶ˆæ¯é€šçŸ¥å·¥å…·ç±»çš„æ‰€æœ‰æ¥å£è·¯å¾„ä»é€šç”¨è·¯å¾„ `/notification/` é€‚é…ä¸ºç”¨æˆ·ç«¯ä¸“ç”¨è·¯å¾„ `/user/notifications/`ã€‚

## ğŸ”„ æ¥å£è·¯å¾„å˜æ›´å¯¹ç…§è¡¨

| åŠŸèƒ½ | åŸè·¯å¾„ | æ–°è·¯å¾„ | æ–¹æ³• | è¯´æ˜ |
|------|--------|--------|------|------|
| æ¶ˆæ¯ç»Ÿè®¡ | `/notification/stat` | `/user/notifications/stat` | GET | è·å–æœªè¯»æ•°ç­‰ç»Ÿè®¡ä¿¡æ¯ |
| æ¶ˆæ¯åˆ—è¡¨ | `/notification/list` | `/user/notifications/list` | GET | åˆ†é¡µè·å–æ¶ˆæ¯åˆ—è¡¨ |
| æ¶ˆæ¯è¯¦æƒ… | `/notification/{id}` | `/user/notifications/{id}` | GET | è·å–è¯¦æƒ…å¹¶è‡ªåŠ¨æ ‡è®°å·²è¯» |
| æ ‡è®°å·²è¯» | `/notification/{id}/read` | `/user/notifications/{id}/read` | PUT | å•æ¡æ ‡è®°å·²è¯» |
| æ‰¹é‡å·²è¯» | `/notification/batch-read` | `/user/notifications/batch-read` | PUT | æ‰¹é‡æ ‡è®°å·²è¯» |
| å…¨éƒ¨å·²è¯» | `/notification/read-all` | `/user/notifications/read-all` | PUT | å…¨éƒ¨æ ‡è®°å·²è¯» |
| åˆ é™¤æ¶ˆæ¯ | `/notification/{id}` | `/user/notifications/{id}` | DELETE | åˆ é™¤å•æ¡æ¶ˆæ¯ |
| ä¿å­˜è®¢é˜… | `/notification/subscribe` | `/user/notifications/subscribe` | POST | ä¿å­˜å¾®ä¿¡è®¢é˜…æˆæƒ |

## ğŸ¯ å…³é”®å˜æ›´

### 1. æ¶ˆæ¯è¯¦æƒ…æ¥å£ä¼˜åŒ–
```javascript
// åŸå®ç°ï¼šéœ€è¦å…ˆè°ƒç”¨è¯¦æƒ…æ¥å£ï¼Œå†å•ç‹¬æ ‡è®°å·²è¯»
static async getMessageDetail(messageId) {
  // è·å–è¯¦æƒ…
  const res = await request({ url: `/notification/${messageId}` })
  return res.data
}

// æ–°å®ç°ï¼šè·å–è¯¦æƒ…æ—¶åç«¯è‡ªåŠ¨æ ‡è®°å·²è¯»
static async getMessageDetail(messageId) {
  const res = await request({ url: `/user/notifications/${messageId}` })
  
  if (res.code === 200) {
    // åç«¯å·²è‡ªåŠ¨æ ‡è®°å·²è¯»ï¼Œæ›´æ–°å¾½æ ‡
    this.updateTabBarBadge()
    return res.data
  }
  return null
}
```

### 2. æ¶ˆæ¯ç‚¹å‡»å¤„ç†ä¼˜åŒ–
```javascript
// åŸå®ç°ï¼šç‚¹å‡»åå•ç‹¬è°ƒç”¨æ ‡è®°å·²è¯»æ¥å£
static async handleMessageClick(message) {
  if (message.status === 'UNREAD') {
    await this.markAsRead(message.id)  // âŒ å•ç‹¬è°ƒç”¨
  }
  // è·³è½¬...
}

// æ–°å®ç°ï¼šåˆ©ç”¨è·å–è¯¦æƒ…æ¥å£çš„è‡ªåŠ¨æ ‡è®°åŠŸèƒ½
static async handleMessageClick(message) {
  if (message.status === 'UNREAD') {
    await this.getMessageDetail(message.id)  // âœ… è·å–è¯¦æƒ…æ—¶è‡ªåŠ¨æ ‡è®°
  }
  // è·³è½¬...
}
```

### 3. è®¢é˜…æˆæƒæ¥å£ç®€åŒ–
```javascript
// åç«¯æ¥å£è¯´æ˜ï¼šä¸éœ€è¦å•ç‹¬ä¼  userIdï¼Œä» token ä¸­è‡ªåŠ¨è·å–
POST /user/notifications/subscribe

è¯·æ±‚ä½“ï¼š
{
  "templateId": "æ¨¡æ¿ID",
  "templateCode": "æ¨¡æ¿ç¼–ç "
}

// åç«¯ä¼šè‡ªåŠ¨ä» JWT token ä¸­æå– userId
// å‰ç«¯æ— éœ€æ‰‹åŠ¨ä¼ é€’ userId
```

## ğŸ“ å®Œæ•´çš„æ¥å£è§„èŒƒ

### 1. GET /user/notifications/stat
**åŠŸèƒ½**: è·å–æ¶ˆæ¯ç»Ÿè®¡

**è¯·æ±‚**: æ— å‚æ•°

**å“åº”**:
```json
{
  "code": 200,
  "data": {
    "unreadCount": 5,
    "orderUnreadCount": 2,
    "serviceUnreadCount": 1,
    "paymentUnreadCount": 1,
    "systemUnreadCount": 1
  }
}
```

### 2. GET /user/notifications/list
**åŠŸèƒ½**: åˆ†é¡µè·å–æ¶ˆæ¯åˆ—è¡¨

**è¯·æ±‚å‚æ•°**:
- `type`: æ¶ˆæ¯ç±»å‹ï¼ˆå¯é€‰ï¼‰
- `status`: æ¶ˆæ¯çŠ¶æ€ï¼ˆå¯é€‰ï¼‰
- `page`: é¡µç 
- `size`: æ¯é¡µå¤§å°

**å“åº”**:
```json
{
  "code": 200,
  "data": {
    "records": [
      {
        "id": 1,
        "type": "ORDER",
        "title": "è®¢å•å·²æ¥å•",
        "content": "æ‚¨çš„è®¢å•å·²è¢«é˜¿å§¨æ¥å•",
        "status": "UNREAD",
        "jumpUrl": "/pages/order/detail",
        "jumpParams": { "orderId": 123 },
        "createdTime": "2024-01-01T10:00:00"
      }
    ],
    "total": 10,
    "current": 1,
    "pages": 1
  }
}
```

### 3. GET /user/notifications/{id}
**åŠŸèƒ½**: è·å–æ¶ˆæ¯è¯¦æƒ…ï¼ˆè‡ªåŠ¨æ ‡è®°å·²è¯»ï¼‰

**è¯·æ±‚**: è·¯å¾„å‚æ•° `id`

**å“åº”**:
```json
{
  "code": 200,
  "data": {
    "id": 1,
    "type": "ORDER",
    "title": "è®¢å•å·²æ¥å•",
    "content": "æ‚¨çš„è®¢å•å·²è¢«é˜¿å§¨æ¥å•",
    "status": "READ",
    "jumpUrl": "/pages/order/detail",
    "jumpParams": { "orderId": 123 },
    "createdTime": "2024-01-01T10:00:00",
    "readTime": "2024-01-01T10:05:00"
  }
}
```

### 4. PUT /user/notifications/{id}/read
**åŠŸèƒ½**: å•æ¡æ ‡è®°å·²è¯»

**è¯·æ±‚**: è·¯å¾„å‚æ•° `id`

**å“åº”**:
```json
{
  "code": 200,
  "message": "æ“ä½œæˆåŠŸ"
}
```

### 5. PUT /user/notifications/batch-read
**åŠŸèƒ½**: æ‰¹é‡æ ‡è®°å·²è¯»

**è¯·æ±‚ä½“**: æ¶ˆæ¯IDæ•°ç»„
```json
[1, 2, 3, 4, 5]
```

**å“åº”**:
```json
{
  "code": 200,
  "message": "æ“ä½œæˆåŠŸ"
}
```

### 6. PUT /user/notifications/read-all
**åŠŸèƒ½**: å…¨éƒ¨æ ‡è®°å·²è¯»

**è¯·æ±‚ä½“**:
```json
{
  "type": "ORDER"  // å¯é€‰ï¼ŒæŒ‡å®šç±»å‹
}
```

**å“åº”**:
```json
{
  "code": 200,
  "message": "æ“ä½œæˆåŠŸ"
}
```

### 7. DELETE /user/notifications/{id}
**åŠŸèƒ½**: åˆ é™¤å•æ¡æ¶ˆæ¯

**è¯·æ±‚**: è·¯å¾„å‚æ•° `id`

**å“åº”**:
```json
{
  "code": 200,
  "message": "æ“ä½œæˆåŠŸ"
}
```

### 8. POST /user/notifications/subscribe
**åŠŸèƒ½**: ä¿å­˜å¾®ä¿¡è®¢é˜…æˆæƒ

**è¯·æ±‚ä½“**:
```json
{
  "templateId": "æ¨¡æ¿ID",
  "templateCode": "ORDER_ACCEPTED"
}
```

**å“åº”**:
```json
{
  "code": 200,
  "message": "æ“ä½œæˆåŠŸ"
}
```

**è¯´æ˜**: 
- âœ… ä¸éœ€è¦ä¼ é€’ `userId`ï¼Œåç«¯ä» JWT token è‡ªåŠ¨è·å–
- âœ… æ”¯æŒæ‰¹é‡ä¿å­˜ï¼Œå‰ç«¯å¾ªç¯è°ƒç”¨å³å¯

## ğŸ”§ ä½¿ç”¨ç¤ºä¾‹

### è·å–æ¶ˆæ¯ç»Ÿè®¡å¹¶æ›´æ–°å¾½æ ‡
```javascript
import NotificationUtil from '@/utils/notificationUtil.js'

// è·å–æœªè¯»æ•°é‡
const stat = await NotificationUtil.getStat()
console.log('æœªè¯»æ¶ˆæ¯:', stat.unreadCount)

// è‡ªåŠ¨æ›´æ–° TabBar å¾½æ ‡
await NotificationUtil.updateTabBarBadge(2)  // ç´¢å¼•2æ˜¯"æˆ‘çš„"
```

### è·å–æ¶ˆæ¯åˆ—è¡¨
```javascript
// è·å–å…¨éƒ¨æ¶ˆæ¯
const result = await NotificationUtil.getMessageList({
  page: 1,
  size: 20
})

// è·å–è®¢å•ç±»æ¶ˆæ¯
const orderMessages = await NotificationUtil.getMessageList({
  type: 'ORDER',
  page: 1,
  size: 20
})

// è·å–æœªè¯»æ¶ˆæ¯
const unreadMessages = await NotificationUtil.getMessageList({
  status: 'UNREAD',
  page: 1,
  size: 20
})
```

### ç‚¹å‡»æ¶ˆæ¯å¤„ç†
```javascript
// ç‚¹å‡»æ¶ˆæ¯æ—¶è‡ªåŠ¨æ ‡è®°å·²è¯»å¹¶è·³è½¬
await NotificationUtil.handleMessageClick(message)

// å†…éƒ¨æµç¨‹ï¼š
// 1. å¦‚æœæ˜¯æœªè¯»æ¶ˆæ¯ï¼Œè°ƒç”¨ getMessageDetail (è‡ªåŠ¨æ ‡è®°å·²è¯»)
// 2. æ›´æ–°å¾½æ ‡
// 3. æ ¹æ® jumpUrl è·³è½¬é¡µé¢
```

### æ ‡è®°æ¶ˆæ¯å·²è¯»
```javascript
// å•æ¡æ ‡è®°
await NotificationUtil.markAsRead(messageId)

// æ‰¹é‡æ ‡è®°
await NotificationUtil.batchMarkAsRead([1, 2, 3, 4, 5])

// å…¨éƒ¨æ ‡è®°
await NotificationUtil.markAllAsRead()

// æ ‡è®°æŸç±»å‹å…¨éƒ¨å·²è¯»
await NotificationUtil.markAllAsRead('ORDER')
```

### è®¢é˜…æ¶ˆæ¯æˆæƒ
```javascript
// è¯·æ±‚è®¢é˜…æˆæƒï¼ˆä¼šè‡ªåŠ¨ä¿å­˜åˆ°åç«¯ï¼‰
const result = await NotificationUtil.requestSubscribe([
  'ORDER_ACCEPTED',
  'SERVICE_STARTING',
  'ORDER_COMPLETED'
])

if (result.success) {
  console.log('è®¢é˜…æˆåŠŸ')
} else {
  console.log('è®¢é˜…å¤±è´¥:', result.error)
}
```

## âœ… é€‚é…å®Œæˆæ¸…å•

- âœ… æ¶ˆæ¯ç»Ÿè®¡æ¥å£ - `/user/notifications/stat`
- âœ… æ¶ˆæ¯åˆ—è¡¨æ¥å£ - `/user/notifications/list`
- âœ… æ¶ˆæ¯è¯¦æƒ…æ¥å£ - `/user/notifications/{id}`ï¼ˆè‡ªåŠ¨æ ‡è®°å·²è¯»ï¼‰
- âœ… å•æ¡æ ‡è®°å·²è¯» - `/user/notifications/{id}/read`
- âœ… æ‰¹é‡æ ‡è®°å·²è¯» - `/user/notifications/batch-read`
- âœ… å…¨éƒ¨æ ‡è®°å·²è¯» - `/user/notifications/read-all`
- âœ… åˆ é™¤æ¶ˆæ¯æ¥å£ - `/user/notifications/{id}`
- âœ… è®¢é˜…æˆæƒæ¥å£ - `/user/notifications/subscribe`ï¼ˆæ— éœ€ä¼  userIdï¼‰
- âœ… æ¶ˆæ¯ç‚¹å‡»å¤„ç†ä¼˜åŒ–ï¼ˆåˆ©ç”¨è¯¦æƒ…æ¥å£çš„è‡ªåŠ¨æ ‡è®°åŠŸèƒ½ï¼‰
- âœ… å¾½æ ‡è‡ªåŠ¨æ›´æ–°æœºåˆ¶

## ğŸ¯ æ³¨æ„äº‹é¡¹

1. **Token è®¤è¯**: æ‰€æœ‰æ¥å£éƒ½éœ€è¦åœ¨ header ä¸­æºå¸¦ JWT token
2. **è‡ªåŠ¨æ ‡è®°**: è·å–æ¶ˆæ¯è¯¦æƒ…æ¥å£ä¼šè‡ªåŠ¨æ ‡è®°è¯¥æ¶ˆæ¯ä¸ºå·²è¯»
3. **å¾½æ ‡æ›´æ–°**: æ‰€æœ‰ä¿®æ”¹æ¶ˆæ¯çŠ¶æ€çš„æ“ä½œéƒ½ä¼šè‡ªåŠ¨æ›´æ–° TabBar å¾½æ ‡
4. **userId è‡ªåŠ¨è·å–**: åç«¯ä» token ä¸­æå– userIdï¼Œå‰ç«¯æ— éœ€ä¼ é€’

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·è”ç³»å¼€å‘å›¢é˜Ÿã€‚

