# 小程序消息通知系统 - 文档索引

## 📚 文档列表

### 1. [小程序消息通知系统设计方案](./小程序消息通知系统设计方案.md)
**完整的设计文档**，包含：
- ✅ 方案概述与设计原则
- ✅ 消息分类设计（8种消息类型）
- ✅ 数据库设计（4张表，完整字段说明）
- ✅ 后端实现（实体类、枚举、DTO、Service、Controller）
- ✅ 微信订阅消息集成
- ✅ 线程池与配置
- ✅ 前端对接指南
- ✅ 部署运维方案

### 2. [小程序消息通知系统-快速使用指南](./小程序消息通知系统-快速使用指南.md)
**快速上手指南**，包含：
- ✅ 快速开始（数据库、配置、微信模板）
- ✅ 常用场景示例代码
  - 订单接单通知
  - 新订单通知
  - 支付成功通知
  - 服务提醒通知
- ✅ 小程序前端集成示例
- ✅ 测试验证方法
- ✅ 常见问题解答
- ✅ 性能优化建议
- ✅ 监控告警方案

### 3. [数据库升级脚本](./jiayou-admin-service/src/main/resources/sql/8.notification_system_enhancement.sql)
**SQL脚本**，包含：
- ✅ 备份现有数据
- ✅ 扩展notification表（15个新字段）
- ✅ 新建3张表（微信模板、订阅记录、用户设置）
- ✅ 插入初始数据（模板配置、系统配置）
- ✅ 数据迁移脚本
- ✅ 验证脚本

---

## 🎯 方案特点

### 核心功能
1. **多渠道推送**
   - 站内消息（小程序内消息中心）
   - 微信订阅消息（小程序外通知）
   - 短信通知（重要消息）

2. **智能分级**
   - HIGH：三渠道全推送（订单、服务类）
   - MEDIUM：站内+微信（支付、结算类）
   - LOW：仅站内消息（系统、活动类）

3. **用户可控**
   - 支持用户自定义通知偏好
   - 每种消息类型可独立开关
   - 支持订阅消息授权管理

4. **高性能**
   - 异步推送，不阻塞主业务
   - 线程池并发处理
   - Redis缓存优化
   - 支持Kafka批量推送

### 技术亮点
- ✨ 状态完整追踪（推送状态、失败记录）
- ✨ JSON扩展字段（灵活存储业务数据）
- ✨ 逻辑删除（数据可恢复）
- ✨ 定时清理（自动清理过期数据）
- ✨ 跳转参数（消息可跳转到详情页）

---

## 📊 消息类型一览

| 类型 | 说明 | 用户端场景 | 阿姨端场景 | 优先级 |
|-----|------|-----------|-----------|--------|
| ORDER | 订单通知 | 阿姨接单、订单取消 | 新订单、派单 | HIGH |
| SERVICE | 服务提醒 | 服务开始、服务完成 | 服务提醒 | HIGH |
| PAYMENT | 支付通知 | 支付成功、退款到账 | - | MEDIUM |
| SETTLEMENT | 结算通知 | - | 收益结算、提现到账 | MEDIUM |
| AUDIT | 审核通知 | - | 认证审核结果 | MEDIUM |
| SYSTEM | 系统通知 | 平台公告 | 平台公告 | LOW |
| ACTIVITY | 活动通知 | 优惠券、积分 | 优惠券、积分 | LOW |
| REFERRAL | 推荐通知 | 推荐成功 | 推荐成功 | LOW |

---

## 🚀 快速开始

### 第一步：执行数据库脚本
```bash
mysql -u root -p your_database < jiayou-admin-service/src/main/resources/sql/8.notification_system_enhancement.sql
```

### 第二步：配置微信小程序
```yaml
wechat:
  miniapp:
    appid: your_appid
    secret: your_secret
```

### 第三步：获取微信订阅消息模板
1. 登录微信公众平台
2. 选择订阅消息模板
3. 更新数据库中的template_id

### 第四步：集成到业务代码
```java
@Autowired
private NotificationService notificationService;

// 发送订单通知
notificationService.sendOrderNotification(
    userId, staffId, orderId, 
    title, content, 
    templateCode, templateData
);
```

### 第五步：小程序前端集成
```javascript
// 请求订阅授权
uni.requestSubscribeMessage({
  tmplIds: ['模板ID1', '模板ID2'],
  success: (res) => {
    // 保存授权结果
  }
});
```

---

## 📋 数据库表结构

### 1. notification（消息通知表）
**主要字段**：
- user_id, staff_id, company_id - 接收者
- title, content - 消息内容
- type, priority, status - 消息属性
- related_type, related_id - 关联业务
- push_in_app, push_wechat, push_sms - 推送渠道
- wechat_push_status, sms_push_status - 推送状态
- jump_url, jump_params - 跳转信息

### 2. wechat_subscribe_template（微信订阅消息模板）
**主要字段**：
- template_id - 微信模板ID
- template_code - 业务模板编码
- scene_type - 场景类型（USER/STAFF）
- params_mapping - 参数映射配置

### 3. subscribe_record（用户订阅授权记录）
**主要字段**：
- user_id, staff_id - 用户标识
- template_code - 模板编码
- subscribe_status - 订阅状态
- used_count, max_count - 使用次数

### 4. notification_setting（用户消息设置）
**主要字段**：
- user_id, staff_id - 用户标识
- notification_type - 消息类型
- in_app_enabled, wechat_enabled, sms_enabled - 开关

---

## 🔧 API接口列表

| 接口 | 方法 | 说明 |
|-----|------|------|
| `/notification/list` | GET | 获取消息列表（支持分页、筛选） |
| `/notification/stat` | GET | 获取消息统计（未读数） |
| `/notification/{id}` | GET | 获取消息详情 |
| `/notification/{id}/read` | PUT | 标记为已读 |
| `/notification/batch-read` | PUT | 批量标记为已读 |
| `/notification/read-all` | PUT | 全部标记为已读 |
| `/notification/{id}` | DELETE | 删除消息 |
| `/notification/subscribe` | POST | 保存订阅授权 |

---

## 📈 性能优化

### 1. Redis缓存未读数
```java
// 缓存未读数，避免频繁查询数据库
redisTemplate.opsForValue().set("notification:unread:" + userId, count, 1, TimeUnit.HOURS);
```

### 2. 异步推送
```java
// 使用@Async异步推送，不阻塞主业务
@Async("notificationExecutor")
public void asyncSendWechatMessage(...) { }
```

### 3. 批量推送（Kafka）
```java
// 批量推送场景使用消息队列
kafkaTemplate.send("notification-topic", message);
```

### 4. 定时清理
```java
// 定时清理30天前的已读消息
@Scheduled(cron = "0 0 2 * * ?")
public void cleanExpiredNotifications() { }
```

---

## 🔍 监控指标

建议监控以下关键指标：
- 📊 消息发送总数
- ✅ 消息发送成功率
- ❌ 消息发送失败率
- ⏱️ 消息推送耗时
- 📱 微信订阅消息成功率
- 📧 短信发送成功率
- 📮 消息未读数量
- 💾 消息存储量

---

## ❓ 常见问题

### Q1: 微信订阅消息发送失败怎么办？
**A:** 检查以下几点：
1. 模板ID是否正确
2. 用户是否已授权
3. access_token是否有效
4. 参数格式是否匹配模板

### Q2: 消息未读数不准确？
**A:** 
1. 检查逻辑删除是否生效
2. 清除Redis缓存重新统计
3. 检查状态更新逻辑

### Q3: 如何提高推送性能？
**A:**
1. 使用Redis缓存
2. 增加线程池大小
3. 使用消息队列批量推送
4. 优化数据库索引

### Q4: 如何实现消息撤回？
**A:** 
1. 站内消息：逻辑删除即可
2. 微信订阅消息：无法撤回（已发出）
3. 短信：无法撤回（已发出）

---

## 📞 技术支持

如有问题，请参考：
1. 📖 设计方案文档 - 了解系统设计
2. 🚀 快速使用指南 - 查看代码示例
3. 💾 数据库脚本 - 查看表结构
4. 🔗 微信官方文档 - 订阅消息API

---

## 📝 更新日志

### v1.0.0 (2024-10-15)
- ✨ 初始版本
- ✅ 支持多渠道推送（站内、微信、短信）
- ✅ 支持消息分级推送
- ✅ 支持用户自定义设置
- ✅ 支持微信订阅消息
- ✅ 支持异步推送
- ✅ 支持消息跳转
- ✅ 支持定时清理

---

## 🎉 开始使用

现在您可以：
1. 📖 阅读[完整设计方案](./小程序消息通知系统设计方案.md)了解系统架构
2. 🚀 参考[快速使用指南](./小程序消息通知系统-快速使用指南.md)开始集成
3. 💾 执行[数据库脚本](./jiayou-admin-service/src/main/resources/sql/8.notification_system_enhancement.sql)初始化数据库

祝您使用愉快！🎊

