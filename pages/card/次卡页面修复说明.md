# 我的次卡页面 - 加载问题修复说明

## 🐛 问题描述

**现象：** 我的次卡页面一直显示"加载中..."，无法正常显示内容

**后端日志显示：** 请求成功，返回空数据列表，但前端一直处于加载状态

## 🔍 问题原因

### 1. 数据格式不匹配

**后端返回的数据格式（分页格式）：**
```json
{
  "code": 200,
  "message": "操作成功",
  "data": {
    "records": [],        // ← 真正的数据在这里
    "total": 0,
    "current": 1,
    "size": 10,
    "pages": 0
  }
}
```

**前端原代码（错误）：**
```javascript
if (res.code === 200) {
  allCards.value = res.data || [];  // ❌ res.data 是分页对象，不是数组
}
```

**正确做法：**
```javascript
if (res.code === 200) {
  const cards = res.data.records || [];  // ✅ 从 records 字段获取数组
}
```

### 2. 字段名不匹配

**后端返回的字段：**
- `cardNo` - 卡号
- `cardName` - 卡片名称
- `totalTimes` - 总次数
- `remainingTimes` - 剩余次数
- `expireTime` - 过期时间

**前端期望的字段：**
- `cardNumber` - 卡号
- `productName` / `name` - 卡片名称
- `totalTimes` - 总次数
- `remainingTimes` - 剩余次数
- `expirationDate` - 过期时间

需要进行字段映射转换。

## ✅ 修复方案

### 修复内容

1. **正确处理分页数据**
```javascript
// 从 res.data.records 获取数组
const cards = res.data.records || res.data || [];
```

2. **添加字段映射**
```javascript
allCards.value = cards.map(card => ({
  id: card.id,
  cardNumber: card.cardNo || card.id,
  productName: card.cardName,
  name: card.cardName,
  totalTimes: card.totalTimes,
  usedTimes: card.usedTimes,
  remainingTimes: card.remainingTimes,
  expirationDate: card.expireTime,  // 映射到前端字段名
  status: card.status,
  // ... 其他字段
}));
```

3. **优化空状态显示**
```vue
<view v-else-if="!loading && currentCards.length === 0" class="empty">
  <image src="/static/images/empty.png" mode="aspectFit" class="empty-image"></image>
  <text class="empty-text">
    {{ activeTab === 'active' ? '暂无有效次卡' : activeTab === 'expired' ? '暂无过期次卡' : '暂无已用完次卡' }}
  </text>
</view>
```

4. **添加分页参数**
```javascript
const res = await request({
  url: '/user/service-cards/my-cards',
  method: 'GET',
  data: {
    page: 1,
    size: 100  // 获取所有次卡
  }
});
```

## 📝 修改的文件

- ✅ `pages/card/my-cards.vue`（第231-283行）

## 🧪 测试建议

### 测试步骤

1. **测试空数据情况**
   ```
   1. 清空用户的次卡数据
   2. 进入"我的次卡"页面
   3. 应该显示"暂无有效次卡"的空状态，而不是一直加载
   ```

2. **测试有数据情况**
   ```
   1. 给用户添加几张次卡（有效、过期、已用完各一张）
   2. 进入"我的次卡"页面
   3. 应该能正确显示次卡列表
   4. 切换标签页，检查分类是否正确
   ```

3. **测试字段映射**
   ```
   1. 检查卡片显示是否正确
   2. 检查卡号、名称、剩余次数、有效期等字段
   3. 检查进度条是否正常
   ```

### 预期结果

✅ 页面正常加载，不再一直显示"加载中..."  
✅ 空数据时显示友好的空状态提示  
✅ 有数据时正确显示次卡列表  
✅ 字段映射正确，信息显示完整  
✅ 三个标签页分类正确（有效、已过期、已用完）

## 📊 后端字段映射表

| 后端字段 | 前端字段 | 说明 |
|---------|---------|------|
| `cardNo` | `cardNumber` | 卡号 |
| `cardName` | `productName` / `name` | 卡片名称 |
| `totalTimes` | `totalTimes` | 总次数 |
| `usedTimes` | `usedTimes` | 已用次数 |
| `remainingTimes` | `remainingTimes` | 剩余次数 |
| `expireTime` | `expirationDate` | 过期时间 |
| `status` | `status` | 状态 |
| `cardType` | `cardType` | 卡片类型 |
| `purchaseAmount` | `purchaseAmount` | 购买金额 |
| `singleServiceValue` | `singleServiceValue` | 单次服务价值 |

## 🔄 相关接口

**接口：** `GET /user/service-cards/my-cards`

**请求参数：**
```json
{
  "status": "ACTIVE",  // 可选，次卡状态
  "page": 1,
  "size": 10
}
```

**响应格式：**
```json
{
  "code": 200,
  "message": "操作成功",
  "data": {
    "records": [
      {
        "id": 1,
        "cardNo": "CARD20241015001",
        "cardName": "家政服务次卡",
        "totalTimes": 10,
        "usedTimes": 3,
        "remainingTimes": 7,
        "expireTime": "2024-12-31 23:59:59",
        "status": "ACTIVE"
      }
    ],
    "total": 1,
    "current": 1,
    "size": 10,
    "pages": 1
  }
}
```

## ⚠️ 注意事项

1. **空数据处理**
   - 确保空数组时不显示加载状态
   - 显示友好的空状态提示

2. **字段映射**
   - 确保所有必要字段都正确映射
   - 处理可能的 null/undefined 值

3. **分页数据**
   - 后端返回分页格式，需要取 `records` 字段
   - 可以一次性获取所有数据（size: 100）

4. **加载状态**
   - 确保 `finally` 块中设置 `loading.value = false`
   - 无论成功或失败都要取消加载状态

## 🎯 总结

问题的根本原因是**数据格式不匹配**：
- 后端返回分页对象，前端直接使用导致数据为空
- 字段名不一致，需要进行映射

修复后，页面可以正常显示次卡列表，包括空状态的友好提示。

---

**修复时间：** 2024-10-15  
**修复人员：** AI Assistant  
**测试状态：** ✅ 待测试

