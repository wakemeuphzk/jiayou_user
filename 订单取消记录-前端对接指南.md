# 订单取消记录 - 前端对接指南

## 📋 概述

订单取消记录功能用于查看订单取消的详细信息，包括违约金、退款金额、责任方判定等。本文档将帮助前端开发者快速集成该功能。

---

## 🎯 核心接口

### 用户端接口

#### 1. 获取订单取消记录
```javascript
/**
 * 获取指定订单的取消详情
 * @param {number} orderId - 订单ID
 * @returns {Promise} 取消记录详情
 */
async function getOrderCancellation(orderId) {
  const response = await wx.request({
    url: `${API_BASE_URL}/user/order/${orderId}/cancellation`,
    method: 'GET',
    header: {
      'Authorization': `Bearer ${getToken()}`
    }
  });
  return response.data;
}
```

**响应示例**:
```json
{
  "code": 200,
  "message": "获取成功",
  "data": {
    "id": 1,
    "orderId": 21,
    "orderNo": "JY17603580614740855",
    "cancelBy": "USER",
    "cancelByDesc": "用户",
    "cancelReason": "USER_NO_NEED",
    "cancelDesc": "用户主动取消",
    "cancelTime": "2025-10-13T20:21:24",
    "serviceTime": "2025-10-17T00:00:00",
    "timeDiffHours": 75.63,
    "refundRequired": true,
    "orderAmount": 250.00,
    "refundAmount": 250.00,
    "penaltyAmount": 0.00,
    "penaltyRate": 0.00,
    "refundStatus": "PENDING",
    "refundStatusDesc": "待退款",
    "refundNo": null,
    "responsibleParty": "USER",
    "responsiblePartyDesc": "用户",
    "creditScoreDeduction": 0,
    "createdTime": "2025-10-13T20:21:24"
  }
}
```

#### 2. 获取我的取消记录列表
```javascript
/**
 * 获取用户的所有取消记录（分页）
 * @param {number} page - 页码
 * @param {number} size - 每页大小
 * @returns {Promise} 取消记录列表
 */
async function getMyCancellations(page = 1, size = 10) {
  const response = await wx.request({
    url: `${API_BASE_URL}/user/order/cancellations`,
    method: 'GET',
    data: { page, size },
    header: {
      'Authorization': `Bearer ${getToken()}`
    }
  });
  return response.data;
}
```

**响应示例**:
```json
{
  "code": 200,
  "message": "获取成功",
  "data": {
    "records": [
      {
        "id": 1,
        "orderId": 21,
        "orderNo": "JY17603580614740855",
        "cancelBy": "USER",
        "cancelByDesc": "用户",
        "cancelReason": "USER_NO_NEED",
        "cancelDesc": "用户主动取消",
        "cancelTime": "2025-10-13T20:21:24",
        "serviceTime": "2025-10-17T00:00:00",
        "timeDiffHours": 75.63,
        "refundRequired": true,
        "orderAmount": 250.00,
        "refundAmount": 250.00,
        "penaltyAmount": 0.00,
        "penaltyRate": 0.00,
        "refundStatus": "PENDING",
        "refundStatusDesc": "待退款",
        "responsibleParty": "USER",
        "responsiblePartyDesc": "用户",
        "creditScoreDeduction": 0,
        "createdTime": "2025-10-13T20:21:24"
      }
    ],
    "total": 10,
    "page": 1,
    "size": 10,
    "pages": 1
  }
}
```

### 阿姨端接口

阿姨端接口路径相同，只需将 `/user/order/` 替换为 `/staff/order/`：
- `GET /staff/order/{orderId}/cancellation` - 获取订单取消记录
- `GET /staff/order/cancellations` - 获取我的取消记录列表

---

## 🎨 页面设计建议

### 1. 订单详情页 - 取消信息卡片

**场景**: 在已取消订单的详情页显示取消信息

```html
<!-- WXML 示例 -->
<view wx:if="{{order.status === 'CANCELLED'}}" class="cancel-info-card">
  <view class="card-header">
    <text class="title">取消信息</text>
  </view>
  
  <view class="info-row">
    <text class="label">取消时间</text>
    <text class="value">{{cancellation.cancelTime}}</text>
  </view>
  
  <view class="info-row">
    <text class="label">取消原因</text>
    <text class="value">{{cancellation.cancelDesc}}</text>
  </view>
  
  <view class="info-row">
    <text class="label">退款金额</text>
    <text class="value highlight">¥{{cancellation.refundAmount}}</text>
  </view>
  
  <view wx:if="{{cancellation.penaltyAmount > 0}}" class="info-row warning">
    <text class="label">违约金</text>
    <text class="value">¥{{cancellation.penaltyAmount}}</text>
  </view>
  
  <view class="info-row">
    <text class="label">退款状态</text>
    <text class="value status-{{cancellation.refundStatus}}">
      {{cancellation.refundStatusDesc}}
    </text>
  </view>
  
  <view wx:if="{{cancellation.creditScoreDeduction > 0}}" class="info-row warning">
    <text class="label">信用分扣除</text>
    <text class="value">-{{cancellation.creditScoreDeduction}}分</text>
  </view>
</view>
```

**样式建议**:
```css
/* WXSS 示例 */
.cancel-info-card {
  background: #fff;
  border-radius: 12rpx;
  padding: 30rpx;
  margin: 20rpx 0;
}

.card-header {
  border-left: 6rpx solid #ff6b6b;
  padding-left: 20rpx;
  margin-bottom: 30rpx;
}

.info-row {
  display: flex;
  justify-content: space-between;
  padding: 20rpx 0;
  border-bottom: 1px solid #f0f0f0;
}

.info-row.warning {
  color: #ff6b6b;
}

.value.highlight {
  color: #ff6b6b;
  font-weight: bold;
  font-size: 32rpx;
}

.status-PENDING {
  color: #faad14;
}

.status-SUCCESS {
  color: #52c41a;
}

.status-FAILED {
  color: #ff4d4f;
}
```

### 2. 取消记录列表页

**场景**: 独立的取消记录查看页面（我的订单 > 取消记录）

```javascript
// Page JS
Page({
  data: {
    cancellations: [],
    page: 1,
    size: 10,
    total: 0,
    loading: false,
    hasMore: true
  },

  onLoad() {
    this.loadCancellations();
  },

  async loadCancellations() {
    if (this.data.loading || !this.data.hasMore) return;

    this.setData({ loading: true });

    try {
      const res = await getMyCancellations(this.data.page, this.data.size);
      
      if (res.code === 200) {
        const newData = res.data.records;
        this.setData({
          cancellations: [...this.data.cancellations, ...newData],
          total: res.data.total,
          page: this.data.page + 1,
          hasMore: this.data.cancellations.length + newData.length < res.data.total
        });
      }
    } catch (error) {
      wx.showToast({
        title: '加载失败',
        icon: 'none'
      });
    } finally {
      this.setData({ loading: false });
    }
  },

  onReachBottom() {
    this.loadCancellations();
  },

  // 跳转到订单详情
  viewOrderDetail(e) {
    const orderId = e.currentTarget.dataset.orderId;
    wx.navigateTo({
      url: `/pages/order/detail?id=${orderId}`
    });
  }
});
```

```html
<!-- WXML 列表示例 -->
<view class="cancellation-list">
  <view 
    wx:for="{{cancellations}}" 
    wx:key="id" 
    class="cancellation-item"
    bindtap="viewOrderDetail"
    data-order-id="{{item.orderId}}"
  >
    <view class="item-header">
      <text class="order-no">订单号: {{item.orderNo}}</text>
      <text class="cancel-time">{{item.cancelTime}}</text>
    </view>
    
    <view class="item-body">
      <view class="reason">
        <text class="label">取消原因:</text>
        <text class="value">{{item.cancelDesc}}</text>
      </view>
      
      <view class="amount-info">
        <view class="amount-row">
          <text class="label">订单金额</text>
          <text class="value">¥{{item.orderAmount}}</text>
        </view>
        <view class="amount-row">
          <text class="label">退款金额</text>
          <text class="value refund">¥{{item.refundAmount}}</text>
        </view>
        <view wx:if="{{item.penaltyAmount > 0}}" class="amount-row">
          <text class="label">违约金</text>
          <text class="value penalty">¥{{item.penaltyAmount}}</text>
        </view>
      </view>
    </view>
    
    <view class="item-footer">
      <text class="refund-status status-{{item.refundStatus}}">
        {{item.refundStatusDesc}}
      </text>
      <text class="arrow">›</text>
    </view>
  </view>

  <view wx:if="{{loading}}" class="loading">
    <text>加载中...</text>
  </view>

  <view wx:if="{{!hasMore && cancellations.length > 0}}" class="no-more">
    <text>没有更多了</text>
  </view>

  <view wx:if="{{cancellations.length === 0 && !loading}}" class="empty">
    <image src="/images/empty.png" class="empty-image"></image>
    <text class="empty-text">暂无取消记录</text>
  </view>
</view>
```

---

## 💡 业务逻辑处理

### 1. 取消状态显示逻辑

```javascript
/**
 * 获取退款状态的颜色和图标
 * @param {string} status - 退款状态
 */
function getRefundStatusStyle(status) {
  const statusMap = {
    'PENDING': {
      color: '#faad14',
      icon: 'clock',
      text: '待退款'
    },
    'PROCESSING': {
      color: '#1890ff',
      icon: 'loading',
      text: '退款中'
    },
    'SUCCESS': {
      color: '#52c41a',
      icon: 'success',
      text: '已退款'
    },
    'FAILED': {
      color: '#ff4d4f',
      icon: 'error',
      text: '退款失败'
    }
  };
  return statusMap[status] || statusMap['PENDING'];
}
```

### 2. 责任方显示

```javascript
/**
 * 获取责任方的标签样式
 * @param {string} party - 责任方
 */
function getResponsiblePartyBadge(party) {
  const partyMap = {
    'USER': {
      color: '#ff6b6b',
      text: '用户责任',
      tip: '由于您的原因取消，可能产生违约金'
    },
    'STAFF': {
      color: '#ffa940',
      text: '阿姨责任',
      tip: '阿姨取消订单，已全额退款'
    },
    'PLATFORM': {
      color: '#597ef7',
      text: '平台责任',
      tip: '平台取消订单，已全额退款并补偿'
    },
    'NONE': {
      color: '#8c8c8c',
      text: '无责任',
      tip: '双方协商取消，无违约金'
    }
  };
  return partyMap[party] || partyMap['NONE'];
}
```

### 3. 违约金提示

```javascript
/**
 * 显示违约金说明弹窗
 * @param {object} cancellation - 取消记录对象
 */
function showPenaltyExplanation(cancellation) {
  const messages = [];
  
  if (cancellation.penaltyAmount > 0) {
    messages.push(`因距离服务时间不足${Math.ceil(cancellation.timeDiffHours)}小时`);
    messages.push(`按订单金额的${cancellation.penaltyRate}%收取违约金`);
    messages.push(`违约金：¥${cancellation.penaltyAmount}`);
    messages.push(`实际退款：¥${cancellation.refundAmount}`);
  } else {
    messages.push('距离服务时间充足，无需支付违约金');
    messages.push(`全额退款：¥${cancellation.refundAmount}`);
  }
  
  if (cancellation.creditScoreDeduction > 0) {
    messages.push(`\n信用分扣除：${cancellation.creditScoreDeduction}分`);
  }
  
  wx.showModal({
    title: '取消说明',
    content: messages.join('\n'),
    showCancel: false,
    confirmText: '知道了'
  });
}
```

---

## 🔄 完整业务流程示例

### 场景：用户查看已取消订单详情

```javascript
// pages/order/detail.js
Page({
  data: {
    orderId: null,
    order: null,
    cancellation: null,
    showCancelInfo: false
  },

  async onLoad(options) {
    this.setData({ orderId: options.id });
    await this.loadOrderDetail();
    
    // 如果订单已取消，加载取消记录
    if (this.data.order.status === 'CANCELLED') {
      await this.loadCancellationInfo();
    }
  },

  async loadOrderDetail() {
    try {
      const res = await getOrderDetail(this.data.orderId);
      if (res.code === 200) {
        this.setData({ order: res.data });
      }
    } catch (error) {
      wx.showToast({
        title: '订单加载失败',
        icon: 'none'
      });
    }
  },

  async loadCancellationInfo() {
    try {
      const res = await getOrderCancellation(this.data.orderId);
      if (res.code === 200) {
        this.setData({ 
          cancellation: res.data,
          showCancelInfo: true
        });
      }
    } catch (error) {
      console.error('取消记录加载失败', error);
      // 静默处理，不影响订单详情显示
    }
  },

  // 查看违约金说明
  showPenaltyInfo() {
    showPenaltyExplanation(this.data.cancellation);
  },

  // 联系客服
  contactService() {
    wx.navigateTo({
      url: '/pages/service/contact'
    });
  }
});
```

---

## 📊 数据字段说明

| 字段名 | 类型 | 说明 | 示例值 |
|--------|------|------|--------|
| `cancelBy` | String | 取消发起方 | USER/STAFF/SYSTEM |
| `cancelByDesc` | String | 取消发起方描述 | "用户"/"阿姨"/"系统" |
| `cancelReason` | String | 取消原因类型 | USER_NO_NEED |
| `cancelDesc` | String | 取消原因描述 | "用户主动取消" |
| `timeDiffHours` | Number | 距离服务时间（小时） | 75.63 |
| `refundRequired` | Boolean | 是否需要退款 | true/false |
| `orderAmount` | Number | 订单金额 | 250.00 |
| `refundAmount` | Number | 退款金额 | 250.00 |
| `penaltyAmount` | Number | 违约金 | 0.00 |
| `penaltyRate` | Number | 违约金率(%) | 0.00 |
| `refundStatus` | String | 退款状态 | PENDING/PROCESSING/SUCCESS/FAILED |
| `refundStatusDesc` | String | 退款状态描述 | "待退款"/"退款中"/"已退款"/"退款失败" |
| `responsibleParty` | String | 责任方 | USER/STAFF/PLATFORM/NONE |
| `responsiblePartyDesc` | String | 责任方描述 | "用户"/"阿姨"/"平台"/"无" |
| `creditScoreDeduction` | Number | 信用分扣除 | 0 |

---

## ⚠️ 注意事项

### 1. 权限控制
- 必须携带有效的 JWT Token
- 只能查看自己的订单取消记录
- 后端会验证订单归属权限

### 2. 错误处理
```javascript
// 统一错误处理
async function handleCancellationRequest(requestFn) {
  try {
    const res = await requestFn();
    
    if (res.code === 200) {
      return res.data;
    } else {
      throw new Error(res.message || '请求失败');
    }
  } catch (error) {
    // 根据错误类型显示不同提示
    if (error.message.includes('无权')) {
      wx.showToast({
        title: '无权查看',
        icon: 'none'
      });
    } else if (error.message.includes('不存在')) {
      wx.showToast({
        title: '记录不存在',
        icon: 'none'
      });
    } else {
      wx.showToast({
        title: error.message || '加载失败',
        icon: 'none'
      });
    }
    throw error;
  }
}
```

### 3. 性能优化
```javascript
// 缓存取消记录，避免重复请求
const cancellationCache = new Map();

async function getCachedCancellation(orderId) {
  if (cancellationCache.has(orderId)) {
    return cancellationCache.get(orderId);
  }
  
  const data = await getOrderCancellation(orderId);
  cancellationCache.set(orderId, data);
  
  // 5分钟后清除缓存
  setTimeout(() => {
    cancellationCache.delete(orderId);
  }, 5 * 60 * 1000);
  
  return data;
}
```

### 4. 时间格式化
```javascript
/**
 * 格式化取消时间显示
 * @param {string} timeStr - ISO时间字符串
 */
function formatCancelTime(timeStr) {
  const date = new Date(timeStr);
  const now = new Date();
  const diff = now - date;
  
  // 1小时内
  if (diff < 3600000) {
    const minutes = Math.floor(diff / 60000);
    return `${minutes}分钟前`;
  }
  
  // 今天
  if (date.toDateString() === now.toDateString()) {
    return `今天 ${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;
  }
  
  // 昨天
  const yesterday = new Date(now);
  yesterday.setDate(yesterday.getDate() - 1);
  if (date.toDateString() === yesterday.toDateString()) {
    return `昨天 ${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;
  }
  
  // 其他
  return `${date.getMonth() + 1}月${date.getDate()}日`;
}
```

---

## 🎯 快速开始检查清单

- [ ] 配置API基础路径 `API_BASE_URL`
- [ ] 实现Token获取方法 `getToken()`
- [ ] 创建取消记录请求方法
- [ ] 在订单详情页集成取消信息展示
- [ ] （可选）创建独立的取消记录列表页
- [ ] 测试权限控制和错误处理
- [ ] 优化样式和交互体验

---

## 🚨 取消订单二次确认功能

### 业务流程

取消订单需要**二次确认**，向用户展示违约金、退款金额等重要信息：

```
用户点击取消 → 调用违约金计算接口 → 展示确认弹窗 → 用户确认 → 提交取消请求
```

### 实现步骤

#### 1. 违约金预览接口

```javascript
/**
 * 计算取消违约金（预览）
 * @param {number} orderId - 订单ID
 * @returns {Promise} 违约金计算结果
 */
async function calculateCancelPenalty(orderId) {
  const response = await wx.request({
    url: `${API_BASE_URL}/user/order/${orderId}/cancel-penalty`,
    method: 'GET',
    header: {
      'Authorization': `Bearer ${getToken()}`
    }
  });
  return response.data;
}
```

**响应示例**:
```json
{
  "code": 200,
  "message": "计算成功",
  "data": {
    "canCancel": true,
    "orderAmount": 250.00,
    "refundAmount": 250.00,
    "penaltyAmount": 0.00,
    "penaltyRate": 0.00,
    "pointsDeduction": 0,
    "timeDiffHours": 75.63,
    "cancelDeadline": "2025-10-17T00:00:00",
    "tips": [
      "距离服务时间超过48小时，无违约金",
      "将全额退款到原支付账户"
    ]
  }
}
```

#### 2. 取消订单接口

```javascript
/**
 * 提交取消订单请求
 * @param {number} orderId - 订单ID
 * @param {string} reason - 取消原因类型
 * @param {string} desc - 取消原因描述
 * @returns {Promise} 取消结果
 */
async function cancelOrder(orderId, reason, desc) {
  const response = await wx.request({
    url: `${API_BASE_URL}/user/order/cancel`,
    method: 'POST',
    data: {
      orderId: orderId,
      cancelReason: reason,
      cancelDesc: desc
    },
    header: {
      'Authorization': `Bearer ${getToken()}`
    }
  });
  return response.data;
}
```

#### 3. 完整的二次确认流程

```javascript
// pages/order/detail.js
Page({
  data: {
    orderId: null,
    order: null,
    cancelPenalty: null,
    showCancelModal: false,
    selectedReason: '',
    cancelDesc: ''
  },

  /**
   * 用户点击取消订单按钮
   */
  async onCancelOrder() {
    try {
      wx.showLoading({ title: '计算中...' });
      
      // 1. 调用违约金计算接口
      const res = await calculateCancelPenalty(this.data.orderId);
      
      wx.hideLoading();
      
      if (res.code === 200) {
        const penalty = res.data;
        
        // 2. 检查是否可以取消
        if (!penalty.canCancel) {
          wx.showModal({
            title: '无法取消',
            content: penalty.tips.join('\n'),
            showCancel: false
          });
          return;
        }
        
        // 3. 保存违约金信息并显示确认弹窗
        this.setData({ 
          cancelPenalty: penalty,
          showCancelModal: true 
        });
      } else {
        wx.showToast({
          title: res.message || '获取失败',
          icon: 'none'
        });
      }
    } catch (error) {
      wx.hideLoading();
      wx.showToast({
        title: '网络错误',
        icon: 'none'
      });
    }
  },

  /**
   * 选择取消原因
   */
  onSelectReason(e) {
    const reason = e.currentTarget.dataset.reason;
    this.setData({ selectedReason: reason });
  },

  /**
   * 输入取消说明
   */
  onCancelDescInput(e) {
    this.setData({ cancelDesc: e.detail.value });
  },

  /**
   * 关闭确认弹窗
   */
  closeCancelModal() {
    this.setData({ 
      showCancelModal: false,
      selectedReason: '',
      cancelDesc: ''
    });
  },

  /**
   * 确认取消订单
   */
  async confirmCancel() {
    const { selectedReason, cancelDesc, orderId } = this.data;
    
    // 验证必填项
    if (!selectedReason) {
      wx.showToast({
        title: '请选择取消原因',
        icon: 'none'
      });
      return;
    }
    
    try {
      wx.showLoading({ title: '提交中...' });
      
      // 提交取消请求
      const res = await cancelOrder(orderId, selectedReason, cancelDesc || '用户主动取消');
      
      wx.hideLoading();
      
      if (res.code === 200) {
        // 关闭弹窗
        this.closeCancelModal();
        
        // 显示成功提示
        wx.showToast({
          title: '取消成功',
          icon: 'success'
        });
        
        // 延迟刷新订单详情
        setTimeout(() => {
          this.loadOrderDetail();
        }, 1500);
      } else {
        wx.showToast({
          title: res.message || '取消失败',
          icon: 'none'
        });
      }
    } catch (error) {
      wx.hideLoading();
      wx.showToast({
        title: '网络错误',
        icon: 'none'
      });
    }
  }
});
```

#### 4. 二次确认弹窗 WXML

```html
<!-- 取消订单确认弹窗 -->
<view wx:if="{{showCancelModal}}" class="cancel-modal-mask" catchtap="closeCancelModal">
  <view class="cancel-modal" catchtap="{{()=>{}}}">
    <view class="modal-header">
      <text class="title">确认取消订单</text>
      <text class="close-btn" catchtap="closeCancelModal">×</text>
    </view>
    
    <view class="modal-body">
      <!-- 违约金信息 -->
      <view class="penalty-info">
        <view class="info-row">
          <text class="label">订单金额</text>
          <text class="value">¥{{cancelPenalty.orderAmount}}</text>
        </view>
        
        <view wx:if="{{cancelPenalty.penaltyAmount > 0}}" class="info-row warning">
          <text class="label">违约金</text>
          <text class="value">-¥{{cancelPenalty.penaltyAmount}}</text>
        </view>
        
        <view class="info-row highlight">
          <text class="label">退款金额</text>
          <text class="value">¥{{cancelPenalty.refundAmount}}</text>
        </view>
        
        <view wx:if="{{cancelPenalty.pointsDeduction > 0}}" class="info-row warning">
          <text class="label">信用分扣除</text>
          <text class="value">-{{cancelPenalty.pointsDeduction}}分</text>
        </view>
      </view>
      
      <!-- 温馨提示 -->
      <view class="tips-box">
        <view class="tips-title">
          <text class="icon">ℹ️</text>
          <text>温馨提示</text>
        </view>
        <view class="tips-list">
          <text wx:for="{{cancelPenalty.tips}}" wx:key="index" class="tip-item">
            • {{item}}
          </text>
        </view>
      </view>
      
      <!-- 取消原因选择 -->
      <view class="reason-section">
        <text class="section-title">请选择取消原因 <text class="required">*</text></text>
        <view class="reason-list">
          <view 
            wx:for="{{cancelReasons}}" 
            wx:key="value"
            class="reason-item {{selectedReason === item.value ? 'selected' : ''}}"
            data-reason="{{item.value}}"
            catchtap="onSelectReason"
          >
            <text class="reason-text">{{item.label}}</text>
            <text wx:if="{{selectedReason === item.value}}" class="check-icon">✓</text>
          </view>
        </view>
      </view>
      
      <!-- 补充说明 -->
      <view class="desc-section">
        <text class="section-title">补充说明（选填）</text>
        <textarea 
          class="desc-input"
          placeholder="请输入取消原因补充说明"
          maxlength="200"
          value="{{cancelDesc}}"
          bindinput="onCancelDescInput"
        />
      </view>
    </view>
    
    <view class="modal-footer">
      <button class="btn btn-cancel" catchtap="closeCancelModal">
        再想想
      </button>
      <button class="btn btn-confirm" catchtap="confirmCancel">
        确认取消
      </button>
    </view>
  </view>
</view>
```

#### 5. 取消原因数据

```javascript
// 在 data 中定义取消原因列表
data: {
  // ... 其他数据
  cancelReasons: [
    { value: 'USER_NO_NEED', label: '我不需要了' },
    { value: 'USER_TIME_CONFLICT', label: '时间有冲突' },
    { value: 'USER_PRICE_HIGH', label: '价格太贵' },
    { value: 'USER_FOUND_ALTERNATIVE', label: '找到其他服务' },
    { value: 'USER_PERSONAL_REASON', label: '个人原因' },
    { value: 'USER_OTHER', label: '其他原因' }
  ]
}
```

#### 6. 样式示例 (WXSS)

```css
/* 弹窗遮罩 */
.cancel-modal-mask {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.6);
  z-index: 9999;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* 弹窗主体 */
.cancel-modal {
  width: 90%;
  max-height: 80vh;
  background: #fff;
  border-radius: 24rpx;
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

/* 弹窗头部 */
.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 40rpx 40rpx 30rpx;
  border-bottom: 1px solid #f0f0f0;
}

.modal-header .title {
  font-size: 36rpx;
  font-weight: bold;
  color: #333;
}

.close-btn {
  font-size: 48rpx;
  color: #999;
  line-height: 1;
}

/* 弹窗内容 */
.modal-body {
  flex: 1;
  overflow-y: auto;
  padding: 30rpx 40rpx;
}

/* 违约金信息 */
.penalty-info {
  background: #f7f8fa;
  border-radius: 16rpx;
  padding: 30rpx;
  margin-bottom: 30rpx;
}

.penalty-info .info-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20rpx 0;
}

.penalty-info .info-row.warning {
  color: #ff6b6b;
}

.penalty-info .info-row.highlight {
  border-top: 2rpx dashed #ddd;
  padding-top: 30rpx;
  margin-top: 10rpx;
}

.penalty-info .highlight .label {
  font-size: 32rpx;
  font-weight: bold;
  color: #333;
}

.penalty-info .highlight .value {
  font-size: 40rpx;
  font-weight: bold;
  color: #ff6b6b;
}

/* 温馨提示 */
.tips-box {
  background: #fff7e6;
  border-left: 6rpx solid #faad14;
  border-radius: 8rpx;
  padding: 24rpx;
  margin-bottom: 30rpx;
}

.tips-title {
  display: flex;
  align-items: center;
  font-size: 28rpx;
  font-weight: bold;
  color: #faad14;
  margin-bottom: 16rpx;
}

.tips-title .icon {
  margin-right: 8rpx;
}

.tips-list {
  display: flex;
  flex-direction: column;
  gap: 12rpx;
}

.tip-item {
  font-size: 26rpx;
  color: #666;
  line-height: 1.6;
}

/* 取消原因 */
.reason-section {
  margin-bottom: 30rpx;
}

.section-title {
  font-size: 28rpx;
  font-weight: bold;
  color: #333;
  margin-bottom: 20rpx;
  display: block;
}

.required {
  color: #ff6b6b;
}

.reason-list {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 20rpx;
}

.reason-item {
  background: #f7f8fa;
  border: 2rpx solid #e5e5e5;
  border-radius: 12rpx;
  padding: 24rpx;
  text-align: center;
  position: relative;
  transition: all 0.3s;
}

.reason-item.selected {
  background: #fff1f0;
  border-color: #ff6b6b;
}

.reason-text {
  font-size: 26rpx;
  color: #666;
}

.reason-item.selected .reason-text {
  color: #ff6b6b;
  font-weight: bold;
}

.check-icon {
  position: absolute;
  top: 8rpx;
  right: 8rpx;
  color: #ff6b6b;
  font-size: 28rpx;
}

/* 补充说明 */
.desc-section {
  margin-bottom: 20rpx;
}

.desc-input {
  width: 100%;
  min-height: 160rpx;
  background: #f7f8fa;
  border: 2rpx solid #e5e5e5;
  border-radius: 12rpx;
  padding: 20rpx;
  font-size: 26rpx;
  color: #333;
}

/* 弹窗底部 */
.modal-footer {
  display: flex;
  gap: 20rpx;
  padding: 30rpx 40rpx;
  border-top: 1px solid #f0f0f0;
}

.btn {
  flex: 1;
  height: 88rpx;
  line-height: 88rpx;
  text-align: center;
  border-radius: 44rpx;
  font-size: 30rpx;
  border: none;
}

.btn-cancel {
  background: #f7f8fa;
  color: #666;
}

.btn-confirm {
  background: linear-gradient(135deg, #ff6b6b 0%, #ff8787 100%);
  color: #fff;
}
```

### 关键要点

1. **必须先调用违约金计算接口**：在显示确认弹窗前，先获取违约金信息
2. **清晰展示费用明细**：订单金额、违约金、退款金额、信用分扣除
3. **必须选择取消原因**：不能直接取消，必须选择原因
4. **温馨提示**：根据违约金情况显示不同的提示信息
5. **二次确认**：用户完全了解后果后才能提交

### 阿姨端类似处理

阿姨端的取消订单流程相同，只需将 `/user/order/` 替换为 `/staff/order/` 即可。

---

---

## 🤖 订单超时自动取消 - 前端交互

### 概述

订单超时取消是**后端自动执行**的定时任务，前端**不需要主动触发**，但需要做好：
1. ✅ **实时状态展示** - 显示订单状态和倒计时
2. ✅ **用户提醒** - 提醒用户尽快完成操作
3. ✅ **状态同步** - 及时更新订单状态

---

### 1️⃣ 支付超时倒计时（15分钟）

#### 场景
用户创建订单后未支付，15分钟后自动取消

#### 前端实现

```javascript
// pages/order/detail.js
Page({
  data: {
    order: null,
    remainingSeconds: 0,
    countdownTimer: null
  },

  onLoad(options) {
    this.setData({ orderId: options.id });
    this.loadOrderDetail();
  },

  async loadOrderDetail() {
    const res = await getOrderDetail(this.data.orderId);
    if (res.code === 200) {
      this.setData({ order: res.data });
      
      // 如果是待支付状态，启动倒计时
      if (res.data.status === 'PENDING_PAYMENT') {
        this.startPaymentCountdown();
      }
    }
  },

  /**
   * 启动支付倒计时
   */
  startPaymentCountdown() {
    const createTime = new Date(this.data.order.createTime).getTime();
    const timeoutMinutes = 15; // 15分钟
    const deadline = createTime + timeoutMinutes * 60 * 1000;
    
    // 立即计算一次
    this.updateCountdown(deadline);
    
    // 每秒更新
    this.data.countdownTimer = setInterval(() => {
      this.updateCountdown(deadline);
    }, 1000);
  },

  /**
   * 更新倒计时
   */
  updateCountdown(deadline) {
    const now = Date.now();
    const remaining = Math.max(0, deadline - now);
    
    this.setData({
      remainingSeconds: Math.floor(remaining / 1000)
    });
    
    // 倒计时结束
    if (remaining <= 0) {
      this.clearCountdown();
      this.showTimeoutTip();
      this.loadOrderDetail(); // 重新加载订单状态
    }
    
    // 最后1分钟警告
    if (remaining <= 60000 && remaining > 59000) {
      wx.showToast({
        title: '订单即将超时，请尽快支付',
        icon: 'none',
        duration: 3000
      });
    }
  },

  /**
   * 格式化倒计时显示
   */
  formatCountdown(seconds) {
    const minutes = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
  },

  /**
   * 清除倒计时
   */
  clearCountdown() {
    if (this.data.countdownTimer) {
      clearInterval(this.data.countdownTimer);
      this.data.countdownTimer = null;
    }
  },

  /**
   * 显示超时提示
   */
  showTimeoutTip() {
    wx.showModal({
      title: '订单已超时',
      content: '订单已因支付超时自动取消，请重新下单',
      showCancel: false,
      confirmText: '知道了',
      success: () => {
        wx.navigateBack();
      }
    });
  },

  onUnload() {
    this.clearCountdown();
  }
});
```

#### WXML 模板

```html
<!-- 待支付倒计时 -->
<view wx:if="{{order.status === 'PENDING_PAYMENT'}}" class="payment-countdown">
  <view class="countdown-bar">
    <text class="icon">⏰</text>
    <text class="text">请在 {{ formatCountdown(remainingSeconds) }} 内完成支付</text>
  </view>
  <view class="countdown-progress">
    <view class="progress-bar" style="width: {{remainingSeconds / 900 * 100}}%"></view>
  </view>
  <button bindtap="goPay" class="pay-btn">立即支付</button>
</view>

<!-- 支付超时取消提示 -->
<view wx:if="{{order.status === 'CANCELLED' && order.cancelReason === 'SYSTEM_PAYMENT_TIMEOUT'}}" 
      class="cancel-tip">
  <view class="tip-icon">❌</view>
  <text class="tip-text">订单已因支付超时自动取消</text>
  <text class="tip-desc">您可以重新下单</text>
</view>
```

#### WXSS 样式

```css
.payment-countdown {
  background: linear-gradient(135deg, #fff5f5 0%, #ffe5e5 100%);
  border-radius: 16rpx;
  padding: 30rpx;
  margin: 20rpx;
}

.countdown-bar {
  display: flex;
  align-items: center;
  margin-bottom: 20rpx;
}

.countdown-bar .icon {
  font-size: 40rpx;
  margin-right: 16rpx;
}

.countdown-bar .text {
  flex: 1;
  font-size: 28rpx;
  color: #ff4d4f;
  font-weight: bold;
}

.countdown-progress {
  height: 8rpx;
  background: #fff;
  border-radius: 4rpx;
  overflow: hidden;
  margin-bottom: 20rpx;
}

.progress-bar {
  height: 100%;
  background: linear-gradient(90deg, #ff6b6b, #ff8787);
  transition: width 1s linear;
}

.pay-btn {
  width: 100%;
  height: 80rpx;
  background: linear-gradient(135deg, #ff6b6b 0%, #ff8787 100%);
  color: #fff;
  border-radius: 40rpx;
  font-size: 30rpx;
  line-height: 80rpx;
  text-align: center;
  border: none;
}

.cancel-tip {
  background: #fff;
  border-radius: 16rpx;
  padding: 40rpx;
  margin: 20rpx;
  text-align: center;
}

.tip-icon {
  font-size: 80rpx;
  margin-bottom: 20rpx;
}

.tip-text {
  display: block;
  font-size: 32rpx;
  color: #333;
  margin-bottom: 10rpx;
}

.tip-desc {
  display: block;
  font-size: 26rpx;
  color: #999;
}
```

---

### 2️⃣ 接单超时提示（30分钟）

#### 场景
用户支付后，30分钟内无阿姨接单，自动取消并退款

#### 前端实现

```javascript
// pages/order/detail.js
Page({
  data: {
    order: null,
    searchingStaff: false,
    searchDuration: 0
  },

  onLoad() {
    // ...
    this.checkOrderStatus();
  },

  /**
   * 定期检查订单状态
   */
  checkOrderStatus() {
    // 如果是待接单状态，每10秒检查一次
    if (this.data.order.status === 'PENDING') {
      this.setData({ searchingStaff: true });
      this.startStatusPolling();
    }
  },

  /**
   * 开始轮询订单状态
   */
  startStatusPolling() {
    this.statusTimer = setInterval(async () => {
      const res = await getOrderDetail(this.data.orderId);
      
      if (res.code === 200) {
        const newStatus = res.data.status;
        
        // 状态变化
        if (newStatus !== this.data.order.status) {
          this.setData({ order: res.data });
          
          // 已接单
          if (newStatus === 'ACCEPTED') {
            this.stopStatusPolling();
            wx.showToast({
              title: '阿姨已接单',
              icon: 'success'
            });
          }
          
          // 已取消（无人接单超时）
          if (newStatus === 'CANCELLED' && res.data.cancelReason === 'SYSTEM_NO_STAFF') {
            this.stopStatusPolling();
            this.showNoStaffTip();
          }
        }
        
        // 更新等待时长
        this.setData({
          searchDuration: this.data.searchDuration + 10
        });
      }
    }, 10000); // 每10秒
  },

  /**
   * 停止轮询
   */
  stopStatusPolling() {
    if (this.statusTimer) {
      clearInterval(this.statusTimer);
      this.statusTimer = null;
    }
    this.setData({ searchingStaff: false });
  },

  /**
   * 显示无人接单提示
   */
  showNoStaffTip() {
    wx.showModal({
      title: '暂无阿姨接单',
      content: '很抱歉，暂时没有合适的阿姨接单。订单已自动取消，款项将在1-7个工作日退回。',
      confirmText: '查看退款',
      cancelText: '重新下单',
      success: (res) => {
        if (res.confirm) {
          // 跳转到退款详情
          this.viewRefund();
        } else {
          // 重新下单
          wx.navigateBack();
        }
      }
    });
  },

  onUnload() {
    this.stopStatusPolling();
  }
});
```

#### WXML 模板

```html
<!-- 等待接单中 -->
<view wx:if="{{order.status === 'PENDING'}}" class="searching-staff">
  <view class="loading-icon">
    <image src="/images/searching.gif" class="gif"></image>
  </view>
  <text class="searching-text">正在为您寻找附近的阿姨...</text>
  <text class="searching-time">已等待 {{Math.floor(searchDuration / 60)}} 分钟</text>
</view>

<!-- 无人接单超时取消 -->
<view wx:if="{{order.status === 'CANCELLED' && order.cancelReason === 'SYSTEM_NO_STAFF'}}" 
      class="cancel-tip">
  <view class="tip-icon">😔</view>
  <text class="tip-text">暂无阿姨接单</text>
  <text class="tip-desc">订单已自动取消，款项将在1-7个工作日退回</text>
  <button bindtap="viewRefund" class="view-refund-btn">查看退款详情</button>
</view>
```

---

### 3️⃣ 服务超时异常（预约时间+1小时）

#### 场景
阿姨接单后，预约时间已过1小时仍未开始服务，自动取消并退款

#### 前端实现

```javascript
// 服务超时检查
Page({
  checkServiceTimeout() {
    const { order } = this.data;
    
    if (order.status === 'ACCEPTED') {
      const serviceTime = new Date(order.serviceTime).getTime();
      const now = Date.now();
      const hoursPassed = (now - serviceTime) / (1000 * 60 * 60);
      
      // 超过预约时间1小时
      if (hoursPassed > 1) {
        wx.showModal({
          title: '服务时间已过',
          content: '预约时间已过去1小时，阿姨仍未开始服务。您可以联系客服处理或等待系统自动取消。',
          confirmText: '联系客服',
          cancelText: '等待处理',
          success: (res) => {
            if (res.confirm) {
              this.contactService();
            }
          }
        });
      }
    }
  }
});
```

#### WXML 模板

```html
<!-- 服务超时取消 -->
<view wx:if="{{order.status === 'CANCELLED' && order.cancelReason === 'SYSTEM_TIMEOUT'}}" 
      class="cancel-tip">
  <view class="tip-icon">⚠️</view>
  <text class="tip-text">服务超时已自动取消</text>
  <text class="tip-desc">阿姨未在预约时间开始服务，订单已自动取消并全额退款</text>
  <button bindtap="viewRefund" class="view-refund-btn">查看退款详情</button>
  <button bindtap="contactService" class="contact-btn">联系客服</button>
</view>
```

---

### 📊 超时取消原因映射

```javascript
/**
 * 获取取消原因的友好描述
 */
function getCancelReasonDesc(cancelReason) {
  const reasonMap = {
    'SYSTEM_PAYMENT_TIMEOUT': {
      title: '支付超时',
      desc: '订单已因支付超时自动取消',
      icon: '⏰',
      color: '#faad14'
    },
    'SYSTEM_NO_STAFF': {
      title: '暂无阿姨接单',
      desc: '订单已自动取消，款项将在1-7个工作日退回',
      icon: '😔',
      color: '#999'
    },
    'SYSTEM_TIMEOUT': {
      title: '服务超时',
      desc: '阿姨未在预约时间开始服务，订单已自动取消并全额退款',
      icon: '⚠️',
      color: '#ff4d4f'
    }
  };
  
  return reasonMap[cancelReason] || {
    title: '订单已取消',
    desc: '订单已取消',
    icon: '❌',
    color: '#999'
  };
}
```

---

### 🔔 用户通知建议

#### 1. 支付超时提醒
```javascript
// 倒计时还剩5分钟时，发送消息提醒
if (remainingSeconds === 300) {
  wx.showToast({
    title: '还有5分钟支付超时，请尽快完成支付',
    icon: 'none',
    duration: 3000
  });
}
```

#### 2. 接单进度提醒
```javascript
// 每5分钟提示一次
if (searchDuration % 300 === 0 && searchDuration > 0) {
  wx.showToast({
    title: `已等待${Math.floor(searchDuration / 60)}分钟，继续为您寻找阿姨...`,
    icon: 'none'
  });
}
```

#### 3. 服务时间提醒
```javascript
// 预约时间前30分钟提醒
const serviceTime = new Date(order.serviceTime).getTime();
const now = Date.now();
if (serviceTime - now <= 1800000 && serviceTime - now > 1790000) {
  wx.showToast({
    title: '服务时间即将到来，请做好准备',
    icon: 'none'
  });
}
```

---

### ⚙️ 配置建议

在小程序配置文件中定义超时时间（与后端保持一致）：

```javascript
// config.js
export default {
  // 超时时间配置（分钟）
  timeout: {
    payment: 15,      // 支付超时
    accept: 30,       // 接单超时
    serviceHours: 1   // 服务超时（小时）
  },
  
  // 状态轮询间隔（秒）
  polling: {
    payment: 10,      // 待支付状态
    pending: 10,      // 待接单状态
    accepted: 30      // 已接单状态
  }
}
```

---

## 📞 技术支持

如有问题，请联系后端开发团队或查看完整API文档：`小程序API接口文档.md` 第5.8、5.9节。

