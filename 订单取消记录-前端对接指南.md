# è®¢å•å–æ¶ˆè®°å½• - å‰ç«¯å¯¹æ¥æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

è®¢å•å–æ¶ˆè®°å½•åŠŸèƒ½ç”¨äºæŸ¥çœ‹è®¢å•å–æ¶ˆçš„è¯¦ç»†ä¿¡æ¯ï¼ŒåŒ…æ‹¬è¿çº¦é‡‘ã€é€€æ¬¾é‡‘é¢ã€è´£ä»»æ–¹åˆ¤å®šç­‰ã€‚æœ¬æ–‡æ¡£å°†å¸®åŠ©å‰ç«¯å¼€å‘è€…å¿«é€Ÿé›†æˆè¯¥åŠŸèƒ½ã€‚

---

## ğŸ¯ æ ¸å¿ƒæ¥å£

### ç”¨æˆ·ç«¯æ¥å£

#### 1. è·å–è®¢å•å–æ¶ˆè®°å½•
```javascript
/**
 * è·å–æŒ‡å®šè®¢å•çš„å–æ¶ˆè¯¦æƒ…
 * @param {number} orderId - è®¢å•ID
 * @returns {Promise} å–æ¶ˆè®°å½•è¯¦æƒ…
 */
async function getOrderCancellation(orderId) {
  const response = await wx.request({
    url: `${API_BASE_URL}/user/order/${orderId}/cancellation`,
    method: 'GET',
    header: {
      'Authorization': `Bearer ${getToken()}`
    }
  });
  return response.data;
}
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "code": 200,
  "message": "è·å–æˆåŠŸ",
  "data": {
    "id": 1,
    "orderId": 21,
    "orderNo": "JY17603580614740855",
    "cancelBy": "USER",
    "cancelByDesc": "ç”¨æˆ·",
    "cancelReason": "USER_NO_NEED",
    "cancelDesc": "ç”¨æˆ·ä¸»åŠ¨å–æ¶ˆ",
    "cancelTime": "2025-10-13T20:21:24",
    "serviceTime": "2025-10-17T00:00:00",
    "timeDiffHours": 75.63,
    "refundRequired": true,
    "orderAmount": 250.00,
    "refundAmount": 250.00,
    "penaltyAmount": 0.00,
    "penaltyRate": 0.00,
    "refundStatus": "PENDING",
    "refundStatusDesc": "å¾…é€€æ¬¾",
    "refundNo": null,
    "responsibleParty": "USER",
    "responsiblePartyDesc": "ç”¨æˆ·",
    "creditScoreDeduction": 0,
    "createdTime": "2025-10-13T20:21:24"
  }
}
```

#### 2. è·å–æˆ‘çš„å–æ¶ˆè®°å½•åˆ—è¡¨
```javascript
/**
 * è·å–ç”¨æˆ·çš„æ‰€æœ‰å–æ¶ˆè®°å½•ï¼ˆåˆ†é¡µï¼‰
 * @param {number} page - é¡µç 
 * @param {number} size - æ¯é¡µå¤§å°
 * @returns {Promise} å–æ¶ˆè®°å½•åˆ—è¡¨
 */
async function getMyCancellations(page = 1, size = 10) {
  const response = await wx.request({
    url: `${API_BASE_URL}/user/order/cancellations`,
    method: 'GET',
    data: { page, size },
    header: {
      'Authorization': `Bearer ${getToken()}`
    }
  });
  return response.data;
}
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "code": 200,
  "message": "è·å–æˆåŠŸ",
  "data": {
    "records": [
      {
        "id": 1,
        "orderId": 21,
        "orderNo": "JY17603580614740855",
        "cancelBy": "USER",
        "cancelByDesc": "ç”¨æˆ·",
        "cancelReason": "USER_NO_NEED",
        "cancelDesc": "ç”¨æˆ·ä¸»åŠ¨å–æ¶ˆ",
        "cancelTime": "2025-10-13T20:21:24",
        "serviceTime": "2025-10-17T00:00:00",
        "timeDiffHours": 75.63,
        "refundRequired": true,
        "orderAmount": 250.00,
        "refundAmount": 250.00,
        "penaltyAmount": 0.00,
        "penaltyRate": 0.00,
        "refundStatus": "PENDING",
        "refundStatusDesc": "å¾…é€€æ¬¾",
        "responsibleParty": "USER",
        "responsiblePartyDesc": "ç”¨æˆ·",
        "creditScoreDeduction": 0,
        "createdTime": "2025-10-13T20:21:24"
      }
    ],
    "total": 10,
    "page": 1,
    "size": 10,
    "pages": 1
  }
}
```

### é˜¿å§¨ç«¯æ¥å£

é˜¿å§¨ç«¯æ¥å£è·¯å¾„ç›¸åŒï¼Œåªéœ€å°† `/user/order/` æ›¿æ¢ä¸º `/staff/order/`ï¼š
- `GET /staff/order/{orderId}/cancellation` - è·å–è®¢å•å–æ¶ˆè®°å½•
- `GET /staff/order/cancellations` - è·å–æˆ‘çš„å–æ¶ˆè®°å½•åˆ—è¡¨

---

## ğŸ¨ é¡µé¢è®¾è®¡å»ºè®®

### 1. è®¢å•è¯¦æƒ…é¡µ - å–æ¶ˆä¿¡æ¯å¡ç‰‡

**åœºæ™¯**: åœ¨å·²å–æ¶ˆè®¢å•çš„è¯¦æƒ…é¡µæ˜¾ç¤ºå–æ¶ˆä¿¡æ¯

```html
<!-- WXML ç¤ºä¾‹ -->
<view wx:if="{{order.status === 'CANCELLED'}}" class="cancel-info-card">
  <view class="card-header">
    <text class="title">å–æ¶ˆä¿¡æ¯</text>
  </view>
  
  <view class="info-row">
    <text class="label">å–æ¶ˆæ—¶é—´</text>
    <text class="value">{{cancellation.cancelTime}}</text>
  </view>
  
  <view class="info-row">
    <text class="label">å–æ¶ˆåŸå› </text>
    <text class="value">{{cancellation.cancelDesc}}</text>
  </view>
  
  <view class="info-row">
    <text class="label">é€€æ¬¾é‡‘é¢</text>
    <text class="value highlight">Â¥{{cancellation.refundAmount}}</text>
  </view>
  
  <view wx:if="{{cancellation.penaltyAmount > 0}}" class="info-row warning">
    <text class="label">è¿çº¦é‡‘</text>
    <text class="value">Â¥{{cancellation.penaltyAmount}}</text>
  </view>
  
  <view class="info-row">
    <text class="label">é€€æ¬¾çŠ¶æ€</text>
    <text class="value status-{{cancellation.refundStatus}}">
      {{cancellation.refundStatusDesc}}
    </text>
  </view>
  
  <view wx:if="{{cancellation.creditScoreDeduction > 0}}" class="info-row warning">
    <text class="label">ä¿¡ç”¨åˆ†æ‰£é™¤</text>
    <text class="value">-{{cancellation.creditScoreDeduction}}åˆ†</text>
  </view>
</view>
```

**æ ·å¼å»ºè®®**:
```css
/* WXSS ç¤ºä¾‹ */
.cancel-info-card {
  background: #fff;
  border-radius: 12rpx;
  padding: 30rpx;
  margin: 20rpx 0;
}

.card-header {
  border-left: 6rpx solid #ff6b6b;
  padding-left: 20rpx;
  margin-bottom: 30rpx;
}

.info-row {
  display: flex;
  justify-content: space-between;
  padding: 20rpx 0;
  border-bottom: 1px solid #f0f0f0;
}

.info-row.warning {
  color: #ff6b6b;
}

.value.highlight {
  color: #ff6b6b;
  font-weight: bold;
  font-size: 32rpx;
}

.status-PENDING {
  color: #faad14;
}

.status-SUCCESS {
  color: #52c41a;
}

.status-FAILED {
  color: #ff4d4f;
}
```

### 2. å–æ¶ˆè®°å½•åˆ—è¡¨é¡µ

**åœºæ™¯**: ç‹¬ç«‹çš„å–æ¶ˆè®°å½•æŸ¥çœ‹é¡µé¢ï¼ˆæˆ‘çš„è®¢å• > å–æ¶ˆè®°å½•ï¼‰

```javascript
// Page JS
Page({
  data: {
    cancellations: [],
    page: 1,
    size: 10,
    total: 0,
    loading: false,
    hasMore: true
  },

  onLoad() {
    this.loadCancellations();
  },

  async loadCancellations() {
    if (this.data.loading || !this.data.hasMore) return;

    this.setData({ loading: true });

    try {
      const res = await getMyCancellations(this.data.page, this.data.size);
      
      if (res.code === 200) {
        const newData = res.data.records;
        this.setData({
          cancellations: [...this.data.cancellations, ...newData],
          total: res.data.total,
          page: this.data.page + 1,
          hasMore: this.data.cancellations.length + newData.length < res.data.total
        });
      }
    } catch (error) {
      wx.showToast({
        title: 'åŠ è½½å¤±è´¥',
        icon: 'none'
      });
    } finally {
      this.setData({ loading: false });
    }
  },

  onReachBottom() {
    this.loadCancellations();
  },

  // è·³è½¬åˆ°è®¢å•è¯¦æƒ…
  viewOrderDetail(e) {
    const orderId = e.currentTarget.dataset.orderId;
    wx.navigateTo({
      url: `/pages/order/detail?id=${orderId}`
    });
  }
});
```

```html
<!-- WXML åˆ—è¡¨ç¤ºä¾‹ -->
<view class="cancellation-list">
  <view 
    wx:for="{{cancellations}}" 
    wx:key="id" 
    class="cancellation-item"
    bindtap="viewOrderDetail"
    data-order-id="{{item.orderId}}"
  >
    <view class="item-header">
      <text class="order-no">è®¢å•å·: {{item.orderNo}}</text>
      <text class="cancel-time">{{item.cancelTime}}</text>
    </view>
    
    <view class="item-body">
      <view class="reason">
        <text class="label">å–æ¶ˆåŸå› :</text>
        <text class="value">{{item.cancelDesc}}</text>
      </view>
      
      <view class="amount-info">
        <view class="amount-row">
          <text class="label">è®¢å•é‡‘é¢</text>
          <text class="value">Â¥{{item.orderAmount}}</text>
        </view>
        <view class="amount-row">
          <text class="label">é€€æ¬¾é‡‘é¢</text>
          <text class="value refund">Â¥{{item.refundAmount}}</text>
        </view>
        <view wx:if="{{item.penaltyAmount > 0}}" class="amount-row">
          <text class="label">è¿çº¦é‡‘</text>
          <text class="value penalty">Â¥{{item.penaltyAmount}}</text>
        </view>
      </view>
    </view>
    
    <view class="item-footer">
      <text class="refund-status status-{{item.refundStatus}}">
        {{item.refundStatusDesc}}
      </text>
      <text class="arrow">â€º</text>
    </view>
  </view>

  <view wx:if="{{loading}}" class="loading">
    <text>åŠ è½½ä¸­...</text>
  </view>

  <view wx:if="{{!hasMore && cancellations.length > 0}}" class="no-more">
    <text>æ²¡æœ‰æ›´å¤šäº†</text>
  </view>

  <view wx:if="{{cancellations.length === 0 && !loading}}" class="empty">
    <image src="/images/empty.png" class="empty-image"></image>
    <text class="empty-text">æš‚æ— å–æ¶ˆè®°å½•</text>
  </view>
</view>
```

---

## ğŸ’¡ ä¸šåŠ¡é€»è¾‘å¤„ç†

### 1. å–æ¶ˆçŠ¶æ€æ˜¾ç¤ºé€»è¾‘

```javascript
/**
 * è·å–é€€æ¬¾çŠ¶æ€çš„é¢œè‰²å’Œå›¾æ ‡
 * @param {string} status - é€€æ¬¾çŠ¶æ€
 */
function getRefundStatusStyle(status) {
  const statusMap = {
    'PENDING': {
      color: '#faad14',
      icon: 'clock',
      text: 'å¾…é€€æ¬¾'
    },
    'PROCESSING': {
      color: '#1890ff',
      icon: 'loading',
      text: 'é€€æ¬¾ä¸­'
    },
    'SUCCESS': {
      color: '#52c41a',
      icon: 'success',
      text: 'å·²é€€æ¬¾'
    },
    'FAILED': {
      color: '#ff4d4f',
      icon: 'error',
      text: 'é€€æ¬¾å¤±è´¥'
    }
  };
  return statusMap[status] || statusMap['PENDING'];
}
```

### 2. è´£ä»»æ–¹æ˜¾ç¤º

```javascript
/**
 * è·å–è´£ä»»æ–¹çš„æ ‡ç­¾æ ·å¼
 * @param {string} party - è´£ä»»æ–¹
 */
function getResponsiblePartyBadge(party) {
  const partyMap = {
    'USER': {
      color: '#ff6b6b',
      text: 'ç”¨æˆ·è´£ä»»',
      tip: 'ç”±äºæ‚¨çš„åŸå› å–æ¶ˆï¼Œå¯èƒ½äº§ç”Ÿè¿çº¦é‡‘'
    },
    'STAFF': {
      color: '#ffa940',
      text: 'é˜¿å§¨è´£ä»»',
      tip: 'é˜¿å§¨å–æ¶ˆè®¢å•ï¼Œå·²å…¨é¢é€€æ¬¾'
    },
    'PLATFORM': {
      color: '#597ef7',
      text: 'å¹³å°è´£ä»»',
      tip: 'å¹³å°å–æ¶ˆè®¢å•ï¼Œå·²å…¨é¢é€€æ¬¾å¹¶è¡¥å¿'
    },
    'NONE': {
      color: '#8c8c8c',
      text: 'æ— è´£ä»»',
      tip: 'åŒæ–¹åå•†å–æ¶ˆï¼Œæ— è¿çº¦é‡‘'
    }
  };
  return partyMap[party] || partyMap['NONE'];
}
```

### 3. è¿çº¦é‡‘æç¤º

```javascript
/**
 * æ˜¾ç¤ºè¿çº¦é‡‘è¯´æ˜å¼¹çª—
 * @param {object} cancellation - å–æ¶ˆè®°å½•å¯¹è±¡
 */
function showPenaltyExplanation(cancellation) {
  const messages = [];
  
  if (cancellation.penaltyAmount > 0) {
    messages.push(`å› è·ç¦»æœåŠ¡æ—¶é—´ä¸è¶³${Math.ceil(cancellation.timeDiffHours)}å°æ—¶`);
    messages.push(`æŒ‰è®¢å•é‡‘é¢çš„${cancellation.penaltyRate}%æ”¶å–è¿çº¦é‡‘`);
    messages.push(`è¿çº¦é‡‘ï¼šÂ¥${cancellation.penaltyAmount}`);
    messages.push(`å®é™…é€€æ¬¾ï¼šÂ¥${cancellation.refundAmount}`);
  } else {
    messages.push('è·ç¦»æœåŠ¡æ—¶é—´å……è¶³ï¼Œæ— éœ€æ”¯ä»˜è¿çº¦é‡‘');
    messages.push(`å…¨é¢é€€æ¬¾ï¼šÂ¥${cancellation.refundAmount}`);
  }
  
  if (cancellation.creditScoreDeduction > 0) {
    messages.push(`\nä¿¡ç”¨åˆ†æ‰£é™¤ï¼š${cancellation.creditScoreDeduction}åˆ†`);
  }
  
  wx.showModal({
    title: 'å–æ¶ˆè¯´æ˜',
    content: messages.join('\n'),
    showCancel: false,
    confirmText: 'çŸ¥é“äº†'
  });
}
```

---

## ğŸ”„ å®Œæ•´ä¸šåŠ¡æµç¨‹ç¤ºä¾‹

### åœºæ™¯ï¼šç”¨æˆ·æŸ¥çœ‹å·²å–æ¶ˆè®¢å•è¯¦æƒ…

```javascript
// pages/order/detail.js
Page({
  data: {
    orderId: null,
    order: null,
    cancellation: null,
    showCancelInfo: false
  },

  async onLoad(options) {
    this.setData({ orderId: options.id });
    await this.loadOrderDetail();
    
    // å¦‚æœè®¢å•å·²å–æ¶ˆï¼ŒåŠ è½½å–æ¶ˆè®°å½•
    if (this.data.order.status === 'CANCELLED') {
      await this.loadCancellationInfo();
    }
  },

  async loadOrderDetail() {
    try {
      const res = await getOrderDetail(this.data.orderId);
      if (res.code === 200) {
        this.setData({ order: res.data });
      }
    } catch (error) {
      wx.showToast({
        title: 'è®¢å•åŠ è½½å¤±è´¥',
        icon: 'none'
      });
    }
  },

  async loadCancellationInfo() {
    try {
      const res = await getOrderCancellation(this.data.orderId);
      if (res.code === 200) {
        this.setData({ 
          cancellation: res.data,
          showCancelInfo: true
        });
      }
    } catch (error) {
      console.error('å–æ¶ˆè®°å½•åŠ è½½å¤±è´¥', error);
      // é™é»˜å¤„ç†ï¼Œä¸å½±å“è®¢å•è¯¦æƒ…æ˜¾ç¤º
    }
  },

  // æŸ¥çœ‹è¿çº¦é‡‘è¯´æ˜
  showPenaltyInfo() {
    showPenaltyExplanation(this.data.cancellation);
  },

  // è”ç³»å®¢æœ
  contactService() {
    wx.navigateTo({
      url: '/pages/service/contact'
    });
  }
});
```

---

## ğŸ“Š æ•°æ®å­—æ®µè¯´æ˜

| å­—æ®µå | ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹å€¼ |
|--------|------|------|--------|
| `cancelBy` | String | å–æ¶ˆå‘èµ·æ–¹ | USER/STAFF/SYSTEM |
| `cancelByDesc` | String | å–æ¶ˆå‘èµ·æ–¹æè¿° | "ç”¨æˆ·"/"é˜¿å§¨"/"ç³»ç»Ÿ" |
| `cancelReason` | String | å–æ¶ˆåŸå› ç±»å‹ | USER_NO_NEED |
| `cancelDesc` | String | å–æ¶ˆåŸå› æè¿° | "ç”¨æˆ·ä¸»åŠ¨å–æ¶ˆ" |
| `timeDiffHours` | Number | è·ç¦»æœåŠ¡æ—¶é—´ï¼ˆå°æ—¶ï¼‰ | 75.63 |
| `refundRequired` | Boolean | æ˜¯å¦éœ€è¦é€€æ¬¾ | true/false |
| `orderAmount` | Number | è®¢å•é‡‘é¢ | 250.00 |
| `refundAmount` | Number | é€€æ¬¾é‡‘é¢ | 250.00 |
| `penaltyAmount` | Number | è¿çº¦é‡‘ | 0.00 |
| `penaltyRate` | Number | è¿çº¦é‡‘ç‡(%) | 0.00 |
| `refundStatus` | String | é€€æ¬¾çŠ¶æ€ | PENDING/PROCESSING/SUCCESS/FAILED |
| `refundStatusDesc` | String | é€€æ¬¾çŠ¶æ€æè¿° | "å¾…é€€æ¬¾"/"é€€æ¬¾ä¸­"/"å·²é€€æ¬¾"/"é€€æ¬¾å¤±è´¥" |
| `responsibleParty` | String | è´£ä»»æ–¹ | USER/STAFF/PLATFORM/NONE |
| `responsiblePartyDesc` | String | è´£ä»»æ–¹æè¿° | "ç”¨æˆ·"/"é˜¿å§¨"/"å¹³å°"/"æ— " |
| `creditScoreDeduction` | Number | ä¿¡ç”¨åˆ†æ‰£é™¤ | 0 |

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. æƒé™æ§åˆ¶
- å¿…é¡»æºå¸¦æœ‰æ•ˆçš„ JWT Token
- åªèƒ½æŸ¥çœ‹è‡ªå·±çš„è®¢å•å–æ¶ˆè®°å½•
- åç«¯ä¼šéªŒè¯è®¢å•å½’å±æƒé™

### 2. é”™è¯¯å¤„ç†
```javascript
// ç»Ÿä¸€é”™è¯¯å¤„ç†
async function handleCancellationRequest(requestFn) {
  try {
    const res = await requestFn();
    
    if (res.code === 200) {
      return res.data;
    } else {
      throw new Error(res.message || 'è¯·æ±‚å¤±è´¥');
    }
  } catch (error) {
    // æ ¹æ®é”™è¯¯ç±»å‹æ˜¾ç¤ºä¸åŒæç¤º
    if (error.message.includes('æ— æƒ')) {
      wx.showToast({
        title: 'æ— æƒæŸ¥çœ‹',
        icon: 'none'
      });
    } else if (error.message.includes('ä¸å­˜åœ¨')) {
      wx.showToast({
        title: 'è®°å½•ä¸å­˜åœ¨',
        icon: 'none'
      });
    } else {
      wx.showToast({
        title: error.message || 'åŠ è½½å¤±è´¥',
        icon: 'none'
      });
    }
    throw error;
  }
}
```

### 3. æ€§èƒ½ä¼˜åŒ–
```javascript
// ç¼“å­˜å–æ¶ˆè®°å½•ï¼Œé¿å…é‡å¤è¯·æ±‚
const cancellationCache = new Map();

async function getCachedCancellation(orderId) {
  if (cancellationCache.has(orderId)) {
    return cancellationCache.get(orderId);
  }
  
  const data = await getOrderCancellation(orderId);
  cancellationCache.set(orderId, data);
  
  // 5åˆ†é’Ÿåæ¸…é™¤ç¼“å­˜
  setTimeout(() => {
    cancellationCache.delete(orderId);
  }, 5 * 60 * 1000);
  
  return data;
}
```

### 4. æ—¶é—´æ ¼å¼åŒ–
```javascript
/**
 * æ ¼å¼åŒ–å–æ¶ˆæ—¶é—´æ˜¾ç¤º
 * @param {string} timeStr - ISOæ—¶é—´å­—ç¬¦ä¸²
 */
function formatCancelTime(timeStr) {
  const date = new Date(timeStr);
  const now = new Date();
  const diff = now - date;
  
  // 1å°æ—¶å†…
  if (diff < 3600000) {
    const minutes = Math.floor(diff / 60000);
    return `${minutes}åˆ†é’Ÿå‰`;
  }
  
  // ä»Šå¤©
  if (date.toDateString() === now.toDateString()) {
    return `ä»Šå¤© ${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;
  }
  
  // æ˜¨å¤©
  const yesterday = new Date(now);
  yesterday.setDate(yesterday.getDate() - 1);
  if (date.toDateString() === yesterday.toDateString()) {
    return `æ˜¨å¤© ${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;
  }
  
  // å…¶ä»–
  return `${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥`;
}
```

---

## ğŸ¯ å¿«é€Ÿå¼€å§‹æ£€æŸ¥æ¸…å•

- [ ] é…ç½®APIåŸºç¡€è·¯å¾„ `API_BASE_URL`
- [ ] å®ç°Tokenè·å–æ–¹æ³• `getToken()`
- [ ] åˆ›å»ºå–æ¶ˆè®°å½•è¯·æ±‚æ–¹æ³•
- [ ] åœ¨è®¢å•è¯¦æƒ…é¡µé›†æˆå–æ¶ˆä¿¡æ¯å±•ç¤º
- [ ] ï¼ˆå¯é€‰ï¼‰åˆ›å»ºç‹¬ç«‹çš„å–æ¶ˆè®°å½•åˆ—è¡¨é¡µ
- [ ] æµ‹è¯•æƒé™æ§åˆ¶å’Œé”™è¯¯å¤„ç†
- [ ] ä¼˜åŒ–æ ·å¼å’Œäº¤äº’ä½“éªŒ

---

## ğŸš¨ å–æ¶ˆè®¢å•äºŒæ¬¡ç¡®è®¤åŠŸèƒ½

### ä¸šåŠ¡æµç¨‹

å–æ¶ˆè®¢å•éœ€è¦**äºŒæ¬¡ç¡®è®¤**ï¼Œå‘ç”¨æˆ·å±•ç¤ºè¿çº¦é‡‘ã€é€€æ¬¾é‡‘é¢ç­‰é‡è¦ä¿¡æ¯ï¼š

```
ç”¨æˆ·ç‚¹å‡»å–æ¶ˆ â†’ è°ƒç”¨è¿çº¦é‡‘è®¡ç®—æ¥å£ â†’ å±•ç¤ºç¡®è®¤å¼¹çª— â†’ ç”¨æˆ·ç¡®è®¤ â†’ æäº¤å–æ¶ˆè¯·æ±‚
```

### å®ç°æ­¥éª¤

#### 1. è¿çº¦é‡‘é¢„è§ˆæ¥å£

```javascript
/**
 * è®¡ç®—å–æ¶ˆè¿çº¦é‡‘ï¼ˆé¢„è§ˆï¼‰
 * @param {number} orderId - è®¢å•ID
 * @returns {Promise} è¿çº¦é‡‘è®¡ç®—ç»“æœ
 */
async function calculateCancelPenalty(orderId) {
  const response = await wx.request({
    url: `${API_BASE_URL}/user/order/${orderId}/cancel-penalty`,
    method: 'GET',
    header: {
      'Authorization': `Bearer ${getToken()}`
    }
  });
  return response.data;
}
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "code": 200,
  "message": "è®¡ç®—æˆåŠŸ",
  "data": {
    "canCancel": true,
    "orderAmount": 250.00,
    "refundAmount": 250.00,
    "penaltyAmount": 0.00,
    "penaltyRate": 0.00,
    "pointsDeduction": 0,
    "timeDiffHours": 75.63,
    "cancelDeadline": "2025-10-17T00:00:00",
    "tips": [
      "è·ç¦»æœåŠ¡æ—¶é—´è¶…è¿‡48å°æ—¶ï¼Œæ— è¿çº¦é‡‘",
      "å°†å…¨é¢é€€æ¬¾åˆ°åŸæ”¯ä»˜è´¦æˆ·"
    ]
  }
}
```

#### 2. å–æ¶ˆè®¢å•æ¥å£

```javascript
/**
 * æäº¤å–æ¶ˆè®¢å•è¯·æ±‚
 * @param {number} orderId - è®¢å•ID
 * @param {string} reason - å–æ¶ˆåŸå› ç±»å‹
 * @param {string} desc - å–æ¶ˆåŸå› æè¿°
 * @returns {Promise} å–æ¶ˆç»“æœ
 */
async function cancelOrder(orderId, reason, desc) {
  const response = await wx.request({
    url: `${API_BASE_URL}/user/order/cancel`,
    method: 'POST',
    data: {
      orderId: orderId,
      cancelReason: reason,
      cancelDesc: desc
    },
    header: {
      'Authorization': `Bearer ${getToken()}`
    }
  });
  return response.data;
}
```

#### 3. å®Œæ•´çš„äºŒæ¬¡ç¡®è®¤æµç¨‹

```javascript
// pages/order/detail.js
Page({
  data: {
    orderId: null,
    order: null,
    cancelPenalty: null,
    showCancelModal: false,
    selectedReason: '',
    cancelDesc: ''
  },

  /**
   * ç”¨æˆ·ç‚¹å‡»å–æ¶ˆè®¢å•æŒ‰é’®
   */
  async onCancelOrder() {
    try {
      wx.showLoading({ title: 'è®¡ç®—ä¸­...' });
      
      // 1. è°ƒç”¨è¿çº¦é‡‘è®¡ç®—æ¥å£
      const res = await calculateCancelPenalty(this.data.orderId);
      
      wx.hideLoading();
      
      if (res.code === 200) {
        const penalty = res.data;
        
        // 2. æ£€æŸ¥æ˜¯å¦å¯ä»¥å–æ¶ˆ
        if (!penalty.canCancel) {
          wx.showModal({
            title: 'æ— æ³•å–æ¶ˆ',
            content: penalty.tips.join('\n'),
            showCancel: false
          });
          return;
        }
        
        // 3. ä¿å­˜è¿çº¦é‡‘ä¿¡æ¯å¹¶æ˜¾ç¤ºç¡®è®¤å¼¹çª—
        this.setData({ 
          cancelPenalty: penalty,
          showCancelModal: true 
        });
      } else {
        wx.showToast({
          title: res.message || 'è·å–å¤±è´¥',
          icon: 'none'
        });
      }
    } catch (error) {
      wx.hideLoading();
      wx.showToast({
        title: 'ç½‘ç»œé”™è¯¯',
        icon: 'none'
      });
    }
  },

  /**
   * é€‰æ‹©å–æ¶ˆåŸå› 
   */
  onSelectReason(e) {
    const reason = e.currentTarget.dataset.reason;
    this.setData({ selectedReason: reason });
  },

  /**
   * è¾“å…¥å–æ¶ˆè¯´æ˜
   */
  onCancelDescInput(e) {
    this.setData({ cancelDesc: e.detail.value });
  },

  /**
   * å…³é—­ç¡®è®¤å¼¹çª—
   */
  closeCancelModal() {
    this.setData({ 
      showCancelModal: false,
      selectedReason: '',
      cancelDesc: ''
    });
  },

  /**
   * ç¡®è®¤å–æ¶ˆè®¢å•
   */
  async confirmCancel() {
    const { selectedReason, cancelDesc, orderId } = this.data;
    
    // éªŒè¯å¿…å¡«é¡¹
    if (!selectedReason) {
      wx.showToast({
        title: 'è¯·é€‰æ‹©å–æ¶ˆåŸå› ',
        icon: 'none'
      });
      return;
    }
    
    try {
      wx.showLoading({ title: 'æäº¤ä¸­...' });
      
      // æäº¤å–æ¶ˆè¯·æ±‚
      const res = await cancelOrder(orderId, selectedReason, cancelDesc || 'ç”¨æˆ·ä¸»åŠ¨å–æ¶ˆ');
      
      wx.hideLoading();
      
      if (res.code === 200) {
        // å…³é—­å¼¹çª—
        this.closeCancelModal();
        
        // æ˜¾ç¤ºæˆåŠŸæç¤º
        wx.showToast({
          title: 'å–æ¶ˆæˆåŠŸ',
          icon: 'success'
        });
        
        // å»¶è¿Ÿåˆ·æ–°è®¢å•è¯¦æƒ…
        setTimeout(() => {
          this.loadOrderDetail();
        }, 1500);
      } else {
        wx.showToast({
          title: res.message || 'å–æ¶ˆå¤±è´¥',
          icon: 'none'
        });
      }
    } catch (error) {
      wx.hideLoading();
      wx.showToast({
        title: 'ç½‘ç»œé”™è¯¯',
        icon: 'none'
      });
    }
  }
});
```

#### 4. äºŒæ¬¡ç¡®è®¤å¼¹çª— WXML

```html
<!-- å–æ¶ˆè®¢å•ç¡®è®¤å¼¹çª— -->
<view wx:if="{{showCancelModal}}" class="cancel-modal-mask" catchtap="closeCancelModal">
  <view class="cancel-modal" catchtap="{{()=>{}}}">
    <view class="modal-header">
      <text class="title">ç¡®è®¤å–æ¶ˆè®¢å•</text>
      <text class="close-btn" catchtap="closeCancelModal">Ã—</text>
    </view>
    
    <view class="modal-body">
      <!-- è¿çº¦é‡‘ä¿¡æ¯ -->
      <view class="penalty-info">
        <view class="info-row">
          <text class="label">è®¢å•é‡‘é¢</text>
          <text class="value">Â¥{{cancelPenalty.orderAmount}}</text>
        </view>
        
        <view wx:if="{{cancelPenalty.penaltyAmount > 0}}" class="info-row warning">
          <text class="label">è¿çº¦é‡‘</text>
          <text class="value">-Â¥{{cancelPenalty.penaltyAmount}}</text>
        </view>
        
        <view class="info-row highlight">
          <text class="label">é€€æ¬¾é‡‘é¢</text>
          <text class="value">Â¥{{cancelPenalty.refundAmount}}</text>
        </view>
        
        <view wx:if="{{cancelPenalty.pointsDeduction > 0}}" class="info-row warning">
          <text class="label">ä¿¡ç”¨åˆ†æ‰£é™¤</text>
          <text class="value">-{{cancelPenalty.pointsDeduction}}åˆ†</text>
        </view>
      </view>
      
      <!-- æ¸©é¦¨æç¤º -->
      <view class="tips-box">
        <view class="tips-title">
          <text class="icon">â„¹ï¸</text>
          <text>æ¸©é¦¨æç¤º</text>
        </view>
        <view class="tips-list">
          <text wx:for="{{cancelPenalty.tips}}" wx:key="index" class="tip-item">
            â€¢ {{item}}
          </text>
        </view>
      </view>
      
      <!-- å–æ¶ˆåŸå› é€‰æ‹© -->
      <view class="reason-section">
        <text class="section-title">è¯·é€‰æ‹©å–æ¶ˆåŸå›  <text class="required">*</text></text>
        <view class="reason-list">
          <view 
            wx:for="{{cancelReasons}}" 
            wx:key="value"
            class="reason-item {{selectedReason === item.value ? 'selected' : ''}}"
            data-reason="{{item.value}}"
            catchtap="onSelectReason"
          >
            <text class="reason-text">{{item.label}}</text>
            <text wx:if="{{selectedReason === item.value}}" class="check-icon">âœ“</text>
          </view>
        </view>
      </view>
      
      <!-- è¡¥å……è¯´æ˜ -->
      <view class="desc-section">
        <text class="section-title">è¡¥å……è¯´æ˜ï¼ˆé€‰å¡«ï¼‰</text>
        <textarea 
          class="desc-input"
          placeholder="è¯·è¾“å…¥å–æ¶ˆåŸå› è¡¥å……è¯´æ˜"
          maxlength="200"
          value="{{cancelDesc}}"
          bindinput="onCancelDescInput"
        />
      </view>
    </view>
    
    <view class="modal-footer">
      <button class="btn btn-cancel" catchtap="closeCancelModal">
        å†æƒ³æƒ³
      </button>
      <button class="btn btn-confirm" catchtap="confirmCancel">
        ç¡®è®¤å–æ¶ˆ
      </button>
    </view>
  </view>
</view>
```

#### 5. å–æ¶ˆåŸå› æ•°æ®

```javascript
// åœ¨ data ä¸­å®šä¹‰å–æ¶ˆåŸå› åˆ—è¡¨
data: {
  // ... å…¶ä»–æ•°æ®
  cancelReasons: [
    { value: 'USER_NO_NEED', label: 'æˆ‘ä¸éœ€è¦äº†' },
    { value: 'USER_TIME_CONFLICT', label: 'æ—¶é—´æœ‰å†²çª' },
    { value: 'USER_PRICE_HIGH', label: 'ä»·æ ¼å¤ªè´µ' },
    { value: 'USER_FOUND_ALTERNATIVE', label: 'æ‰¾åˆ°å…¶ä»–æœåŠ¡' },
    { value: 'USER_PERSONAL_REASON', label: 'ä¸ªäººåŸå› ' },
    { value: 'USER_OTHER', label: 'å…¶ä»–åŸå› ' }
  ]
}
```

#### 6. æ ·å¼ç¤ºä¾‹ (WXSS)

```css
/* å¼¹çª—é®ç½© */
.cancel-modal-mask {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.6);
  z-index: 9999;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* å¼¹çª—ä¸»ä½“ */
.cancel-modal {
  width: 90%;
  max-height: 80vh;
  background: #fff;
  border-radius: 24rpx;
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

/* å¼¹çª—å¤´éƒ¨ */
.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 40rpx 40rpx 30rpx;
  border-bottom: 1px solid #f0f0f0;
}

.modal-header .title {
  font-size: 36rpx;
  font-weight: bold;
  color: #333;
}

.close-btn {
  font-size: 48rpx;
  color: #999;
  line-height: 1;
}

/* å¼¹çª—å†…å®¹ */
.modal-body {
  flex: 1;
  overflow-y: auto;
  padding: 30rpx 40rpx;
}

/* è¿çº¦é‡‘ä¿¡æ¯ */
.penalty-info {
  background: #f7f8fa;
  border-radius: 16rpx;
  padding: 30rpx;
  margin-bottom: 30rpx;
}

.penalty-info .info-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20rpx 0;
}

.penalty-info .info-row.warning {
  color: #ff6b6b;
}

.penalty-info .info-row.highlight {
  border-top: 2rpx dashed #ddd;
  padding-top: 30rpx;
  margin-top: 10rpx;
}

.penalty-info .highlight .label {
  font-size: 32rpx;
  font-weight: bold;
  color: #333;
}

.penalty-info .highlight .value {
  font-size: 40rpx;
  font-weight: bold;
  color: #ff6b6b;
}

/* æ¸©é¦¨æç¤º */
.tips-box {
  background: #fff7e6;
  border-left: 6rpx solid #faad14;
  border-radius: 8rpx;
  padding: 24rpx;
  margin-bottom: 30rpx;
}

.tips-title {
  display: flex;
  align-items: center;
  font-size: 28rpx;
  font-weight: bold;
  color: #faad14;
  margin-bottom: 16rpx;
}

.tips-title .icon {
  margin-right: 8rpx;
}

.tips-list {
  display: flex;
  flex-direction: column;
  gap: 12rpx;
}

.tip-item {
  font-size: 26rpx;
  color: #666;
  line-height: 1.6;
}

/* å–æ¶ˆåŸå›  */
.reason-section {
  margin-bottom: 30rpx;
}

.section-title {
  font-size: 28rpx;
  font-weight: bold;
  color: #333;
  margin-bottom: 20rpx;
  display: block;
}

.required {
  color: #ff6b6b;
}

.reason-list {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 20rpx;
}

.reason-item {
  background: #f7f8fa;
  border: 2rpx solid #e5e5e5;
  border-radius: 12rpx;
  padding: 24rpx;
  text-align: center;
  position: relative;
  transition: all 0.3s;
}

.reason-item.selected {
  background: #fff1f0;
  border-color: #ff6b6b;
}

.reason-text {
  font-size: 26rpx;
  color: #666;
}

.reason-item.selected .reason-text {
  color: #ff6b6b;
  font-weight: bold;
}

.check-icon {
  position: absolute;
  top: 8rpx;
  right: 8rpx;
  color: #ff6b6b;
  font-size: 28rpx;
}

/* è¡¥å……è¯´æ˜ */
.desc-section {
  margin-bottom: 20rpx;
}

.desc-input {
  width: 100%;
  min-height: 160rpx;
  background: #f7f8fa;
  border: 2rpx solid #e5e5e5;
  border-radius: 12rpx;
  padding: 20rpx;
  font-size: 26rpx;
  color: #333;
}

/* å¼¹çª—åº•éƒ¨ */
.modal-footer {
  display: flex;
  gap: 20rpx;
  padding: 30rpx 40rpx;
  border-top: 1px solid #f0f0f0;
}

.btn {
  flex: 1;
  height: 88rpx;
  line-height: 88rpx;
  text-align: center;
  border-radius: 44rpx;
  font-size: 30rpx;
  border: none;
}

.btn-cancel {
  background: #f7f8fa;
  color: #666;
}

.btn-confirm {
  background: linear-gradient(135deg, #ff6b6b 0%, #ff8787 100%);
  color: #fff;
}
```

### å…³é”®è¦ç‚¹

1. **å¿…é¡»å…ˆè°ƒç”¨è¿çº¦é‡‘è®¡ç®—æ¥å£**ï¼šåœ¨æ˜¾ç¤ºç¡®è®¤å¼¹çª—å‰ï¼Œå…ˆè·å–è¿çº¦é‡‘ä¿¡æ¯
2. **æ¸…æ™°å±•ç¤ºè´¹ç”¨æ˜ç»†**ï¼šè®¢å•é‡‘é¢ã€è¿çº¦é‡‘ã€é€€æ¬¾é‡‘é¢ã€ä¿¡ç”¨åˆ†æ‰£é™¤
3. **å¿…é¡»é€‰æ‹©å–æ¶ˆåŸå› **ï¼šä¸èƒ½ç›´æ¥å–æ¶ˆï¼Œå¿…é¡»é€‰æ‹©åŸå› 
4. **æ¸©é¦¨æç¤º**ï¼šæ ¹æ®è¿çº¦é‡‘æƒ…å†µæ˜¾ç¤ºä¸åŒçš„æç¤ºä¿¡æ¯
5. **äºŒæ¬¡ç¡®è®¤**ï¼šç”¨æˆ·å®Œå…¨äº†è§£åæœåæ‰èƒ½æäº¤

### é˜¿å§¨ç«¯ç±»ä¼¼å¤„ç†

é˜¿å§¨ç«¯çš„å–æ¶ˆè®¢å•æµç¨‹ç›¸åŒï¼Œåªéœ€å°† `/user/order/` æ›¿æ¢ä¸º `/staff/order/` å³å¯ã€‚

---

---

## ğŸ¤– è®¢å•è¶…æ—¶è‡ªåŠ¨å–æ¶ˆ - å‰ç«¯äº¤äº’

### æ¦‚è¿°

è®¢å•è¶…æ—¶å–æ¶ˆæ˜¯**åç«¯è‡ªåŠ¨æ‰§è¡Œ**çš„å®šæ—¶ä»»åŠ¡ï¼Œå‰ç«¯**ä¸éœ€è¦ä¸»åŠ¨è§¦å‘**ï¼Œä½†éœ€è¦åšå¥½ï¼š
1. âœ… **å®æ—¶çŠ¶æ€å±•ç¤º** - æ˜¾ç¤ºè®¢å•çŠ¶æ€å’Œå€’è®¡æ—¶
2. âœ… **ç”¨æˆ·æé†’** - æé†’ç”¨æˆ·å°½å¿«å®Œæˆæ“ä½œ
3. âœ… **çŠ¶æ€åŒæ­¥** - åŠæ—¶æ›´æ–°è®¢å•çŠ¶æ€

---

### 1ï¸âƒ£ æ”¯ä»˜è¶…æ—¶å€’è®¡æ—¶ï¼ˆ15åˆ†é’Ÿï¼‰

#### åœºæ™¯
ç”¨æˆ·åˆ›å»ºè®¢å•åæœªæ”¯ä»˜ï¼Œ15åˆ†é’Ÿåè‡ªåŠ¨å–æ¶ˆ

#### å‰ç«¯å®ç°

```javascript
// pages/order/detail.js
Page({
  data: {
    order: null,
    remainingSeconds: 0,
    countdownTimer: null
  },

  onLoad(options) {
    this.setData({ orderId: options.id });
    this.loadOrderDetail();
  },

  async loadOrderDetail() {
    const res = await getOrderDetail(this.data.orderId);
    if (res.code === 200) {
      this.setData({ order: res.data });
      
      // å¦‚æœæ˜¯å¾…æ”¯ä»˜çŠ¶æ€ï¼Œå¯åŠ¨å€’è®¡æ—¶
      if (res.data.status === 'PENDING_PAYMENT') {
        this.startPaymentCountdown();
      }
    }
  },

  /**
   * å¯åŠ¨æ”¯ä»˜å€’è®¡æ—¶
   */
  startPaymentCountdown() {
    const createTime = new Date(this.data.order.createTime).getTime();
    const timeoutMinutes = 15; // 15åˆ†é’Ÿ
    const deadline = createTime + timeoutMinutes * 60 * 1000;
    
    // ç«‹å³è®¡ç®—ä¸€æ¬¡
    this.updateCountdown(deadline);
    
    // æ¯ç§’æ›´æ–°
    this.data.countdownTimer = setInterval(() => {
      this.updateCountdown(deadline);
    }, 1000);
  },

  /**
   * æ›´æ–°å€’è®¡æ—¶
   */
  updateCountdown(deadline) {
    const now = Date.now();
    const remaining = Math.max(0, deadline - now);
    
    this.setData({
      remainingSeconds: Math.floor(remaining / 1000)
    });
    
    // å€’è®¡æ—¶ç»“æŸ
    if (remaining <= 0) {
      this.clearCountdown();
      this.showTimeoutTip();
      this.loadOrderDetail(); // é‡æ–°åŠ è½½è®¢å•çŠ¶æ€
    }
    
    // æœ€å1åˆ†é’Ÿè­¦å‘Š
    if (remaining <= 60000 && remaining > 59000) {
      wx.showToast({
        title: 'è®¢å•å³å°†è¶…æ—¶ï¼Œè¯·å°½å¿«æ”¯ä»˜',
        icon: 'none',
        duration: 3000
      });
    }
  },

  /**
   * æ ¼å¼åŒ–å€’è®¡æ—¶æ˜¾ç¤º
   */
  formatCountdown(seconds) {
    const minutes = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
  },

  /**
   * æ¸…é™¤å€’è®¡æ—¶
   */
  clearCountdown() {
    if (this.data.countdownTimer) {
      clearInterval(this.data.countdownTimer);
      this.data.countdownTimer = null;
    }
  },

  /**
   * æ˜¾ç¤ºè¶…æ—¶æç¤º
   */
  showTimeoutTip() {
    wx.showModal({
      title: 'è®¢å•å·²è¶…æ—¶',
      content: 'è®¢å•å·²å› æ”¯ä»˜è¶…æ—¶è‡ªåŠ¨å–æ¶ˆï¼Œè¯·é‡æ–°ä¸‹å•',
      showCancel: false,
      confirmText: 'çŸ¥é“äº†',
      success: () => {
        wx.navigateBack();
      }
    });
  },

  onUnload() {
    this.clearCountdown();
  }
});
```

#### WXML æ¨¡æ¿

```html
<!-- å¾…æ”¯ä»˜å€’è®¡æ—¶ -->
<view wx:if="{{order.status === 'PENDING_PAYMENT'}}" class="payment-countdown">
  <view class="countdown-bar">
    <text class="icon">â°</text>
    <text class="text">è¯·åœ¨ {{ formatCountdown(remainingSeconds) }} å†…å®Œæˆæ”¯ä»˜</text>
  </view>
  <view class="countdown-progress">
    <view class="progress-bar" style="width: {{remainingSeconds / 900 * 100}}%"></view>
  </view>
  <button bindtap="goPay" class="pay-btn">ç«‹å³æ”¯ä»˜</button>
</view>

<!-- æ”¯ä»˜è¶…æ—¶å–æ¶ˆæç¤º -->
<view wx:if="{{order.status === 'CANCELLED' && order.cancelReason === 'SYSTEM_PAYMENT_TIMEOUT'}}" 
      class="cancel-tip">
  <view class="tip-icon">âŒ</view>
  <text class="tip-text">è®¢å•å·²å› æ”¯ä»˜è¶…æ—¶è‡ªåŠ¨å–æ¶ˆ</text>
  <text class="tip-desc">æ‚¨å¯ä»¥é‡æ–°ä¸‹å•</text>
</view>
```

#### WXSS æ ·å¼

```css
.payment-countdown {
  background: linear-gradient(135deg, #fff5f5 0%, #ffe5e5 100%);
  border-radius: 16rpx;
  padding: 30rpx;
  margin: 20rpx;
}

.countdown-bar {
  display: flex;
  align-items: center;
  margin-bottom: 20rpx;
}

.countdown-bar .icon {
  font-size: 40rpx;
  margin-right: 16rpx;
}

.countdown-bar .text {
  flex: 1;
  font-size: 28rpx;
  color: #ff4d4f;
  font-weight: bold;
}

.countdown-progress {
  height: 8rpx;
  background: #fff;
  border-radius: 4rpx;
  overflow: hidden;
  margin-bottom: 20rpx;
}

.progress-bar {
  height: 100%;
  background: linear-gradient(90deg, #ff6b6b, #ff8787);
  transition: width 1s linear;
}

.pay-btn {
  width: 100%;
  height: 80rpx;
  background: linear-gradient(135deg, #ff6b6b 0%, #ff8787 100%);
  color: #fff;
  border-radius: 40rpx;
  font-size: 30rpx;
  line-height: 80rpx;
  text-align: center;
  border: none;
}

.cancel-tip {
  background: #fff;
  border-radius: 16rpx;
  padding: 40rpx;
  margin: 20rpx;
  text-align: center;
}

.tip-icon {
  font-size: 80rpx;
  margin-bottom: 20rpx;
}

.tip-text {
  display: block;
  font-size: 32rpx;
  color: #333;
  margin-bottom: 10rpx;
}

.tip-desc {
  display: block;
  font-size: 26rpx;
  color: #999;
}
```

---

### 2ï¸âƒ£ æ¥å•è¶…æ—¶æç¤ºï¼ˆ30åˆ†é’Ÿï¼‰

#### åœºæ™¯
ç”¨æˆ·æ”¯ä»˜åï¼Œ30åˆ†é’Ÿå†…æ— é˜¿å§¨æ¥å•ï¼Œè‡ªåŠ¨å–æ¶ˆå¹¶é€€æ¬¾

#### å‰ç«¯å®ç°

```javascript
// pages/order/detail.js
Page({
  data: {
    order: null,
    searchingStaff: false,
    searchDuration: 0
  },

  onLoad() {
    // ...
    this.checkOrderStatus();
  },

  /**
   * å®šæœŸæ£€æŸ¥è®¢å•çŠ¶æ€
   */
  checkOrderStatus() {
    // å¦‚æœæ˜¯å¾…æ¥å•çŠ¶æ€ï¼Œæ¯10ç§’æ£€æŸ¥ä¸€æ¬¡
    if (this.data.order.status === 'PENDING') {
      this.setData({ searchingStaff: true });
      this.startStatusPolling();
    }
  },

  /**
   * å¼€å§‹è½®è¯¢è®¢å•çŠ¶æ€
   */
  startStatusPolling() {
    this.statusTimer = setInterval(async () => {
      const res = await getOrderDetail(this.data.orderId);
      
      if (res.code === 200) {
        const newStatus = res.data.status;
        
        // çŠ¶æ€å˜åŒ–
        if (newStatus !== this.data.order.status) {
          this.setData({ order: res.data });
          
          // å·²æ¥å•
          if (newStatus === 'ACCEPTED') {
            this.stopStatusPolling();
            wx.showToast({
              title: 'é˜¿å§¨å·²æ¥å•',
              icon: 'success'
            });
          }
          
          // å·²å–æ¶ˆï¼ˆæ— äººæ¥å•è¶…æ—¶ï¼‰
          if (newStatus === 'CANCELLED' && res.data.cancelReason === 'SYSTEM_NO_STAFF') {
            this.stopStatusPolling();
            this.showNoStaffTip();
          }
        }
        
        // æ›´æ–°ç­‰å¾…æ—¶é•¿
        this.setData({
          searchDuration: this.data.searchDuration + 10
        });
      }
    }, 10000); // æ¯10ç§’
  },

  /**
   * åœæ­¢è½®è¯¢
   */
  stopStatusPolling() {
    if (this.statusTimer) {
      clearInterval(this.statusTimer);
      this.statusTimer = null;
    }
    this.setData({ searchingStaff: false });
  },

  /**
   * æ˜¾ç¤ºæ— äººæ¥å•æç¤º
   */
  showNoStaffTip() {
    wx.showModal({
      title: 'æš‚æ— é˜¿å§¨æ¥å•',
      content: 'å¾ˆæŠ±æ­‰ï¼Œæš‚æ—¶æ²¡æœ‰åˆé€‚çš„é˜¿å§¨æ¥å•ã€‚è®¢å•å·²è‡ªåŠ¨å–æ¶ˆï¼Œæ¬¾é¡¹å°†åœ¨1-7ä¸ªå·¥ä½œæ—¥é€€å›ã€‚',
      confirmText: 'æŸ¥çœ‹é€€æ¬¾',
      cancelText: 'é‡æ–°ä¸‹å•',
      success: (res) => {
        if (res.confirm) {
          // è·³è½¬åˆ°é€€æ¬¾è¯¦æƒ…
          this.viewRefund();
        } else {
          // é‡æ–°ä¸‹å•
          wx.navigateBack();
        }
      }
    });
  },

  onUnload() {
    this.stopStatusPolling();
  }
});
```

#### WXML æ¨¡æ¿

```html
<!-- ç­‰å¾…æ¥å•ä¸­ -->
<view wx:if="{{order.status === 'PENDING'}}" class="searching-staff">
  <view class="loading-icon">
    <image src="/images/searching.gif" class="gif"></image>
  </view>
  <text class="searching-text">æ­£åœ¨ä¸ºæ‚¨å¯»æ‰¾é™„è¿‘çš„é˜¿å§¨...</text>
  <text class="searching-time">å·²ç­‰å¾… {{Math.floor(searchDuration / 60)}} åˆ†é’Ÿ</text>
</view>

<!-- æ— äººæ¥å•è¶…æ—¶å–æ¶ˆ -->
<view wx:if="{{order.status === 'CANCELLED' && order.cancelReason === 'SYSTEM_NO_STAFF'}}" 
      class="cancel-tip">
  <view class="tip-icon">ğŸ˜”</view>
  <text class="tip-text">æš‚æ— é˜¿å§¨æ¥å•</text>
  <text class="tip-desc">è®¢å•å·²è‡ªåŠ¨å–æ¶ˆï¼Œæ¬¾é¡¹å°†åœ¨1-7ä¸ªå·¥ä½œæ—¥é€€å›</text>
  <button bindtap="viewRefund" class="view-refund-btn">æŸ¥çœ‹é€€æ¬¾è¯¦æƒ…</button>
</view>
```

---

### 3ï¸âƒ£ æœåŠ¡è¶…æ—¶å¼‚å¸¸ï¼ˆé¢„çº¦æ—¶é—´+1å°æ—¶ï¼‰

#### åœºæ™¯
é˜¿å§¨æ¥å•åï¼Œé¢„çº¦æ—¶é—´å·²è¿‡1å°æ—¶ä»æœªå¼€å§‹æœåŠ¡ï¼Œè‡ªåŠ¨å–æ¶ˆå¹¶é€€æ¬¾

#### å‰ç«¯å®ç°

```javascript
// æœåŠ¡è¶…æ—¶æ£€æŸ¥
Page({
  checkServiceTimeout() {
    const { order } = this.data;
    
    if (order.status === 'ACCEPTED') {
      const serviceTime = new Date(order.serviceTime).getTime();
      const now = Date.now();
      const hoursPassed = (now - serviceTime) / (1000 * 60 * 60);
      
      // è¶…è¿‡é¢„çº¦æ—¶é—´1å°æ—¶
      if (hoursPassed > 1) {
        wx.showModal({
          title: 'æœåŠ¡æ—¶é—´å·²è¿‡',
          content: 'é¢„çº¦æ—¶é—´å·²è¿‡å»1å°æ—¶ï¼Œé˜¿å§¨ä»æœªå¼€å§‹æœåŠ¡ã€‚æ‚¨å¯ä»¥è”ç³»å®¢æœå¤„ç†æˆ–ç­‰å¾…ç³»ç»Ÿè‡ªåŠ¨å–æ¶ˆã€‚',
          confirmText: 'è”ç³»å®¢æœ',
          cancelText: 'ç­‰å¾…å¤„ç†',
          success: (res) => {
            if (res.confirm) {
              this.contactService();
            }
          }
        });
      }
    }
  }
});
```

#### WXML æ¨¡æ¿

```html
<!-- æœåŠ¡è¶…æ—¶å–æ¶ˆ -->
<view wx:if="{{order.status === 'CANCELLED' && order.cancelReason === 'SYSTEM_TIMEOUT'}}" 
      class="cancel-tip">
  <view class="tip-icon">âš ï¸</view>
  <text class="tip-text">æœåŠ¡è¶…æ—¶å·²è‡ªåŠ¨å–æ¶ˆ</text>
  <text class="tip-desc">é˜¿å§¨æœªåœ¨é¢„çº¦æ—¶é—´å¼€å§‹æœåŠ¡ï¼Œè®¢å•å·²è‡ªåŠ¨å–æ¶ˆå¹¶å…¨é¢é€€æ¬¾</text>
  <button bindtap="viewRefund" class="view-refund-btn">æŸ¥çœ‹é€€æ¬¾è¯¦æƒ…</button>
  <button bindtap="contactService" class="contact-btn">è”ç³»å®¢æœ</button>
</view>
```

---

### ğŸ“Š è¶…æ—¶å–æ¶ˆåŸå› æ˜ å°„

```javascript
/**
 * è·å–å–æ¶ˆåŸå› çš„å‹å¥½æè¿°
 */
function getCancelReasonDesc(cancelReason) {
  const reasonMap = {
    'SYSTEM_PAYMENT_TIMEOUT': {
      title: 'æ”¯ä»˜è¶…æ—¶',
      desc: 'è®¢å•å·²å› æ”¯ä»˜è¶…æ—¶è‡ªåŠ¨å–æ¶ˆ',
      icon: 'â°',
      color: '#faad14'
    },
    'SYSTEM_NO_STAFF': {
      title: 'æš‚æ— é˜¿å§¨æ¥å•',
      desc: 'è®¢å•å·²è‡ªåŠ¨å–æ¶ˆï¼Œæ¬¾é¡¹å°†åœ¨1-7ä¸ªå·¥ä½œæ—¥é€€å›',
      icon: 'ğŸ˜”',
      color: '#999'
    },
    'SYSTEM_TIMEOUT': {
      title: 'æœåŠ¡è¶…æ—¶',
      desc: 'é˜¿å§¨æœªåœ¨é¢„çº¦æ—¶é—´å¼€å§‹æœåŠ¡ï¼Œè®¢å•å·²è‡ªåŠ¨å–æ¶ˆå¹¶å…¨é¢é€€æ¬¾',
      icon: 'âš ï¸',
      color: '#ff4d4f'
    }
  };
  
  return reasonMap[cancelReason] || {
    title: 'è®¢å•å·²å–æ¶ˆ',
    desc: 'è®¢å•å·²å–æ¶ˆ',
    icon: 'âŒ',
    color: '#999'
  };
}
```

---

### ğŸ”” ç”¨æˆ·é€šçŸ¥å»ºè®®

#### 1. æ”¯ä»˜è¶…æ—¶æé†’
```javascript
// å€’è®¡æ—¶è¿˜å‰©5åˆ†é’Ÿæ—¶ï¼Œå‘é€æ¶ˆæ¯æé†’
if (remainingSeconds === 300) {
  wx.showToast({
    title: 'è¿˜æœ‰5åˆ†é’Ÿæ”¯ä»˜è¶…æ—¶ï¼Œè¯·å°½å¿«å®Œæˆæ”¯ä»˜',
    icon: 'none',
    duration: 3000
  });
}
```

#### 2. æ¥å•è¿›åº¦æé†’
```javascript
// æ¯5åˆ†é’Ÿæç¤ºä¸€æ¬¡
if (searchDuration % 300 === 0 && searchDuration > 0) {
  wx.showToast({
    title: `å·²ç­‰å¾…${Math.floor(searchDuration / 60)}åˆ†é’Ÿï¼Œç»§ç»­ä¸ºæ‚¨å¯»æ‰¾é˜¿å§¨...`,
    icon: 'none'
  });
}
```

#### 3. æœåŠ¡æ—¶é—´æé†’
```javascript
// é¢„çº¦æ—¶é—´å‰30åˆ†é’Ÿæé†’
const serviceTime = new Date(order.serviceTime).getTime();
const now = Date.now();
if (serviceTime - now <= 1800000 && serviceTime - now > 1790000) {
  wx.showToast({
    title: 'æœåŠ¡æ—¶é—´å³å°†åˆ°æ¥ï¼Œè¯·åšå¥½å‡†å¤‡',
    icon: 'none'
  });
}
```

---

### âš™ï¸ é…ç½®å»ºè®®

åœ¨å°ç¨‹åºé…ç½®æ–‡ä»¶ä¸­å®šä¹‰è¶…æ—¶æ—¶é—´ï¼ˆä¸åç«¯ä¿æŒä¸€è‡´ï¼‰ï¼š

```javascript
// config.js
export default {
  // è¶…æ—¶æ—¶é—´é…ç½®ï¼ˆåˆ†é’Ÿï¼‰
  timeout: {
    payment: 15,      // æ”¯ä»˜è¶…æ—¶
    accept: 30,       // æ¥å•è¶…æ—¶
    serviceHours: 1   // æœåŠ¡è¶…æ—¶ï¼ˆå°æ—¶ï¼‰
  },
  
  // çŠ¶æ€è½®è¯¢é—´éš”ï¼ˆç§’ï¼‰
  polling: {
    payment: 10,      // å¾…æ”¯ä»˜çŠ¶æ€
    pending: 10,      // å¾…æ¥å•çŠ¶æ€
    accepted: 30      // å·²æ¥å•çŠ¶æ€
  }
}
```

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·è”ç³»åç«¯å¼€å‘å›¢é˜Ÿæˆ–æŸ¥çœ‹å®Œæ•´APIæ–‡æ¡£ï¼š`å°ç¨‹åºAPIæ¥å£æ–‡æ¡£.md` ç¬¬5.8ã€5.9èŠ‚ã€‚

