# å®¶æ”¿å¹³å°è¯„ä»·è¯„åˆ†ä½“ç³»å®Œæ•´è®¾è®¡æ–‡æ¡£

> **æ–‡æ¡£çŠ¶æ€**: âœ… å·²å®ç°æ ¸å¿ƒåŠŸèƒ½  
> **æœ€åæ›´æ–°**: 2025-10-13  
> **å®ç°è¿›åº¦**: æ ¸å¿ƒåŠŸèƒ½ 100% | å¢å¼ºåŠŸèƒ½ 85%

## ğŸ“‹ ç›®å½•

1. [ç³»ç»Ÿæ¦‚è¿°](#ç³»ç»Ÿæ¦‚è¿°)
2. [æ•°æ®åº“è®¾è®¡](#æ•°æ®åº“è®¾è®¡)
3. [ä¸šåŠ¡é€»è¾‘è®¾è®¡](#ä¸šåŠ¡é€»è¾‘è®¾è®¡)
4. [æ¥å£è®¾è®¡](#æ¥å£è®¾è®¡)
5. [å‰ç«¯äº¤äº’æµç¨‹](#å‰ç«¯äº¤äº’æµç¨‹)
6. [è¯„åˆ†è®¡ç®—è§„åˆ™](#è¯„åˆ†è®¡ç®—è§„åˆ™)
7. [å®šæ—¶ä»»åŠ¡è®¾è®¡](#å®šæ—¶ä»»åŠ¡è®¾è®¡)
8. [å®ç°æ¸…å•](#å®ç°æ¸…å•)
9. [éƒ¨ç½²è¯´æ˜](#éƒ¨ç½²è¯´æ˜)
10. [å·²çŸ¥é—®é¢˜](#å·²çŸ¥é—®é¢˜)

---

## ç³»ç»Ÿæ¦‚è¿°

### ğŸ¯ è®¾è®¡ç›®æ ‡

æ„å»ºä¸€ä¸ªå®Œæ•´çš„ä¸‰çº§è¯„ä»·è¯„åˆ†ä½“ç³»ï¼š
1. **ç”¨æˆ·è¯„ä»·è®¢å•** â†’ å¯¹å•æ¬¡æœåŠ¡è¿›è¡Œè¯„ä»·
2. **å•†å“è¯„åˆ†** â†’ åŸºäºæ‰€æœ‰è®¢å•è¯„ä»·è®¡ç®—å•†å“å¹³å‡åˆ†
3. **é˜¿å§¨è¯„åˆ†** â†’ åŸºäºæ‰€æœ‰è®¢å•è¯„ä»·è®¡ç®—é˜¿å§¨æœåŠ¡è´¨é‡è¯„åˆ†

### ğŸ“Š æ ¸å¿ƒæŒ‡æ ‡

| è¯„ä»·å¯¹è±¡ | è¯„åˆ†èŒƒå›´ | æ›´æ–°é¢‘ç‡ | æ•°æ®æ¥æº |
|---------|---------|---------|---------|
| è®¢å•è¯„ä»· | 1-5åˆ† | å®æ—¶ | ç”¨æˆ·æäº¤ |
| å•†å“è¯„åˆ† | 1.0-5.0åˆ† | æ¯10åˆ†é’Ÿ | è®¢å•è¯„ä»·èšåˆ |
| é˜¿å§¨è¯„åˆ† | 1.0-5.0åˆ† | æ¯10åˆ†é’Ÿ | è®¢å•è¯„ä»·èšåˆ |

### ğŸ”„ æ•°æ®æµè½¬

```
ç”¨æˆ·æäº¤è¯„ä»·
    â†“
è®¢å•è¯„ä»·è¡¨ (order_rating)
    â†“
å®šæ—¶ä»»åŠ¡èšåˆè®¡ç®—
    â†“         â†“
å•†å“è¯„åˆ†æ›´æ–°  é˜¿å§¨è¯„åˆ†æ›´æ–°
(productè¡¨)  (staffè¡¨)
```

---

## æ•°æ®åº“è®¾è®¡

> **å®ç°çŠ¶æ€**: âœ… å·²å®Œæˆ  
> **SQLè„šæœ¬**: `jiayou-admin-service/src/main/resources/sql/6.rating_system.sql`

### 1. è®¢å•è¯„ä»·è¡¨ (order_rating)

**å®ç°çŠ¶æ€**: âœ… å·²å®Œæˆï¼ˆå«ä¿®æ”¹/åˆ é™¤ä¼˜åŒ–ï¼‰

**SQLè„šæœ¬**:
- åŸºç¡€ç»“æ„ï¼š`6.rating_system.sql`
- ä¿®æ”¹/åˆ é™¤ä¼˜åŒ–ï¼š`7.rating_edit_delete_optimization.sql`

**è¡¨ç»“æ„ä¼˜åŒ–**ï¼š

```sql
-- ========================================
-- è®¢å•è¯„ä»·è¡¨ç»“æ„ä¼˜åŒ–ï¼ˆåŸºç¡€å­—æ®µï¼‰
-- ========================================

-- 1. æ·»åŠ ç¼ºå¤±å­—æ®µ
ALTER TABLE `order_rating`
ADD COLUMN `product_id` BIGINT(20) NULL COMMENT 'å•†å“ID' AFTER `user_id`,
ADD COLUMN `content` VARCHAR(1000) NULL COMMENT 'è¯„ä»·å†…å®¹' AFTER `score`,
ADD COLUMN `images` VARCHAR(1000) NULL COMMENT 'è¯„ä»·å›¾ç‰‡JSONæ•°ç»„' AFTER `content`,
ADD COLUMN `status` VARCHAR(20) DEFAULT 'PUBLISHED' COMMENT 'è¯„ä»·çŠ¶æ€: DRAFT-è‰ç¨¿, PUBLISHED-å·²å‘å¸ƒ, HIDDEN-å·²éšè—, DELETED-å·²åˆ é™¤' AFTER `images`,
ADD COLUMN `is_anonymous` TINYINT(1) DEFAULT 0 COMMENT 'æ˜¯å¦åŒ¿å: 0-å¦, 1-æ˜¯' AFTER `status`,
ADD COLUMN `reply_content` VARCHAR(500) NULL COMMENT 'å•†å®¶å›å¤å†…å®¹' AFTER `is_anonymous`,
ADD COLUMN `reply_time` DATETIME NULL COMMENT 'å•†å®¶å›å¤æ—¶é—´' AFTER `reply_content`;

-- 2. æ·»åŠ è¯¦ç»†è¯„åˆ†ç»´åº¦
ALTER TABLE `order_rating`
ADD COLUMN `service_attitude_score` TINYINT(1) NULL COMMENT 'æœåŠ¡æ€åº¦è¯„åˆ†: 1-5' AFTER `score`,
ADD COLUMN `service_quality_score` TINYINT(1) NULL COMMENT 'æœåŠ¡è´¨é‡è¯„åˆ†: 1-5' AFTER `service_attitude_score`,
ADD COLUMN `punctuality_score` TINYINT(1) NULL COMMENT 'å‡†æ—¶æ€§è¯„åˆ†: 1-5' AFTER `service_quality_score`,
ADD COLUMN `cleanliness_score` TINYINT(1) NULL COMMENT 'æ¸…æ´åº¦è¯„åˆ†: 1-5' AFTER `punctuality_score`;

-- 3. æ·»åŠ æ ‡ç­¾å­—æ®µ
ALTER TABLE `order_rating`
ADD COLUMN `tags` VARCHAR(500) NULL COMMENT 'è¯„ä»·æ ‡ç­¾JSONæ•°ç»„ï¼Œå¦‚["æœåŠ¡å¥½","å¾ˆä¸“ä¸š","å‡†æ—¶"]' AFTER `cleanliness_score`;

-- 4. æ·»åŠ ä¿®æ”¹/åˆ é™¤ç›¸å…³å­—æ®µï¼ˆv1.1.0 æ–°å¢ï¼‰
ALTER TABLE `order_rating`
ADD COLUMN `edit_count` INT DEFAULT 0 COMMENT 'ä¿®æ”¹æ¬¡æ•°' AFTER `status`,
ADD COLUMN `edit_time` DATETIME NULL COMMENT 'æœ€åç¼–è¾‘æ—¶é—´' AFTER `edit_count`,
ADD COLUMN `deleted_time` DATETIME NULL COMMENT 'åˆ é™¤æ—¶é—´' AFTER `edit_time`;

-- 5. æ·»åŠ ç´¢å¼•
ALTER TABLE `order_rating`
ADD INDEX `idx_product_id` (`product_id`),
ADD INDEX `idx_status` (`status`),
ADD INDEX `idx_created_time` (`created_time`),
ADD INDEX `idx_edit_count` (`edit_count`);
```

**å…³é”®å­—æ®µè¯´æ˜**:
- `status`: æ–°å¢ `DELETED` çŠ¶æ€ï¼Œç”¨äºé€»è¾‘åˆ é™¤
- `edit_count`: è®°å½•ä¿®æ”¹æ¬¡æ•°ï¼Œé™åˆ¶ä¸º1æ¬¡
- `edit_time`: è®°å½•æœ€åç¼–è¾‘æ—¶é—´ï¼Œç”¨äºæ˜¾ç¤º"å·²ç¼–è¾‘"æ ‡ç­¾
- `deleted_time`: è®°å½•åˆ é™¤æ—¶é—´ï¼Œç”¨äºæ•°æ®åˆ†æ

### 2. å•†å“è¡¨ (product)

**å®ç°çŠ¶æ€**: âœ… å·²å®Œæˆ

**å·²æ·»åŠ è¯„åˆ†å­—æ®µ**ï¼š

```sql
-- product è¡¨å·²æœ‰å­—æ®µ
-- rating DECIMAL(3,1) DEFAULT 5.0 COMMENT 'å•†å“è¯„åˆ†ï¼ˆ1.0-5.0ï¼‰'
-- review_count INT DEFAULT 0 COMMENT 'è¯„ä»·æ•°é‡'
```

### 3. é˜¿å§¨è¡¨ (staff)

**å®ç°çŠ¶æ€**: âœ… å·²å®Œæˆ

**æ·»åŠ è¯„åˆ†å­—æ®µ**ï¼š

```sql
-- ========================================
-- é˜¿å§¨è¡¨è¯„åˆ†å­—æ®µ
-- ========================================

ALTER TABLE `staff`
ADD COLUMN IF NOT EXISTS `rating` DECIMAL(3,1) DEFAULT 5.0 COMMENT 'é˜¿å§¨è¯„åˆ†ï¼ˆ1.0-5.0ï¼‰' AFTER `status`,
ADD COLUMN IF NOT EXISTS `review_count` INT DEFAULT 0 COMMENT 'è¯„ä»·æ•°é‡' AFTER `rating`,
ADD COLUMN IF NOT EXISTS `service_attitude_rating` DECIMAL(3,1) DEFAULT 5.0 COMMENT 'æœåŠ¡æ€åº¦è¯„åˆ†' AFTER `review_count`,
ADD COLUMN IF NOT EXISTS `service_quality_rating` DECIMAL(3,1) DEFAULT 5.0 COMMENT 'æœåŠ¡è´¨é‡è¯„åˆ†' AFTER `service_attitude_rating`,
ADD COLUMN IF NOT EXISTS `punctuality_rating` DECIMAL(3,1) DEFAULT 5.0 COMMENT 'å‡†æ—¶æ€§è¯„åˆ†' AFTER `service_quality_rating`,
ADD COLUMN IF NOT EXISTS `cleanliness_rating` DECIMAL(3,1) DEFAULT 5.0 COMMENT 'æ¸…æ´åº¦è¯„åˆ†' AFTER `punctuality_rating`;

-- æ·»åŠ ç´¢å¼•
ALTER TABLE `staff`
ADD INDEX IF NOT EXISTS `idx_rating` (`rating`);
```

### 4. è¯„ä»·æ ‡ç­¾è¡¨ (rating_tag)

**å®ç°çŠ¶æ€**: âœ… å·²å®Œæˆï¼ˆåŒ…å«26ä¸ªé¢„è®¾æ ‡ç­¾ï¼‰

**æ–°å¢è¡¨**ï¼š

```sql
-- ========================================
-- è¯„ä»·æ ‡ç­¾è¡¨
-- ========================================

CREATE TABLE IF NOT EXISTS `rating_tag` (
  `id` BIGINT(20) NOT NULL AUTO_INCREMENT COMMENT 'ä¸»é”®ID',
  `tag_name` VARCHAR(50) NOT NULL COMMENT 'æ ‡ç­¾åç§°',
  `tag_type` VARCHAR(20) NOT NULL COMMENT 'æ ‡ç­¾ç±»å‹: POSITIVE-æ­£é¢, NEGATIVE-è´Ÿé¢, NEUTRAL-ä¸­æ€§',
  `category` VARCHAR(20) NOT NULL COMMENT 'æ ‡ç­¾åˆ†ç±»: SERVICE-æœåŠ¡, ATTITUDE-æ€åº¦, QUALITY-è´¨é‡, PUNCTUALITY-å‡†æ—¶æ€§',
  `icon` VARCHAR(200) NULL COMMENT 'æ ‡ç­¾å›¾æ ‡URL',
  `sort_order` INT DEFAULT 0 COMMENT 'æ’åº',
  `is_active` TINYINT(1) DEFAULT 1 COMMENT 'æ˜¯å¦å¯ç”¨: 0-ç¦ç”¨, 1-å¯ç”¨',
  `use_count` INT DEFAULT 0 COMMENT 'ä½¿ç”¨æ¬¡æ•°',
  `created_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  `updated_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_tag_name` (`tag_name`),
  KEY `idx_tag_type` (`tag_type`),
  KEY `idx_category` (`category`),
  KEY `idx_sort_order` (`sort_order`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='è¯„ä»·æ ‡ç­¾è¡¨';

-- åˆå§‹åŒ–æ ‡ç­¾æ•°æ®
INSERT INTO `rating_tag` (`tag_name`, `tag_type`, `category`, `sort_order`) VALUES
-- æ­£é¢æ ‡ç­¾
('æœåŠ¡å¥½', 'POSITIVE', 'SERVICE', 1),
('å¾ˆä¸“ä¸š', 'POSITIVE', 'SERVICE', 2),
('æ€åº¦å¥½', 'POSITIVE', 'ATTITUDE', 3),
('å¾ˆç»†å¿ƒ', 'POSITIVE', 'ATTITUDE', 4),
('è´¨é‡é«˜', 'POSITIVE', 'QUALITY', 5),
('å¾ˆå¹²å‡€', 'POSITIVE', 'QUALITY', 6),
('å‡†æ—¶åˆ°è¾¾', 'POSITIVE', 'PUNCTUALITY', 7),
('æ•ˆç‡é«˜', 'POSITIVE', 'SERVICE', 8),
('å€¼å¾—æ¨è', 'POSITIVE', 'SERVICE', 9),
('ä¼šå†æ¥', 'POSITIVE', 'SERVICE', 10),
-- è´Ÿé¢æ ‡ç­¾
('æœåŠ¡å·®', 'NEGATIVE', 'SERVICE', 11),
('ä¸ä¸“ä¸š', 'NEGATIVE', 'SERVICE', 12),
('æ€åº¦ä¸å¥½', 'NEGATIVE', 'ATTITUDE', 13),
('ä¸ç»†å¿ƒ', 'NEGATIVE', 'ATTITUDE', 14),
('è´¨é‡å·®', 'NEGATIVE', 'QUALITY', 15),
('ä¸å¹²å‡€', 'NEGATIVE', 'QUALITY', 16),
('è¿Ÿåˆ°', 'NEGATIVE', 'PUNCTUALITY', 17),
('æ•ˆç‡ä½', 'NEGATIVE', 'SERVICE', 18);
```

---

## ä¸šåŠ¡é€»è¾‘è®¾è®¡

### 1. ç”¨æˆ·è¯„ä»·è®¢å•æµç¨‹

```
1. ç”¨æˆ·å®Œæˆè®¢å•åï¼Œå¯è¿›è¡Œè¯„ä»·
   â†“
2. æäº¤è¯„ä»·å†…å®¹ï¼š
   - ç»¼åˆè¯„åˆ†ï¼ˆ1-5åˆ†ï¼Œå¿…å¡«ï¼‰
   - è¯¦ç»†è¯„åˆ†ï¼ˆæœåŠ¡æ€åº¦ã€è´¨é‡ã€å‡†æ—¶æ€§ã€æ¸…æ´åº¦ï¼Œå¯é€‰ï¼‰
   - æ–‡å­—è¯„ä»·ï¼ˆå¯é€‰ï¼‰
   - å›¾ç‰‡ï¼ˆæœ€å¤š9å¼ ï¼Œå¯é€‰ï¼‰
   - è¯„ä»·æ ‡ç­¾ï¼ˆå¯é€‰ï¼‰
   - æ˜¯å¦åŒ¿åï¼ˆå¯é€‰ï¼‰
   â†“
3. ç³»ç»ŸéªŒè¯ï¼š
   - è®¢å•æ˜¯å¦å·²å®Œæˆ
   - æ˜¯å¦å·²è¯„ä»·è¿‡
   - è¯„åˆ†èŒƒå›´æ˜¯å¦åˆæ³•
   â†“
4. ä¿å­˜è¯„ä»·è®°å½•
   â†“
5. è§¦å‘å¼‚æ­¥ä»»åŠ¡ï¼š
   - æ›´æ–°å•†å“è¯„åˆ†
   - æ›´æ–°é˜¿å§¨è¯„åˆ†
   - å‘æ”¾ç§¯åˆ†å¥–åŠ±
   - å‘é€é€šçŸ¥ç»™é˜¿å§¨
```

### 2. å•†å“è¯„åˆ†è®¡ç®—é€»è¾‘

**è®¡ç®—å…¬å¼**ï¼š

```
å•†å“è¯„åˆ† = Î£(è®¢å•è¯„ä»·åˆ†æ•°) / è¯„ä»·æ€»æ•°

å…¶ä¸­ï¼š
- åªç»Ÿè®¡çŠ¶æ€ä¸º PUBLISHED çš„è¯„ä»·
- ä¿ç•™1ä½å°æ•°
- å››èˆäº”å…¥
- è¯„åˆ†èŒƒå›´: 1.0 - 5.0
- æ— è¯„ä»·æ—¶é»˜è®¤ 5.0 åˆ†
```

**æ›´æ–°ç­–ç•¥**ï¼š
- å®šæ—¶ä»»åŠ¡ï¼šæ¯10åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡
- å®æ—¶è§¦å‘ï¼šç”¨æˆ·æäº¤è¯„ä»·åç«‹å³æ›´æ–°ï¼ˆå¯é€‰ï¼‰

### 3. é˜¿å§¨è¯„åˆ†è®¡ç®—é€»è¾‘

**ç»¼åˆè¯„åˆ†è®¡ç®—**ï¼š

```
é˜¿å§¨ç»¼åˆè¯„åˆ† = Î£(è®¢å•è¯„ä»·åˆ†æ•°) / è¯„ä»·æ€»æ•°
```

**è¯¦ç»†è¯„åˆ†è®¡ç®—**ï¼š

```
æœåŠ¡æ€åº¦è¯„åˆ† = Î£(service_attitude_score) / æœ‰æ•ˆè¯„ä»·æ•°
æœåŠ¡è´¨é‡è¯„åˆ† = Î£(service_quality_score) / æœ‰æ•ˆè¯„ä»·æ•°
å‡†æ—¶æ€§è¯„åˆ† = Î£(punctuality_score) / æœ‰æ•ˆè¯„ä»·æ•°
æ¸…æ´åº¦è¯„åˆ† = Î£(cleanliness_score) / æœ‰æ•ˆè¯„ä»·æ•°
```

**æ›´æ–°ç­–ç•¥**ï¼š
- å®šæ—¶ä»»åŠ¡ï¼šæ¯10åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡
- å®æ—¶è§¦å‘ï¼šç”¨æˆ·æäº¤è¯„ä»·åç«‹å³æ›´æ–°ï¼ˆå¯é€‰ï¼‰

### 4. è¯„ä»·å¥–åŠ±æœºåˆ¶

**å®ç°çŠ¶æ€**: âœ… å·²å®Œæˆ

**å¥–åŠ±è§„åˆ™**:

| è¡Œä¸º | å¥–åŠ±ç§¯åˆ† | æ¡ä»¶ |
|-----|---------|------|
| åŸºç¡€è¯„ä»· | 5ç§¯åˆ† | æäº¤è¯„ä»· |
| æ–‡å­—è¯„ä»· | 10ç§¯åˆ† | æ–‡å­—è¯„ä»· â‰¥ 10å­— |
| ä¸Šä¼ å›¾ç‰‡ | 5ç§¯åˆ† | è‡³å°‘1å¼ å›¾ç‰‡ |
| è¯¦ç»†è¯„åˆ† | 5ç§¯åˆ† | å¡«å†™æ‰€æœ‰è¯¦ç»†è¯„åˆ† |
| ä¼˜è´¨è¯„ä»· | 20ç§¯åˆ† | æ–‡å­— â‰¥ 50å­— + å›¾ç‰‡ â‰¥ 3å¼ ï¼ˆæ›¿ä»£å…¶ä»–å¥–åŠ±ï¼‰ |

**å®ç°ä»£ç **:

```java
private int calculatePointsReward(OrderRatingRequest request) {
    int points = 5; // åŸºç¡€è¯„ä»·å¥–åŠ±
    
    // æ–‡å­—è¯„ä»·å¥–åŠ±ï¼ˆ10å­—ä»¥ä¸Šï¼‰
    if (request.getContent() != null && request.getContent().length() >= 10) {
        points += 10;
    }
    
    // å›¾ç‰‡å¥–åŠ±ï¼ˆè‡³å°‘1å¼ ï¼‰
    if (request.getImages() != null && !request.getImages().isEmpty()) {
        points += 5;
    }
    
    // è¯¦ç»†è¯„åˆ†å¥–åŠ±ï¼ˆå¡«å†™æ‰€æœ‰è¯¦ç»†è¯„åˆ†ï¼‰
    if (request.getServiceAttitudeScore() != null &&
        request.getServiceQualityScore() != null &&
        request.getPunctualityScore() != null &&
        request.getCleanlinessScore() != null) {
        points += 5;
    }
    
    // ä¼˜è´¨è¯„ä»·å¥–åŠ±ï¼ˆ50å­—ä»¥ä¸Š + 3å¼ å›¾ç‰‡ä»¥ä¸Šï¼‰
    if (request.getContent() != null && request.getContent().length() >= 50 &&
        request.getImages() != null && request.getImages().size() >= 3) {
        return 20; // ä¼˜è´¨è¯„ä»·æ›¿ä»£å…¶ä»–å¥–åŠ±
    }
    
    return points;
}
```

**ç§¯åˆ†å‘æ”¾**:
- é€šè¿‡ `UserPointsService.addPoints()` æ–¹æ³•å‘æ”¾
- ç§¯åˆ†æ¥æºæ ‡è®°ä¸º `RATING_REWARD`
- æè¿°ä¸º "è®¢å•è¯„ä»·"

---

## æ¥å£è®¾è®¡

> **å®ç°çŠ¶æ€**: æ ¸å¿ƒæ¥å£å·²å®Œæˆ  
> **Controller**: `UserRatingController.java`, `StaffRatingController.java`  
> **Service**: `OrderRatingServiceImpl.java`, `RatingTagServiceImpl.java`

### ç”¨æˆ·ç«¯æ¥å£

#### 1. æäº¤è®¢å•è¯„ä»·

**å®ç°çŠ¶æ€**: âœ… å·²å®Œæˆ

**æ¥å£**: `POST /user/order/{orderId}/rating`

**æè¿°**: ç”¨æˆ·å¯¹å·²å®Œæˆçš„è®¢å•è¿›è¡Œè¯„ä»·

**æƒé™**: éœ€è¦ç”¨æˆ·ç™»å½•ï¼ˆé€šè¿‡ `MiniThreadLocal.getUserId()` è·å–ï¼‰

**è¯·æ±‚ä½“**: OrderRatingRequest
```json
{
  "score": 5,
  "content": "æœåŠ¡å¾ˆå¥½ï¼Œé˜¿å§¨å¾ˆä¸“ä¸šï¼Œå®¶é‡Œæ‰“æ‰«å¾—å¾ˆå¹²å‡€",
  "images": [
    "https://example.com/image1.jpg",
    "https://example.com/image2.jpg"
  ],
  "serviceAttitudeScore": 5,
  "serviceQualityScore": 5,
  "punctualityScore": 5,
  "cleanlinessScore": 5,
  "tags": ["æœåŠ¡å¥½", "å¾ˆä¸“ä¸š", "å‡†æ—¶åˆ°è¾¾"],
  "isAnonymous": false
}
```

**å“åº”**:
```json
{
  "code": 200,
  "message": "è¯„ä»·æˆåŠŸ",
  "data": {
    "ratingId": 123,
    "pointsReward": 20,
    "rewardReason": "ä¼˜è´¨è¯„ä»·å¥–åŠ±"
  }
}
```

#### 2. è·å–è®¢å•è¯„ä»·è¯¦æƒ…

**å®ç°çŠ¶æ€**: âœ… å·²å®Œæˆ

**æ¥å£**: `GET /user/order/{orderId}/rating`

**æè¿°**: è·å–æŒ‡å®šè®¢å•çš„è¯„ä»·è¯¦æƒ…

**æƒé™**: éœ€è¦ç”¨æˆ·ç™»å½•

**å“åº”**:
```json
{
  "code": 200,
  "message": "è·å–æˆåŠŸ",
  "data": {
    "id": 123,
    "orderId": 456,
    "orderNo": "JY202410130001",
    "score": 5,
    "content": "æœåŠ¡å¾ˆå¥½ï¼Œé˜¿å§¨å¾ˆä¸“ä¸š",
    "images": ["url1", "url2"],
    "serviceAttitudeScore": 5,
    "serviceQualityScore": 5,
    "punctualityScore": 5,
    "cleanlinessScore": 5,
    "tags": ["æœåŠ¡å¥½", "å¾ˆä¸“ä¸š"],
    "isAnonymous": false,
    "status": "PUBLISHED",
    "replyContent": "æ„Ÿè°¢æ‚¨çš„å¥½è¯„",
    "replyTime": "2024-10-13T15:00:00",
    "createdTime": "2024-10-13T14:00:00",
    "staffInfo": {
      "staffId": 789,
      "staffName": "å¼ é˜¿å§¨",
      "avatar": "https://example.com/avatar.jpg"
    }
  }
}
```

#### 3. ä¿®æ”¹è®¢å•è¯„ä»·

**å®ç°çŠ¶æ€**: âœ… å·²å®Œæˆï¼ˆå·²ä¼˜åŒ–ï¼‰

**æ¥å£**: `PUT /user/order/{orderId}/rating`

**æè¿°**: ä¿®æ”¹å·²æäº¤çš„è¯„ä»·

**æƒé™**: éœ€è¦ç”¨æˆ·ç™»å½•

**ä¿®æ”¹è§„åˆ™**:
- â° **15å¤©å†…**å¯ä¿®æ”¹ï¼ˆä»è¯„ä»·åˆ›å»ºæ—¶é—´ç®—èµ·ï¼‰
- ğŸ”¢ **ä»…é™1æ¬¡**ä¿®æ”¹æœºä¼š
- âŒ **ç»¼åˆè¯„åˆ†ä¸å¯ä¿®æ”¹**ï¼ˆä¿è¯æ ¸å¿ƒæŒ‡æ ‡ç¨³å®šï¼‰
- âœ… å¯ä¿®æ”¹ï¼šæ–‡å­—ã€å›¾ç‰‡ã€æ ‡ç­¾ã€è¯¦ç»†è¯„åˆ†ã€åŒ¿åçŠ¶æ€
- ğŸ’¡ ä¿®æ”¹åæ˜¾ç¤º"å·²ç¼–è¾‘"æ ‡ç­¾

**è¯·æ±‚ä½“**: OrderRatingRequestï¼ˆæ³¨æ„ï¼šscore å­—æ®µä¼šè¢«å¿½ç•¥ï¼‰
```json
{
  "content": "ä¿®æ”¹åçš„è¯„ä»·å†…å®¹",
  "images": ["url1", "url2"],
  "serviceAttitudeScore": 5,
  "serviceQualityScore": 5,
  "punctualityScore": 5,
  "cleanlinessScore": 5,
  "tags": ["æœåŠ¡å¥½", "å¾ˆä¸“ä¸š"],
  "isAnonymous": false
}
```

**å“åº”**:
```json
{
  "code": 200,
  "message": "ä¿®æ”¹æˆåŠŸ"
}
```

**é”™è¯¯å“åº”**:
```json
{
  "code": 400,
  "message": "è¯„ä»·ä¿®æ”¹æœŸé™å·²è¿‡ï¼ˆ15å¤©å†…å¯ä¿®æ”¹ï¼‰"
}
// æˆ–
{
  "code": 400,
  "message": "è¯„ä»·ä»…å¯ä¿®æ”¹1æ¬¡ï¼Œæ‚¨å·²è¾¾åˆ°ä¿®æ”¹æ¬¡æ•°ä¸Šé™"
}
// æˆ–
{
  "code": 400,
  "message": "å·²åˆ é™¤çš„è¯„ä»·æ— æ³•ä¿®æ”¹"
}
```

#### 4. åˆ é™¤è®¢å•è¯„ä»·

**å®ç°çŠ¶æ€**: âœ… å·²å®Œæˆï¼ˆå·²ä¼˜åŒ–ä¸ºé€»è¾‘åˆ é™¤ï¼‰

**æ¥å£**: `DELETE /user/order/{orderId}/rating`

**æè¿°**: åˆ é™¤å·²æäº¤çš„è¯„ä»·

**æƒé™**: éœ€è¦ç”¨æˆ·ç™»å½•

**åˆ é™¤è§„åˆ™**:
- â° **15å¤©å†…**å¯åˆ é™¤ï¼ˆä»è¯„ä»·åˆ›å»ºæ—¶é—´ç®—èµ·ï¼‰
- ğŸ’¾ **é€»è¾‘åˆ é™¤**ï¼ˆæ•°æ®ä¿ç•™ï¼ŒçŠ¶æ€æ”¹ä¸º DELETEDï¼‰
- âŒ åˆ é™¤åä¸å¯æ¢å¤
- ğŸ“Š ä¸æ˜¾ç¤ºåœ¨è¯„ä»·åˆ—è¡¨ä¸­ï¼Œä¸è®¡å…¥è¯„åˆ†ç»Ÿè®¡
- ğŸ”’ åå°ä¿ç•™è®°å½•ç”¨äºæ•°æ®åˆ†æå’Œé£æ§

**å“åº”**:
```json
{
  "code": 200,
  "message": "åˆ é™¤æˆåŠŸ"
}
```

**é”™è¯¯å“åº”**:
```json
{
  "code": 400,
  "message": "è¯„ä»·åˆ é™¤æœŸé™å·²è¿‡ï¼ˆ15å¤©å†…å¯åˆ é™¤ï¼‰"
}
// æˆ–
{
  "code": 400,
  "message": "è¯„ä»·å·²åˆ é™¤"
}
```

#### 5. è·å–æˆ‘çš„è¯„ä»·åˆ—è¡¨

**å®ç°çŠ¶æ€**: âœ… å·²å®Œæˆ

**æ¥å£**: `GET /user/ratings`

**æè¿°**: è·å–ç”¨æˆ·çš„æ‰€æœ‰è¯„ä»·è®°å½•

**æƒé™**: éœ€è¦ç”¨æˆ·ç™»å½•

**å‚æ•°**:
- `page`: é¡µç ï¼Œé»˜è®¤1
- `size`: æ¯é¡µå¤§å°ï¼Œé»˜è®¤10
- `status`: çŠ¶æ€ç­›é€‰ï¼ˆPUBLISHED, HIDDENï¼‰

**å“åº”**:
```json
{
  "code": 200,
  "message": "è·å–æˆåŠŸ",
  "data": {
    "records": [
      {
        "id": 123,
        "orderId": 456,
        "orderNo": "JY202410130001",
        "productName": "æ—¥å¸¸ä¿æ´",
        "score": 5,
        "content": "æœåŠ¡å¾ˆå¥½",
        "images": ["url1"],
        "tags": ["æœåŠ¡å¥½"],
        "status": "PUBLISHED",
        "createdTime": "2024-10-13T14:00:00",
        "staffInfo": {
          "staffId": 789,
          "staffName": "å¼ é˜¿å§¨",
          "avatar": "url"
        }
      }
    ],
    "total": 50,
    "page": 1,
    "size": 10,
    "pages": 5
  }
}
```


#### 6. è·å–è¯„ä»·æ ‡ç­¾åˆ—è¡¨

**å®ç°çŠ¶æ€**: âœ… å·²å®Œæˆ

**æ¥å£**: `GET /user/ratings/tags`

**æè¿°**: è·å–å¯ç”¨çš„è¯„ä»·æ ‡ç­¾åˆ—è¡¨

**æƒé™**: æ— éœ€è®¤è¯

**å‚æ•°**:
- `category`: æ ‡ç­¾åˆ†ç±»ï¼ˆSERVICE, ATTITUDE, QUALITY, PUNCTUALITYï¼‰

**å“åº”**:
```json
{
  "code": 200,
  "message": "è·å–æˆåŠŸ",
  "data": [
    {
      "id": 1,
      "tagName": "æœåŠ¡å¥½",
      "tagType": "POSITIVE",
      "category": "SERVICE",
      "icon": "url"
    }
  ]
}
```

#### 7. è·å–å•†å“è¯„ä»·åˆ—è¡¨

**å®ç°çŠ¶æ€**: âœ… å·²å®Œæˆ

**æ¥å£**: `GET /user/products/{productId}/ratings`

**æè¿°**: è·å–æŒ‡å®šå•†å“çš„è¯„ä»·åˆ—è¡¨

**æƒé™**: æ— éœ€è®¤è¯


**å‚æ•°**:
- `page`: é¡µç ï¼Œé»˜è®¤1
- `size`: æ¯é¡µå¤§å°ï¼Œé»˜è®¤10
- `scoreFilter`: è¯„åˆ†ç­›é€‰ï¼ˆ1-5ï¼Œå¯é€‰ï¼‰
- `hasImages`: æ˜¯å¦æœ‰å›¾ç‰‡ï¼ˆtrue/falseï¼Œå¯é€‰ï¼‰
- `sortBy`: æ’åºæ–¹å¼ï¼ˆTIME-æ—¶é—´, SCORE-è¯„åˆ†, LIKE-ç‚¹èµæ•°ï¼‰

**å“åº”**:
```json
{
  "code": 200,
  "message": "è·å–æˆåŠŸ",
  "data": {
    "summary": {
      "averageScore": 4.8,
      "totalCount": 100,
      "scoreDistribution": {
        "5": 80,
        "4": 15,
        "3": 3,
        "2": 1,
        "1": 1
      },
      "tagStatistics": [
        {"tagName": "æœåŠ¡å¥½", "count": 50},
        {"tagName": "å¾ˆä¸“ä¸š", "count": 45}
      ]
    },
    "records": [
      {
        "id": 123,
        "score": 5,
        "content": "æœåŠ¡å¾ˆå¥½",
        "images": ["url1"],
        "tags": ["æœåŠ¡å¥½"],
        "isAnonymous": false,
        "createdTime": "2024-10-13T14:00:00",
        "userInfo": {
          "nickname": "å¼ å…ˆç”Ÿ",
          "avatar": "url"
        },
        "replyContent": "æ„Ÿè°¢æ”¯æŒ",
        "replyTime": "2024-10-13T15:00:00"
      }
    ],
    "total": 100,
    "page": 1,
    "size": 10,
    "pages": 10
  }
}
```

### é˜¿å§¨ç«¯æ¥å£

#### 8. è·å–æˆ‘çš„è¯„ä»·åˆ—è¡¨

**å®ç°çŠ¶æ€**: âœ… å·²å®Œæˆ

**æ¥å£**: `GET /staff/ratings`

**æè¿°**: è·å–é˜¿å§¨æ”¶åˆ°çš„è¯„ä»·åˆ—è¡¨

**æƒé™**: éœ€è¦é˜¿å§¨ç™»å½•ï¼ˆé€šè¿‡ `MiniThreadLocal.getUserId()` è·å–staffIdï¼‰

**å‚æ•°**:
- `page`: é¡µç ï¼Œé»˜è®¤1
- `size`: æ¯é¡µå¤§å°ï¼Œé»˜è®¤10
- `scoreFilter`: è¯„åˆ†ç­›é€‰ï¼ˆ1-5ï¼‰

**å“åº”**:
```json
{
  "code": 200,
  "message": "è·å–æˆåŠŸ",
  "data": {
    "summary": {
      "averageScore": 4.8,
      "totalCount": 100,
      "serviceAttitudeRating": 4.9,
      "serviceQualityRating": 4.8,
      "punctualityRating": 4.7,
      "cleanlinessRating": 4.9,
      "scoreDistribution": {
        "5": 80,
        "4": 15,
        "3": 3,
        "2": 1,
        "1": 1
      }
    },
    "records": [
      {
        "id": 123,
        "orderId": 456,
        "orderNo": "JY202410130001",
        "productName": "æ—¥å¸¸ä¿æ´",
        "score": 5,
        "content": "æœåŠ¡å¾ˆå¥½",
        "images": ["url1"],
        "serviceAttitudeScore": 5,
        "serviceQualityScore": 5,
        "punctualityScore": 5,
        "cleanlinessScore": 5,
        "tags": ["æœåŠ¡å¥½", "å¾ˆä¸“ä¸š"],
        "isAnonymous": false,
        "createdTime": "2024-10-13T14:00:00",
        "userInfo": {
          "nickname": "å¼ å…ˆç”Ÿ",
          "avatar": "url"
        },
        "replyContent": null,
        "replyTime": null
      }
    ],
    "total": 100,
    "page": 1,
    "size": 10,
    "pages": 10
  }
}
```

#### 9. å›å¤è¯„ä»·

**å®ç°çŠ¶æ€**: âœ… å·²å®Œæˆ

**æ¥å£**: `POST /staff/ratings/{ratingId}/reply`

**æè¿°**: é˜¿å§¨å›å¤ç”¨æˆ·è¯„ä»·

**æƒé™**: éœ€è¦é˜¿å§¨ç™»å½•

**è¯·æ±‚ä½“**:
```json
{
  "replyContent": "æ„Ÿè°¢æ‚¨çš„å¥½è¯„ï¼ŒæœŸå¾…ä¸‹æ¬¡ä¸ºæ‚¨æœåŠ¡"
}
```

**å“åº”**:
```json
{
  "code": 200,
  "message": "å›å¤æˆåŠŸ"
}
```

#### 10. è·å–è¯„ä»·ç»Ÿè®¡

**å®ç°çŠ¶æ€**: âœ… å·²å®Œæˆ

**æ¥å£**: `GET /staff/ratings/statistics`

**æè¿°**: è·å–é˜¿å§¨çš„è¯„ä»·ç»Ÿè®¡æ•°æ®

**æƒé™**: éœ€è¦é˜¿å§¨ç™»å½•

**å‚æ•°**:
- `period`: ç»Ÿè®¡å‘¨æœŸï¼ˆWEEK-æœ¬å‘¨, MONTH-æœ¬æœˆ, YEAR-æœ¬å¹´, ALL-å…¨éƒ¨ï¼‰

**å“åº”**:
```json
{
  "code": 200,
  "message": "è·å–æˆåŠŸ",
  "data": {
    "period": "MONTH",
    "averageScore": 4.8,
    "totalCount": 50,
    "serviceAttitudeRating": 4.9,
    "serviceQualityRating": 4.8,
    "punctualityRating": 4.7,
    "cleanlinessRating": 4.9,
    "scoreDistribution": {
      "5": 40,
      "4": 8,
      "3": 1,
      "2": 1,
      "1": 0
    },
    "tagStatistics": [
      {"tagName": "æœåŠ¡å¥½", "count": 30},
      {"tagName": "å¾ˆä¸“ä¸š", "count": 25},
      {"tagName": "å‡†æ—¶åˆ°è¾¾", "count": 20}
    ],
    "trend": [
      {"date": "2024-10-01", "averageScore": 4.7, "count": 10},
      {"date": "2024-10-08", "averageScore": 4.8, "count": 15},
      {"date": "2024-10-15", "averageScore": 4.9, "count": 25}
    ]
  }
}
```

### ç®¡ç†ç«¯æ¥å£

#### 11. ç®¡ç†è¯„ä»·ï¼ˆéšè—/æ˜¾ç¤ºï¼‰

**å®ç°çŠ¶æ€**: âŒ æœªå®ç°ï¼ˆç®¡ç†ç«¯åŠŸèƒ½å¾…å¼€å‘ï¼‰

**æ¥å£**: `PUT /admin/ratings/{ratingId}/status`

**æè¿°**: ç®¡ç†å‘˜ç®¡ç†è¯„ä»·çŠ¶æ€

**æƒé™**: éœ€è¦ç®¡ç†å‘˜ç™»å½•

**TODO**: éœ€è¦åœ¨ `jiayou-admin-service` ä¸­å®ç°

**è¯·æ±‚ä½“**:
```json
{
  "status": "HIDDEN",
  "reason": "è¿è§„å†…å®¹"
}
```

**å“åº”**:
```json
{
  "code": 200,
  "message": "æ“ä½œæˆåŠŸ"
}
```

---

## å‰ç«¯äº¤äº’æµç¨‹

### 1. ç”¨æˆ·è¯„ä»·è®¢å•æµç¨‹

#### é¡µé¢ç»“æ„

```
è®¢å•è¯¦æƒ…é¡µ
  â†“ ç‚¹å‡»"è¯„ä»·"æŒ‰é’®
è¯„ä»·é¡µé¢
  â”œâ”€â”€ è®¢å•ä¿¡æ¯å±•ç¤º
  â”œâ”€â”€ é˜¿å§¨ä¿¡æ¯å±•ç¤º
  â”œâ”€â”€ ç»¼åˆè¯„åˆ†ï¼ˆå¿…å¡«ï¼‰
  â”‚   â””â”€â”€ æ˜Ÿçº§é€‰æ‹©å™¨ï¼ˆ1-5æ˜Ÿï¼‰
  â”œâ”€â”€ è¯¦ç»†è¯„åˆ†ï¼ˆå¯é€‰ï¼‰
  â”‚   â”œâ”€â”€ æœåŠ¡æ€åº¦ï¼ˆ1-5æ˜Ÿï¼‰
  â”‚   â”œâ”€â”€ æœåŠ¡è´¨é‡ï¼ˆ1-5æ˜Ÿï¼‰
  â”‚   â”œâ”€â”€ å‡†æ—¶æ€§ï¼ˆ1-5æ˜Ÿï¼‰
  â”‚   â””â”€â”€ æ¸…æ´åº¦ï¼ˆ1-5æ˜Ÿï¼‰
  â”œâ”€â”€ è¯„ä»·æ ‡ç­¾ï¼ˆå¯é€‰ï¼‰
  â”‚   â””â”€â”€ æ ‡ç­¾é€‰æ‹©å™¨ï¼ˆå¤šé€‰ï¼‰
  â”œâ”€â”€ æ–‡å­—è¯„ä»·ï¼ˆå¯é€‰ï¼‰
  â”‚   â””â”€â”€ æ–‡æœ¬è¾“å…¥æ¡†ï¼ˆæœ€å¤š500å­—ï¼‰
  â”œâ”€â”€ å›¾ç‰‡ä¸Šä¼ ï¼ˆå¯é€‰ï¼‰
  â”‚   â””â”€â”€ æœ€å¤š9å¼ å›¾ç‰‡
  â”œâ”€â”€ åŒ¿åé€‰é¡¹
  â”‚   â””â”€â”€ å‹¾é€‰æ¡†
  â””â”€â”€ æäº¤æŒ‰é’®
```

#### Vue.js ä»£ç ç¤ºä¾‹

```vue
<template>
  <view class="rating-page">
    <!-- è®¢å•ä¿¡æ¯ -->
    <view class="order-info">
      <view class="order-no">è®¢å•å·ï¼š{{ orderInfo.orderNo }}</view>
      <view class="service-name">{{ orderInfo.productName }}</view>
      <view class="service-time">æœåŠ¡æ—¶é—´ï¼š{{ orderInfo.serviceTime }}</view>
    </view>

    <!-- é˜¿å§¨ä¿¡æ¯ -->
    <view class="staff-info">
      <image :src="staffInfo.avatar" class="avatar"></image>
      <view class="staff-name">{{ staffInfo.name }}</view>
    </view>

    <!-- ç»¼åˆè¯„åˆ† -->
    <view class="rating-section">
      <view class="section-title">ç»¼åˆè¯„åˆ† <text class="required">*</text></view>
      <view class="star-rating">
        <view 
          v-for="star in 5" 
          :key="star"
          class="star"
          :class="{ active: star <= form.score }"
          @click="setScore(star)"
        >
          â˜…
        </view>
      </view>
      <view class="score-desc">{{ scoreDescriptions[form.score] }}</view>
    </view>

    <!-- è¯¦ç»†è¯„åˆ† -->
    <view class="detail-rating">
      <view class="section-title">è¯¦ç»†è¯„åˆ†ï¼ˆå¯é€‰ï¼‰</view>
      
      <view class="rating-item">
        <text>æœåŠ¡æ€åº¦</text>
        <view class="star-rating small">
          <view 
            v-for="star in 5" 
            :key="star"
            class="star"
            :class="{ active: star <= form.serviceAttitudeScore }"
            @click="form.serviceAttitudeScore = star"
          >
            â˜…
          </view>
        </view>
      </view>

      <view class="rating-item">
        <text>æœåŠ¡è´¨é‡</text>
        <view class="star-rating small">
          <view 
            v-for="star in 5" 
            :key="star"
            class="star"
            :class="{ active: star <= form.serviceQualityScore }"
            @click="form.serviceQualityScore = star"
          >
            â˜…
          </view>
        </view>
      </view>

      <view class="rating-item">
        <text>å‡†æ—¶æ€§</text>
        <view class="star-rating small">
          <view 
            v-for="star in 5" 
            :key="star"
            class="star"
            :class="{ active: star <= form.punctualityScore }"
            @click="form.punctualityScore = star"
          >
            â˜…
          </view>
        </view>
      </view>

      <view class="rating-item">
        <text>æ¸…æ´åº¦</text>
        <view class="star-rating small">
          <view 
            v-for="star in 5" 
            :key="star"
            class="star"
            :class="{ active: star <= form.cleanlinessScore }"
            @click="form.cleanlinessScore = star"
          >
            â˜…
          </view>
        </view>
      </view>
    </view>

    <!-- è¯„ä»·æ ‡ç­¾ -->
    <view class="tags-section">
      <view class="section-title">é€‰æ‹©æ ‡ç­¾ï¼ˆå¯é€‰ï¼‰</view>
      <view class="tags-list">
        <view 
          v-for="tag in availableTags" 
          :key="tag.id"
          class="tag"
          :class="{ 
            active: form.tags.includes(tag.tagName),
            positive: tag.tagType === 'POSITIVE',
            negative: tag.tagType === 'NEGATIVE'
          }"
          @click="toggleTag(tag.tagName)"
        >
          {{ tag.tagName }}
        </view>
      </view>
    </view>

    <!-- æ–‡å­—è¯„ä»· -->
    <view class="content-section">
      <view class="section-title">
        æ–‡å­—è¯„ä»·ï¼ˆå¯é€‰ï¼‰
        <text class="tip">{{ form.content.length }}/500</text>
      </view>
      <textarea 
        v-model="form.content"
        placeholder="è¯´è¯´æ‚¨çš„æœåŠ¡ä½“éªŒå§ï¼Œ10å­—ä»¥ä¸Šå¯è·å¾—ç§¯åˆ†å¥–åŠ±"
        maxlength="500"
        class="content-input"
      ></textarea>
    </view>

    <!-- å›¾ç‰‡ä¸Šä¼  -->
    <view class="images-section">
      <view class="section-title">
        ä¸Šä¼ å›¾ç‰‡ï¼ˆå¯é€‰ï¼‰
        <text class="tip">æœ€å¤š9å¼ ï¼Œä¸Šä¼ å›¾ç‰‡å¯è·å¾—ç§¯åˆ†å¥–åŠ±</text>
      </view>
      <view class="images-list">
        <view 
          v-for="(image, index) in form.images" 
          :key="index"
          class="image-item"
        >
          <image :src="image" mode="aspectFill"></image>
          <view class="delete-btn" @click="removeImage(index)">Ã—</view>
        </view>
        <view 
          v-if="form.images.length < 9"
          class="upload-btn"
          @click="chooseImage"
        >
          <text>+</text>
        </view>
      </view>
    </view>

    <!-- åŒ¿åé€‰é¡¹ -->
    <view class="anonymous-section">
      <checkbox-group @change="onAnonymousChange">
        <label>
          <checkbox :checked="form.isAnonymous" />
          åŒ¿åè¯„ä»·
        </label>
      </checkbox-group>
    </view>

    <!-- ç§¯åˆ†å¥–åŠ±æç¤º -->
    <view class="reward-tips">
      <view class="tip-item">
        <text class="icon">ğŸ</text>
        <text>æ–‡å­—è¯„ä»·10å­—ä»¥ä¸Šï¼š+10ç§¯åˆ†</text>
      </view>
      <view class="tip-item">
        <text class="icon">ğŸ“·</text>
        <text>ä¸Šä¼ å›¾ç‰‡ï¼š+5ç§¯åˆ†</text>
      </view>
      <view class="tip-item">
        <text class="icon">â­</text>
        <text>å¡«å†™è¯¦ç»†è¯„åˆ†ï¼š+5ç§¯åˆ†</text>
      </view>
      <view class="tip-item">
        <text class="icon">ğŸ’</text>
        <text>ä¼˜è´¨è¯„ä»·ï¼ˆ50å­—+3å›¾ï¼‰ï¼š+20ç§¯åˆ†</text>
      </view>
    </view>

    <!-- æäº¤æŒ‰é’® -->
    <view class="submit-section">
      <button 
        class="submit-btn"
        :disabled="!canSubmit"
        @click="submitRating"
      >
        æäº¤è¯„ä»·
      </button>
    </view>
  </view>
</template>

<script>
export default {
  data() {
    return {
      orderId: null,
      orderInfo: {},
      staffInfo: {},
      availableTags: [],
      form: {
        score: 5,
        serviceAttitudeScore: null,
        serviceQualityScore: null,
        punctualityScore: null,
        cleanlinessScore: null,
        content: '',
        images: [],
        tags: [],
        isAnonymous: false
      },
      scoreDescriptions: {
        1: 'éå¸¸ä¸æ»¡æ„',
        2: 'ä¸æ»¡æ„',
        3: 'ä¸€èˆ¬',
        4: 'æ»¡æ„',
        5: 'éå¸¸æ»¡æ„'
      }
    };
  },
  
  computed: {
    canSubmit() {
      return this.form.score > 0;
    }
  },
  
  onLoad(options) {
    this.orderId = options.orderId;
    this.loadOrderInfo();
    this.loadTags();
  },
  
  methods: {
    async loadOrderInfo() {
      try {
        const res = await this.$http.get(`/user/order/${this.orderId}`);
        this.orderInfo = res.data;
        this.staffInfo = res.data.staffInfo;
      } catch (error) {
        uni.showToast({
          title: 'åŠ è½½è®¢å•ä¿¡æ¯å¤±è´¥',
          icon: 'none'
        });
      }
    },
    
    async loadTags() {
      try {
        const res = await this.$http.get('/user/ratings/tags');
        this.availableTags = res.data;
      } catch (error) {
        console.error('åŠ è½½æ ‡ç­¾å¤±è´¥', error);
      }
    },
    
    setScore(score) {
      this.form.score = score;
    },
    
    toggleTag(tagName) {
      const index = this.form.tags.indexOf(tagName);
      if (index > -1) {
        this.form.tags.splice(index, 1);
      } else {
        this.form.tags.push(tagName);
      }
    },
    
    chooseImage() {
      uni.chooseImage({
        count: 9 - this.form.images.length,
        success: (res) => {
          this.uploadImages(res.tempFilePaths);
        }
      });
    },
    
    async uploadImages(filePaths) {
      uni.showLoading({ title: 'ä¸Šä¼ ä¸­...' });
      
      try {
        for (const filePath of filePaths) {
          const uploadRes = await this.$http.upload('/common/upload', {
            filePath: filePath,
            name: 'file',
            formData: { fileType: 'rating_image' }
          });
          
          this.form.images.push(uploadRes.data);
        }
        
        uni.hideLoading();
        uni.showToast({
          title: 'ä¸Šä¼ æˆåŠŸ',
          icon: 'success'
        });
      } catch (error) {
        uni.hideLoading();
        uni.showToast({
          title: 'ä¸Šä¼ å¤±è´¥',
          icon: 'none'
        });
      }
    },
    
    removeImage(index) {
      this.form.images.splice(index, 1);
    },
    
    onAnonymousChange(e) {
      this.form.isAnonymous = e.detail.value.length > 0;
    },
    
    async submitRating() {
      if (!this.canSubmit) {
        return;
      }
      
      uni.showLoading({ title: 'æäº¤ä¸­...' });
      
      try {
        const res = await this.$http.post(
          `/user/order/${this.orderId}/rating`,
          this.form
        );
        
        uni.hideLoading();
        
        // æ˜¾ç¤ºç§¯åˆ†å¥–åŠ±
        if (res.data.pointsReward > 0) {
          uni.showModal({
            title: 'è¯„ä»·æˆåŠŸ',
            content: `æ„Ÿè°¢æ‚¨çš„è¯„ä»·ï¼è·å¾— ${res.data.pointsReward} ç§¯åˆ†å¥–åŠ±`,
            showCancel: false,
            success: () => {
              uni.navigateBack();
            }
          });
        } else {
          uni.showToast({
            title: 'è¯„ä»·æˆåŠŸ',
            icon: 'success',
            success: () => {
              setTimeout(() => {
                uni.navigateBack();
              }, 1500);
            }
          });
        }
      } catch (error) {
        uni.hideLoading();
        uni.showToast({
          title: error.message || 'æäº¤å¤±è´¥',
          icon: 'none'
        });
      }
    }
  }
};
</script>

<style lang="scss" scoped>
.rating-page {
  padding: 20rpx;
  background: #f5f5f5;
  min-height: 100vh;
}

.order-info {
  background: white;
  padding: 30rpx;
  border-radius: 20rpx;
  margin-bottom: 20rpx;
}

.staff-info {
  background: white;
  padding: 30rpx;
  border-radius: 20rpx;
  margin-bottom: 20rpx;
  display: flex;
  align-items: center;
  
  .avatar {
    width: 100rpx;
    height: 100rpx;
    border-radius: 50%;
    margin-right: 20rpx;
  }
}

.rating-section {
  background: white;
  padding: 30rpx;
  border-radius: 20rpx;
  margin-bottom: 20rpx;
  
  .star-rating {
    display: flex;
    justify-content: center;
    margin: 20rpx 0;
    
    .star {
      font-size: 60rpx;
      color: #ddd;
      margin: 0 10rpx;
      cursor: pointer;
      
      &.active {
        color: #ff9900;
      }
    }
  }
  
  .score-desc {
    text-align: center;
    color: #666;
    font-size: 28rpx;
  }
}

.detail-rating {
  background: white;
  padding: 30rpx;
  border-radius: 20rpx;
  margin-bottom: 20rpx;
  
  .rating-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin: 20rpx 0;
    
    .star-rating.small .star {
      font-size: 40rpx;
      margin: 0 5rpx;
    }
  }
}

.tags-section {
  background: white;
  padding: 30rpx;
  border-radius: 20rpx;
  margin-bottom: 20rpx;
  
  .tags-list {
    display: flex;
    flex-wrap: wrap;
    gap: 20rpx;
    margin-top: 20rpx;
    
    .tag {
      padding: 10rpx 30rpx;
      border-radius: 40rpx;
      border: 2rpx solid #ddd;
      font-size: 28rpx;
      
      &.active {
        border-color: #ff9900;
        background: #fff7e6;
        color: #ff9900;
      }
      
      &.positive {
        border-color: #52c41a;
        
        &.active {
          background: #f6ffed;
          color: #52c41a;
        }
      }
      
      &.negative {
        border-color: #ff4d4f;
        
        &.active {
          background: #fff1f0;
          color: #ff4d4f;
        }
      }
    }
  }
}

.content-section {
  background: white;
  padding: 30rpx;
  border-radius: 20rpx;
  margin-bottom: 20rpx;
  
  .content-input {
    width: 100%;
    min-height: 200rpx;
    padding: 20rpx;
    border: 2rpx solid #eee;
    border-radius: 10rpx;
    margin-top: 20rpx;
  }
}

.images-section {
  background: white;
  padding: 30rpx;
  border-radius: 20rpx;
  margin-bottom: 20rpx;
  
  .images-list {
    display: flex;
    flex-wrap: wrap;
    gap: 20rpx;
    margin-top: 20rpx;
    
    .image-item {
      position: relative;
      width: 200rpx;
      height: 200rpx;
      
      image {
        width: 100%;
        height: 100%;
        border-radius: 10rpx;
      }
      
      .delete-btn {
        position: absolute;
        top: -10rpx;
        right: -10rpx;
        width: 40rpx;
        height: 40rpx;
        background: red;
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 30rpx;
      }
    }
    
    .upload-btn {
      width: 200rpx;
      height: 200rpx;
      border: 2rpx dashed #ddd;
      border-radius: 10rpx;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 60rpx;
      color: #999;
    }
  }
}

.anonymous-section {
  background: white;
  padding: 30rpx;
  border-radius: 20rpx;
  margin-bottom: 20rpx;
}

.reward-tips {
  background: #fff7e6;
  padding: 30rpx;
  border-radius: 20rpx;
  margin-bottom: 20rpx;
  
  .tip-item {
    display: flex;
    align-items: center;
    margin: 10rpx 0;
    font-size: 26rpx;
    color: #666;
    
    .icon {
      margin-right: 10rpx;
    }
  }
}

.submit-section {
  padding: 30rpx 0;
  
  .submit-btn {
    width: 100%;
    background: linear-gradient(135deg, #ff9900, #ff6600);
    color: white;
    border-radius: 50rpx;
    height: 90rpx;
    line-height: 90rpx;
    font-size: 32rpx;
    
    &[disabled] {
      background: #ddd;
    }
  }
}

.section-title {
  font-size: 30rpx;
  font-weight: bold;
  margin-bottom: 10rpx;
  
  .required {
    color: red;
  }
  
  .tip {
    font-size: 24rpx;
    color: #999;
    font-weight: normal;
    margin-left: 10rpx;
  }
}
</style>
```

### 2. æŸ¥çœ‹å•†å“è¯„ä»·æµç¨‹

#### é¡µé¢ç»“æ„

```
å•†å“è¯¦æƒ…é¡µ
  â†“ ç‚¹å‡»"ç”¨æˆ·è¯„ä»·"æ ‡ç­¾
è¯„ä»·åˆ—è¡¨é¡µ
  â”œâ”€â”€ è¯„ä»·ç»Ÿè®¡æ‘˜è¦
  â”‚   â”œâ”€â”€ å¹³å‡è¯„åˆ†
  â”‚   â”œâ”€â”€ è¯„ä»·æ€»æ•°
  â”‚   â”œâ”€â”€ è¯„åˆ†åˆ†å¸ƒå›¾
  â”‚   â””â”€â”€ çƒ­é—¨æ ‡ç­¾
  â”œâ”€â”€ ç­›é€‰æ¡ä»¶
  â”‚   â”œâ”€â”€ è¯„åˆ†ç­›é€‰ï¼ˆå…¨éƒ¨/5æ˜Ÿ/4æ˜Ÿ/3æ˜Ÿ/2æ˜Ÿ/1æ˜Ÿï¼‰
  â”‚   â”œâ”€â”€ æœ‰å›¾ç­›é€‰
  â”‚   â””â”€â”€ æ’åºæ–¹å¼ï¼ˆæ—¶é—´/è¯„åˆ†/ç‚¹èµæ•°ï¼‰
  â””â”€â”€ è¯„ä»·åˆ—è¡¨
      â””â”€â”€ è¯„ä»·å¡ç‰‡
          â”œâ”€â”€ ç”¨æˆ·ä¿¡æ¯
          â”œâ”€â”€ è¯„åˆ†
          â”œâ”€â”€ è¯„ä»·å†…å®¹
          â”œâ”€â”€ è¯„ä»·å›¾ç‰‡
          â”œâ”€â”€ è¯„ä»·æ ‡ç­¾
          â”œâ”€â”€ ç‚¹èµæŒ‰é’®
          â””â”€â”€ å•†å®¶å›å¤
```

### 3. é˜¿å§¨æŸ¥çœ‹è¯„ä»·æµç¨‹

#### é¡µé¢ç»“æ„

```
é˜¿å§¨ä¸ªäººä¸­å¿ƒ
  â†“ ç‚¹å‡»"æˆ‘çš„è¯„ä»·"
è¯„ä»·ç»Ÿè®¡é¡µ
  â”œâ”€â”€ è¯„ä»·æ¦‚è§ˆ
  â”‚   â”œâ”€â”€ ç»¼åˆè¯„åˆ†
  â”‚   â”œâ”€â”€ è¯„ä»·æ€»æ•°
  â”‚   â”œâ”€â”€ è¯¦ç»†è¯„åˆ†ï¼ˆæœåŠ¡æ€åº¦ã€è´¨é‡ã€å‡†æ—¶æ€§ã€æ¸…æ´åº¦ï¼‰
  â”‚   â””â”€â”€ è¯„åˆ†è¶‹åŠ¿å›¾
  â”œâ”€â”€ å‘¨æœŸé€‰æ‹©ï¼ˆæœ¬å‘¨/æœ¬æœˆ/æœ¬å¹´/å…¨éƒ¨ï¼‰
  â””â”€â”€ è¯„ä»·åˆ—è¡¨
      â””â”€â”€ è¯„ä»·å¡ç‰‡
          â”œâ”€â”€ è®¢å•ä¿¡æ¯
          â”œâ”€â”€ ç”¨æˆ·ä¿¡æ¯
          â”œâ”€â”€ è¯„åˆ†è¯¦æƒ…
          â”œâ”€â”€ è¯„ä»·å†…å®¹
          â”œâ”€â”€ è¯„ä»·å›¾ç‰‡
          â”œâ”€â”€ è¯„ä»·æ ‡ç­¾
          â””â”€â”€ å›å¤æŒ‰é’®
```

---

## è¯„åˆ†è®¡ç®—è§„åˆ™

### 1. å•†å“è¯„åˆ†è®¡ç®—

**å®šæ—¶ä»»åŠ¡**: `ProductRatingUpdateTask`

**æ‰§è¡Œé¢‘ç‡**: æ¯10åˆ†é’Ÿï¼ˆcron: `0 */10 * * * ?`ï¼‰

**è®¡ç®—é€»è¾‘**:

```java
// 1. æŸ¥è¯¢æ‰€æœ‰åœ¨å”®å•†å“
List<Product> products = productMapper.selectList(
    new LambdaQueryWrapper<Product>()
        .eq(Product::getStatus, "ACTIVE")
        .eq(Product::getIsOnSale, true)
);

// 2. å¯¹æ¯ä¸ªå•†å“è®¡ç®—è¯„åˆ†
for (Product product : products) {
    // æŸ¥è¯¢è¯¥å•†å“çš„æ‰€æœ‰å·²å‘å¸ƒè¯„ä»·
    List<OrderRating> ratings = orderRatingMapper.selectList(
        new LambdaQueryWrapper<OrderRating>()
            .eq(OrderRating::getProductId, product.getId())
            .eq(OrderRating::getStatus, "PUBLISHED")
    );
    
    if (!ratings.isEmpty()) {
        // è®¡ç®—å¹³å‡åˆ†
        double totalScore = ratings.stream()
            .mapToDouble(r -> r.getScore() != null ? r.getScore().doubleValue() : 0)
            .sum();
        
        BigDecimal avgRating = BigDecimal.valueOf(totalScore / ratings.size())
            .setScale(1, RoundingMode.HALF_UP);
        
        // ç¡®ä¿è¯„åˆ†åœ¨ 1.0 - 5.0 ä¹‹é—´
        if (avgRating.compareTo(BigDecimal.ONE) < 0) {
            avgRating = BigDecimal.ONE;
        } else if (avgRating.compareTo(new BigDecimal("5.0")) > 0) {
            avgRating = new BigDecimal("5.0");
        }
        
        // æ›´æ–°å•†å“è¯„åˆ†å’Œè¯„ä»·æ•°é‡
        product.setRating(avgRating);
        product.setReviewCount(ratings.size());
    } else {
        // æ²¡æœ‰è¯„ä»·æ—¶é»˜è®¤5.0åˆ†
        product.setRating(new BigDecimal("5.0"));
        product.setReviewCount(0);
    }
    
    product.setUpdatedTime(LocalDateTime.now());
    productMapper.updateById(product);
}
```

### 2. é˜¿å§¨è¯„åˆ†è®¡ç®—

**å®šæ—¶ä»»åŠ¡**: `StaffRatingUpdateTask`

**æ‰§è¡Œé¢‘ç‡**: æ¯10åˆ†é’Ÿï¼ˆcron: `0 */10 * * * ?`ï¼‰

**è®¡ç®—é€»è¾‘**:

```java
// 1. æŸ¥è¯¢æ‰€æœ‰æ´»è·ƒé˜¿å§¨
List<Staff> staffList = staffMapper.selectList(
    new LambdaQueryWrapper<Staff>()
        .eq(Staff::getStatus, StatusConstants.General.ACTIVE)
        .eq(Staff::getCertificationStatus, "CERTIFIED")
);

// 2. å¯¹æ¯ä¸ªé˜¿å§¨è®¡ç®—è¯„åˆ†
for (Staff staff : staffList) {
    // æŸ¥è¯¢è¯¥é˜¿å§¨çš„æ‰€æœ‰å·²å‘å¸ƒè¯„ä»·
    List<OrderRating> ratings = orderRatingMapper.selectList(
        new LambdaQueryWrapper<OrderRating>()
            .eq(OrderRating::getStaffId, staff.getId())
            .eq(OrderRating::getStatus, "PUBLISHED")
    );
    
    if (!ratings.isEmpty()) {
        // è®¡ç®—ç»¼åˆè¯„åˆ†
        double totalScore = ratings.stream()
            .mapToDouble(r -> r.getScore() != null ? r.getScore().doubleValue() : 0)
            .sum();
        
        BigDecimal avgRating = BigDecimal.valueOf(totalScore / ratings.size())
            .setScale(1, RoundingMode.HALF_UP);
        
        // è®¡ç®—è¯¦ç»†è¯„åˆ†
        BigDecimal serviceAttitudeRating = calculateDetailScore(
            ratings, OrderRating::getServiceAttitudeScore
        );
        BigDecimal serviceQualityRating = calculateDetailScore(
            ratings, OrderRating::getServiceQualityScore
        );
        BigDecimal punctualityRating = calculateDetailScore(
            ratings, OrderRating::getPunctualityScore
        );
        BigDecimal cleanlinessRating = calculateDetailScore(
            ratings, OrderRating::getCleanlinessScore
        );
        
        // æ›´æ–°é˜¿å§¨è¯„åˆ†
        staff.setRating(avgRating);
        staff.setReviewCount(ratings.size());
        staff.setServiceAttitudeRating(serviceAttitudeRating);
        staff.setServiceQualityRating(serviceQualityRating);
        staff.setPunctualityRating(punctualityRating);
        staff.setCleanlinessRating(cleanlinessRating);
    } else {
        // æ²¡æœ‰è¯„ä»·æ—¶é»˜è®¤5.0åˆ†
        staff.setRating(new BigDecimal("5.0"));
        staff.setReviewCount(0);
        staff.setServiceAttitudeRating(new BigDecimal("5.0"));
        staff.setServiceQualityRating(new BigDecimal("5.0"));
        staff.setPunctualityRating(new BigDecimal("5.0"));
        staff.setCleanlinessRating(new BigDecimal("5.0"));
    }
    
    staff.setUpdatedTime(LocalDateTime.now());
    staffMapper.updateById(staff);
}

// è¾…åŠ©æ–¹æ³•ï¼šè®¡ç®—è¯¦ç»†è¯„åˆ†
private BigDecimal calculateDetailScore(
    List<OrderRating> ratings, 
    Function<OrderRating, Byte> scoreGetter
) {
    List<Byte> scores = ratings.stream()
        .map(scoreGetter)
        .filter(Objects::nonNull)
        .collect(Collectors.toList());
    
    if (scores.isEmpty()) {
        return new BigDecimal("5.0");
    }
    
    double avg = scores.stream()
        .mapToDouble(Byte::doubleValue)
        .average()
        .orElse(5.0);
    
    return BigDecimal.valueOf(avg).setScale(1, RoundingMode.HALF_UP);
}
```

### 3. ç§¯åˆ†å¥–åŠ±è®¡ç®—

**å®ç°çŠ¶æ€**: âœ… å·²å®Œæˆ

**è§¦å‘æ—¶æœº**: ç”¨æˆ·æäº¤è¯„ä»·å

**è®¡ç®—é€»è¾‘**:

```java
// ä½ç½®: OrderRatingServiceImpl.java
private int calculatePointsReward(OrderRatingRequest request) {
    int points = 5; // åŸºç¡€è¯„ä»·å¥–åŠ±
    
    // æ–‡å­—è¯„ä»·å¥–åŠ±ï¼ˆ10å­—ä»¥ä¸Šï¼‰
    if (request.getContent() != null && request.getContent().length() >= 10) {
        points += 10;
    }
    
    // å›¾ç‰‡å¥–åŠ±ï¼ˆè‡³å°‘1å¼ ï¼‰
    if (request.getImages() != null && !request.getImages().isEmpty()) {
        points += 5;
    }
    
    // è¯¦ç»†è¯„åˆ†å¥–åŠ±ï¼ˆå¡«å†™æ‰€æœ‰è¯¦ç»†è¯„åˆ†ï¼‰
    if (request.getServiceAttitudeScore() != null &&
        request.getServiceQualityScore() != null &&
        request.getPunctualityScore() != null &&
        request.getCleanlinessScore() != null) {
        points += 5;
    }
    
    // ä¼˜è´¨è¯„ä»·å¥–åŠ±ï¼ˆ50å­—ä»¥ä¸Š + 3å¼ å›¾ç‰‡ä»¥ä¸Šï¼‰
    if (request.getContent() != null && request.getContent().length() >= 50 &&
        request.getImages() != null && request.getImages().size() >= 3) {
        return 20; // ä¼˜è´¨è¯„ä»·æ›¿ä»£å…¶ä»–å¥–åŠ±
    }
    
    return points;
}
```

**ç§¯åˆ†å‘æ”¾å®ç°**:

```java
// è®¡ç®—ç§¯åˆ†å¥–åŠ±
int pointsReward = calculatePointsReward(request);

// å‘æ”¾ç§¯åˆ†
if (pointsReward > 0) {
    userPointsService.addPoints(
        userId, 
        pointsReward, 
        "è®¢å•è¯„ä»·", 
        "RATING_REWARD"
    );
}

// è¿”å›ç»“æœ
Map<String, Object> result = new HashMap<>();
result.put("ratingId", rating.getId());
result.put("pointsReward", pointsReward);
result.put("rewardReason", pointsReward >= 20 ? "ä¼˜è´¨è¯„ä»·å¥–åŠ±" : "è¯„ä»·å¥–åŠ±");
return result;
```

---

## å®šæ—¶ä»»åŠ¡è®¾è®¡

> **å®ç°çŠ¶æ€**: âœ… å·²å®Œæˆ  
> **åˆ†å¸ƒå¼é”**: ä½¿ç”¨ `@DistributedLock` æ³¨è§£ï¼ˆåŸºäº Redissonï¼‰

### 1. å•†å“è¯„åˆ†æ›´æ–°ä»»åŠ¡

**å®ç°çŠ¶æ€**: âœ… å·²å®Œæˆ

**ç±»å**: `ProductRatingUpdateTask`

**è·¯å¾„**: `jiayou-miniprogram-service/src/main/java/com/jiayou/miniprogram/task/ProductRatingUpdateTask.java`

**é…ç½®**:
- **æ‰§è¡Œé¢‘ç‡**: æ¯10åˆ†é’Ÿ
- **Cronè¡¨è¾¾å¼**: `0 */10 * * * ?`
- **åˆ†å¸ƒå¼é”**: `product:rating:update`
- **é”è¿‡æœŸæ—¶é—´**: 590ç§’ï¼ˆ9åˆ†50ç§’ï¼‰

**å®ç°è¦ç‚¹**:
- åªæ›´æ–°åœ¨å”®å•†å“ï¼ˆ`status=ACTIVE` ä¸” `is_on_sale=true`ï¼‰
- åªç»Ÿè®¡å·²å‘å¸ƒçš„è¯„ä»·ï¼ˆ`status=PUBLISHED`ï¼‰
- æ— è¯„ä»·æ—¶é»˜è®¤5.0åˆ†
- ä¿ç•™1ä½å°æ•°ï¼Œå››èˆäº”å…¥
- è¯„åˆ†èŒƒå›´é™åˆ¶åœ¨ 1.0-5.0

### 2. é˜¿å§¨è¯„åˆ†æ›´æ–°ä»»åŠ¡

**å®ç°çŠ¶æ€**: âœ… å·²å®Œæˆ

**ç±»å**: `StaffRatingUpdateTask`

**è·¯å¾„**: `jiayou-miniprogram-service/src/main/java/com/jiayou/miniprogram/task/StaffRatingUpdateTask.java`

**é…ç½®**:
- **æ‰§è¡Œé¢‘ç‡**: æ¯10åˆ†é’Ÿ
- **Cronè¡¨è¾¾å¼**: `0 */10 * * * ?`
- **åˆ†å¸ƒå¼é”**: `staff:rating:update`
- **é”è¿‡æœŸæ—¶é—´**: 590ç§’ï¼ˆ9åˆ†50ç§’ï¼‰

**å®ç°è¦ç‚¹**:
- åªæ›´æ–°æ´»è·ƒä¸”å·²è®¤è¯çš„é˜¿å§¨ï¼ˆ`status=ACTIVE` ä¸” `certification_status=APPROVED`ï¼‰
- è®¡ç®—ç»¼åˆè¯„åˆ†å’Œ4ä¸ªè¯¦ç»†è¯„åˆ†ç»´åº¦
- åªç»Ÿè®¡å·²å‘å¸ƒçš„è¯„ä»·
- æ— è¯„ä»·æ—¶é»˜è®¤5.0åˆ†

### 3. å®šæ—¶ä»»åŠ¡ç›‘æ§

**ç›‘æ§æŒ‡æ ‡**:
- ä»»åŠ¡æ‰§è¡Œæ—¶é•¿
- æ›´æ–°å•†å“/é˜¿å§¨æ•°é‡
- å¤±è´¥æ¬¡æ•°
- å¼‚å¸¸æ—¥å¿—

**å‘Šè­¦è§„åˆ™**:
- æ‰§è¡Œæ—¶é•¿è¶…è¿‡5åˆ†é’Ÿ
- è¿ç»­3æ¬¡å¤±è´¥
- æ›´æ–°æ•°é‡ä¸º0

---

## å®ç°æ¸…å•

> **æ€»ä½“è¿›åº¦**: æ ¸å¿ƒåŠŸèƒ½ 100% | å¢å¼ºåŠŸèƒ½ 85%  
> **æœ€åæ›´æ–°**: 2025-10-13

### ğŸ“¦ æ•°æ®åº“å˜æ›´

- [x] âœ… ä¼˜åŒ– `order_rating` è¡¨ç»“æ„ï¼ˆæ·»åŠ è¯¦ç»†è¯„åˆ†ã€æ ‡ç­¾ã€å›¾ç‰‡ç­‰å­—æ®µï¼‰
- [x] âœ… æ·»åŠ  `product` è¡¨è¯„åˆ†å­—æ®µï¼ˆrating, review_countï¼‰
- [x] âœ… æ·»åŠ  `staff` è¡¨è¯„åˆ†å­—æ®µï¼ˆrating, review_count, 4ä¸ªè¯¦ç»†è¯„åˆ†ï¼‰
- [x] âœ… åˆ›å»º `rating_tag` è¯„ä»·æ ‡ç­¾è¡¨
- [x] âœ… åˆå§‹åŒ–æ ‡ç­¾æ•°æ®ï¼ˆ26ä¸ªé¢„è®¾æ ‡ç­¾ï¼‰

**SQLè„šæœ¬**: `jiayou-admin-service/src/main/resources/sql/6.rating_system.sql`

### ğŸ”§ å®ä½“ç±» (Entity)

**è·¯å¾„**: `jiayou-common/src/main/java/com/jiayou/common/entity/`

- [x] âœ… `OrderRating.java` - è®¢å•è¯„ä»·å®ä½“ï¼ˆå·²ä¼˜åŒ–ï¼ŒåŒ…å«è¯¦ç»†è¯„åˆ†å’Œæ ‡ç­¾ï¼‰
- [x] âœ… `RatingTag.java` - è¯„ä»·æ ‡ç­¾å®ä½“
- [x] âœ… `Product.java` - æ·»åŠ è¯„åˆ†å­—æ®µï¼ˆrating, reviewCountï¼‰
- [x] âœ… `Staff.java` - æ·»åŠ è¯„åˆ†å­—æ®µï¼ˆrating, reviewCount, 4ä¸ªè¯¦ç»†è¯„åˆ†ï¼‰

### ğŸ“ DTOç±»

**è·¯å¾„**: `jiayou-miniprogram-service/src/main/java/com/jiayou/miniprogram/dto/`

#### è¯·æ±‚DTO
- [x] âœ… `OrderRatingRequest.java` - æäº¤è¯„ä»·è¯·æ±‚
- [x] âœ… `RatingReplyRequest.java` - å›å¤è¯„ä»·è¯·æ±‚
- [x] âœ… `RatingQueryRequest.java` - æŸ¥è¯¢è¯„ä»·è¯·æ±‚ï¼ˆç»§æ‰¿ PageRequestï¼‰

#### å“åº”DTO
- [x] âœ… `OrderRatingResponse.java` - è¯„ä»·è¯¦æƒ…å“åº”
- [x] âœ… `ProductRatingListResponse.java` - å•†å“è¯„ä»·åˆ—è¡¨å“åº”ï¼ˆåŒ…å«ç»Ÿè®¡æ‘˜è¦ï¼‰
- [ ] âš ï¸ `RatingStatisticsResponse.java` - è¯„ä»·ç»Ÿè®¡å“åº”ï¼ˆéƒ¨åˆ†å®ç°åœ¨ ProductRatingListResponse ä¸­ï¼‰

### ğŸ—„ï¸ Mapperæ¥å£

**è·¯å¾„**: `jiayou-common/src/main/java/com/jiayou/common/mapper/`

- [x] âœ… `OrderRatingMapper.java` - è®¢å•è¯„ä»·Mapper
- [x] âœ… `RatingTagMapper.java` - è¯„ä»·æ ‡ç­¾Mapper

### ğŸ”¨ Serviceå±‚

**è·¯å¾„**: `jiayou-miniprogram-service/src/main/java/com/jiayou/miniprogram/service/`

#### æ¥å£
- [x] âœ… `OrderRatingService.java` - è®¢å•è¯„ä»·æœåŠ¡æ¥å£ï¼ˆ11ä¸ªæ–¹æ³•ï¼‰
- [x] âœ… `RatingTagService.java` - è¯„ä»·æ ‡ç­¾æœåŠ¡æ¥å£

#### å®ç°
- [x] âœ… `OrderRatingServiceImpl.java` - è®¢å•è¯„ä»·æœåŠ¡å®ç°
  - âœ… æäº¤è¯„ä»·ï¼ˆå«ç§¯åˆ†å¥–åŠ±ï¼‰
  - âœ… è·å–è¯„ä»·è¯¦æƒ…
  - âœ… ä¿®æ”¹è¯„ä»·ï¼ˆ15å¤©å†…ã€1æ¬¡é™åˆ¶ã€è¯„åˆ†ä¸å¯æ”¹ï¼‰
  - âœ… åˆ é™¤è¯„ä»·ï¼ˆ15å¤©å†…ã€é€»è¾‘åˆ é™¤ï¼‰
  - âœ… è·å–æˆ‘çš„è¯„ä»·åˆ—è¡¨ï¼ˆæ’é™¤å·²åˆ é™¤ï¼‰
  - âœ… è·å–å•†å“è¯„ä»·åˆ—è¡¨
  - âœ… é˜¿å§¨å›å¤è¯„ä»·
  - âœ… è·å–é˜¿å§¨è¯„ä»·åˆ—è¡¨
  - âœ… è·å–é˜¿å§¨è¯„ä»·ç»Ÿè®¡
- [x] âœ… `RatingTagServiceImpl.java` - è¯„ä»·æ ‡ç­¾æœåŠ¡å®ç°

### ğŸ® Controllerå±‚

**è·¯å¾„**: `jiayou-miniprogram-service/src/main/java/com/jiayou/miniprogram/controller/`

- [x] âœ… `UserRatingController.java` - ç”¨æˆ·è¯„ä»·æ§åˆ¶å™¨ï¼ˆ7ä¸ªæ¥å£ï¼‰
  - POST `/user/order/{orderId}/rating` - æäº¤è¯„ä»·
  - GET `/user/order/{orderId}/rating` - è·å–è¯„ä»·è¯¦æƒ…
  - PUT `/user/order/{orderId}/rating` - ä¿®æ”¹è¯„ä»·
  - DELETE `/user/order/{orderId}/rating` - åˆ é™¤è¯„ä»·
  - GET `/user/ratings` - æˆ‘çš„è¯„ä»·åˆ—è¡¨
  - GET `/user/ratings/tags` - è·å–æ ‡ç­¾åˆ—è¡¨
  - GET `/user/products/{productId}/ratings` - å•†å“è¯„ä»·åˆ—è¡¨
  
- [x] âœ… `StaffRatingController.java` - é˜¿å§¨è¯„ä»·æ§åˆ¶å™¨ï¼ˆ3ä¸ªæ¥å£ï¼‰
  - GET `/staff/ratings` - é˜¿å§¨è¯„ä»·åˆ—è¡¨
  - POST `/staff/ratings/{ratingId}/reply` - å›å¤è¯„ä»·
  - GET `/staff/ratings/statistics` - è¯„ä»·ç»Ÿè®¡

### â° å®šæ—¶ä»»åŠ¡

**è·¯å¾„**: `jiayou-miniprogram-service/src/main/java/com/jiayou/miniprogram/task/`

- [x] âœ… `ProductRatingUpdateTask.java` - å•†å“è¯„åˆ†æ›´æ–°ä»»åŠ¡
  - æ‰§è¡Œé¢‘ç‡ï¼šæ¯10åˆ†é’Ÿ
  - åˆ†å¸ƒå¼é”ï¼š`product:rating:update`
  
- [x] âœ… `StaffRatingUpdateTask.java` - é˜¿å§¨è¯„åˆ†æ›´æ–°ä»»åŠ¡
  - æ‰§è¡Œé¢‘ç‡ï¼šæ¯10åˆ†é’Ÿ
  - åˆ†å¸ƒå¼é”ï¼š`staff:rating:update`

### ğŸ” åˆ†å¸ƒå¼é”

**è·¯å¾„**: `jiayou-miniprogram-service/src/main/java/com/jiayou/miniprogram/lock/`

- [x] âœ… `DistributedLock.java` - åˆ†å¸ƒå¼é”æ³¨è§£
- [x] âœ… `DistributedLockAspect.java` - åˆ†å¸ƒå¼é”AOPå®ç°ï¼ˆåŸºäº Redissonï¼‰

### ğŸ“š æ–‡æ¡£æ›´æ–°

- [x] âœ… æ›´æ–° `å°ç¨‹åºAPIæ¥å£æ–‡æ¡£.md`ï¼ˆæ·»åŠ 11ä¸ªè¯„ä»·ç›¸å…³æ¥å£ï¼‰
- [x] âœ… åˆ›å»º `è¯„ä»·è¯„åˆ†ä½“ç³»å®Œæ•´è®¾è®¡æ–‡æ¡£.md`ï¼ˆæœ¬æ–‡æ¡£ï¼‰
- [x] âœ… æ›´æ–° `æ¥å£å¼€å‘è¿›åº¦è·Ÿè¸ª.md`ï¼ˆæ€»æ¥å£æ•° +11ï¼‰

### ğŸ”§ é”™è¯¯ç 

**è·¯å¾„**: `jiayou-common/src/main/java/com/jiayou/common/result/ResultCode.java`

- [x] âœ… æ·»åŠ è¯„ä»·ç›¸å…³é”™è¯¯ç ï¼ˆ2100-2199ï¼‰
  - `RATING_NOT_FOUND` (2100) - è¯„ä»·ä¸å­˜åœ¨
  - `RATING_ALREADY_EXISTS` (2101) - è®¢å•å·²è¯„ä»·
  - `RATING_EDIT_EXPIRED` (2102) - è¯„ä»·ä¿®æ”¹æœŸé™å·²è¿‡
  - `RATING_DELETE_EXPIRED` (2103) - è¯„ä»·åˆ é™¤æœŸé™å·²è¿‡
  - `RATING_SUBMIT_FAILED` (2104) - è¯„ä»·æäº¤å¤±è´¥

---

## ğŸ¯ å¼€å‘ä¼˜å…ˆçº§

### P0 - æ ¸å¿ƒåŠŸèƒ½ï¼ˆå¿…é¡»å®ç°ï¼‰

1. âœ… æ•°æ®åº“è¡¨ç»“æ„ä¼˜åŒ–
2. âœ… å®ä½“ç±»åˆ›å»ºå’Œä¼˜åŒ–
3. âœ… ç”¨æˆ·æäº¤è¯„ä»·æ¥å£
4. âœ… è·å–è¯„ä»·è¯¦æƒ…æ¥å£
5. âœ… è·å–å•†å“è¯„ä»·åˆ—è¡¨æ¥å£
6. âœ… é˜¿å§¨è¯„åˆ†æ›´æ–°å®šæ—¶ä»»åŠ¡

### P1 - é‡è¦åŠŸèƒ½ï¼ˆä¼˜å…ˆå®ç°ï¼‰

1. âœ… è·å–æˆ‘çš„è¯„ä»·åˆ—è¡¨æ¥å£
2. âœ… é˜¿å§¨å›å¤è¯„ä»·æ¥å£
3. âœ… è¯„ä»·æ ‡ç­¾ç®¡ç†
4. âœ… ç§¯åˆ†å¥–åŠ±æœºåˆ¶
5. âœ… è¯„ä»·ç»Ÿè®¡æ¥å£

### P2 - å¢å¼ºåŠŸèƒ½ï¼ˆåç»­å®ç°ï¼‰

1. âœ… ä¿®æ”¹è¯„ä»·æ¥å£
2. âœ… åˆ é™¤è¯„ä»·æ¥å£
3. â¬œ è¯„ä»·ä¸¾æŠ¥åŠŸèƒ½
4. â¬œ ç®¡ç†ç«¯è¯„ä»·ç®¡ç†

---

## ğŸ“Š é¢„æœŸæ•ˆæœ

### ç”¨æˆ·ç«¯

1. **æå‡ç”¨æˆ·å‚ä¸åº¦**
   - ç§¯åˆ†å¥–åŠ±æœºåˆ¶æ¿€åŠ±ç”¨æˆ·è¯„ä»·
   - å¤šç»´åº¦è¯„åˆ†æä¾›æ›´è¯¦ç»†çš„åé¦ˆ
   - å›¾ç‰‡å’Œæ ‡ç­¾è®©è¯„ä»·æ›´ç”ŸåŠ¨

2. **å¢å¼ºä¿¡ä»»åº¦**
   - çœŸå®è¯„ä»·å±•ç¤ºæœåŠ¡è´¨é‡
   - è¯„åˆ†åˆ†å¸ƒå›¾ç›´è§‚å±•ç¤ºå£ç¢‘
   - å•†å®¶å›å¤å¢å¼ºäº’åŠ¨

### é˜¿å§¨ç«¯

1. **æå‡æœåŠ¡è´¨é‡**
   - è¯¦ç»†è¯„åˆ†å¸®åŠ©å‘ç°æ”¹è¿›ç‚¹
   - è¯„ä»·è¶‹åŠ¿å›¾å±•ç¤ºè¿›æ­¥
   - æ ‡ç­¾ç»Ÿè®¡æ˜ç¡®ä¼˜åŠ¿å’Œä¸è¶³

2. **å¢å¼ºèŒä¸šè®¤åŒ**
   - å¥½è¯„æ¿€åŠ±æå‡æœåŠ¡ç§¯ææ€§
   - è¯„åˆ†æ’åä¿ƒè¿›è‰¯æ€§ç«äº‰
   - å›å¤è¯„ä»·å¢å¼ºä¸ç”¨æˆ·äº’åŠ¨

### å¹³å°ç«¯

1. **æå‡å¹³å°å£ç¢‘**
   - é«˜è´¨é‡è¯„ä»·å¸å¼•æ–°ç”¨æˆ·
   - è¯„åˆ†ä½“ç³»å¢å¼ºå¹³å°å…¬ä¿¡åŠ›
   - æ•°æ®åˆ†æä¼˜åŒ–è¿è¥ç­–ç•¥

2. **ä¼˜åŒ–èµ„æºé…ç½®**
   - è¯„åˆ†æ•°æ®è¾…åŠ©é˜¿å§¨æ¨è
   - æœåŠ¡è´¨é‡ç›‘æ§åŠæ—¶é¢„è­¦
   - ç”¨æˆ·åå¥½åˆ†ææŒ‡å¯¼äº§å“ä¼˜åŒ–

---

## ğŸ” å®‰å…¨ä¸é£æ§

### 1. è¯„ä»·çœŸå®æ€§ä¿éšœ

- **è®¢å•å…³è”éªŒè¯**: åªæœ‰å®Œæˆçš„è®¢å•æ‰èƒ½è¯„ä»·
- **ä¸€å•ä¸€è¯„**: æ¯ä¸ªè®¢å•åªèƒ½è¯„ä»·ä¸€æ¬¡
- **æ—¶æ•ˆé™åˆ¶**: è®¢å•å®Œæˆå30å¤©å†…å¯è¯„ä»·
- **ä¿®æ”¹é™åˆ¶**: è¯„ä»·æäº¤å15å¤©å†…å¯ä¿®æ”¹ï¼Œä»…é™1æ¬¡
- **è¯„åˆ†ä¿æŠ¤**: ç»¼åˆè¯„åˆ†ä¸å¯ä¿®æ”¹ï¼Œä¿è¯æ ¸å¿ƒæŒ‡æ ‡ç¨³å®š
- **é€»è¾‘åˆ é™¤**: åˆ é™¤çš„è¯„ä»·æ•°æ®ä¿ç•™ï¼Œç”¨äºé£æ§åˆ†æ

### 2. æ¶æ„è¯„ä»·é˜²èŒƒ

- **æ•æ„Ÿè¯è¿‡æ»¤**: è‡ªåŠ¨è¿‡æ»¤è¿è§„å†…å®¹
- **ä¸¾æŠ¥æœºåˆ¶**: ç”¨æˆ·å¯ä¸¾æŠ¥ä¸å®è¯„ä»·
- **äººå·¥å®¡æ ¸**: ä½åˆ†è¯„ä»·äººå·¥å¤æ ¸
- **é»‘åå•æœºåˆ¶**: æ¶æ„è¯„ä»·ç”¨æˆ·æ‹‰é»‘

### 3. åˆ·è¯„é˜²èŒƒ

- **IPé™åˆ¶**: åŒä¸€IPçŸ­æ—¶é—´å†…è¯„ä»·æ¬¡æ•°é™åˆ¶
- **è®¾å¤‡é™åˆ¶**: åŒä¸€è®¾å¤‡çŸ­æ—¶é—´å†…è¯„ä»·æ¬¡æ•°é™åˆ¶
- **è¡Œä¸ºåˆ†æ**: å¼‚å¸¸è¯„ä»·è¡Œä¸ºæ£€æµ‹
- **è¯„ä»·è´¨é‡è¯„åˆ†**: ä½è´¨é‡è¯„ä»·é™æƒ

---

## ğŸ“ˆ æ•°æ®åˆ†æä¸ä¼˜åŒ–

### 1. è¯„ä»·æ•°æ®åˆ†æ

- **è¯„ä»·ç‡ç»Ÿè®¡**: è®¢å•å®Œæˆåè¯„ä»·ç‡
- **è¯„åˆ†åˆ†å¸ƒ**: å„æ˜Ÿçº§è¯„ä»·å æ¯”
- **æ ‡ç­¾çƒ­åº¦**: é«˜é¢‘æ ‡ç­¾ç»Ÿè®¡
- **è¯„ä»·è¶‹åŠ¿**: è¯„ä»·æ•°é‡å’Œè¯„åˆ†è¶‹åŠ¿

### 2. æœåŠ¡è´¨é‡ç›‘æ§

- **é˜¿å§¨è¯„åˆ†æ’å**: å®šæœŸè¯„åˆ†æ’å
- **ä½åˆ†é¢„è­¦**: è¯„åˆ†ä¸‹é™é¢„è­¦
- **æŠ•è¯‰å…³è”**: è¯„ä»·ä¸æŠ•è¯‰å…³è”åˆ†æ
- **æœåŠ¡æ”¹è¿›**: åŸºäºè¯„ä»·çš„æ”¹è¿›å»ºè®®

### 3. ç”¨æˆ·è¡Œä¸ºåˆ†æ

- **è¯„ä»·åå¥½**: ç”¨æˆ·è¯„ä»·ä¹ æƒ¯åˆ†æ
- **æ ‡ç­¾åå¥½**: ç”¨æˆ·å…³æ³¨ç‚¹åˆ†æ
- **å›¾ç‰‡ä¸Šä¼ ç‡**: å›¾ç‰‡è¯„ä»·å æ¯”
- **åŒ¿åç‡**: åŒ¿åè¯„ä»·å æ¯”

---

## ğŸš€ åç»­ä¼˜åŒ–æ–¹å‘

### çŸ­æœŸä¼˜åŒ–ï¼ˆ1-3ä¸ªæœˆï¼‰

1. **è¯„ä»·è´¨é‡æå‡**
   - AIè¾…åŠ©è¯„ä»·å†…å®¹ç”Ÿæˆ
   - è¯„ä»·æ¨¡æ¿æ¨è
   - è¯­éŸ³è½¬æ–‡å­—è¯„ä»·

2. **äº’åŠ¨å¢å¼º**
   - è¯„ä»·ç‚¹èµåŠŸèƒ½
   - è¯„ä»·è¯„è®ºåŠŸèƒ½
   - ä¼˜è´¨è¯„ä»·æ¨è

3. **æ•°æ®å¯è§†åŒ–**
   - è¯„ä»·æ•°æ®å¤§å±
   - ä¸ªäººè¯„ä»·æŠ¥å‘Š
   - æœåŠ¡è´¨é‡æŠ¥å‘Š

### ä¸­æœŸä¼˜åŒ–ï¼ˆ3-6ä¸ªæœˆï¼‰

1. **æ™ºèƒ½æ¨è**
   - åŸºäºè¯„ä»·çš„é˜¿å§¨æ¨è
   - åŸºäºè¯„ä»·çš„æœåŠ¡æ¨è
   - ä¸ªæ€§åŒ–è¯„ä»·æ ‡ç­¾

2. **ç¤¾äº¤åŒ–**
   - è¯„ä»·åˆ†äº«åŠŸèƒ½
   - è¯„ä»·æ’è¡Œæ¦œ
   - ä¼˜è´¨è¯„ä»·å®˜è®¤è¯

3. **æ¿€åŠ±æœºåˆ¶**
   - è¯„ä»·å‹‹ç« ç³»ç»Ÿ
   - è¯„ä»·ç­‰çº§ä½“ç³»
   - ä¸“å±è¯„ä»·æƒç›Š

### é•¿æœŸä¼˜åŒ–ï¼ˆ6-12ä¸ªæœˆï¼‰

1. **AIèµ‹èƒ½**
   - è¯„ä»·æƒ…æ„Ÿåˆ†æ
   - æœåŠ¡è´¨é‡é¢„æµ‹
   - æ™ºèƒ½å®¢æœå›å¤

2. **ç”Ÿæ€å»ºè®¾**
   - è¯„ä»·å¼€æ”¾å¹³å°
   - ç¬¬ä¸‰æ–¹è¯„ä»·æ¥å…¥
   - è·¨å¹³å°è¯„ä»·äº’è®¤

3. **å›½é™…åŒ–**
   - å¤šè¯­è¨€è¯„ä»·æ”¯æŒ
   - å›½é™…åŒ–è¯„åˆ†æ ‡å‡†
   - è·¨å¢ƒè¯„ä»·ä½“ç³»

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰ç–‘é—®ï¼Œè¯·è”ç³»ï¼š
- **æŠ€æœ¯è´Ÿè´£äºº**: [æŠ€æœ¯å›¢é˜Ÿ]
- **äº§å“è´Ÿè´£äºº**: [äº§å“å›¢é˜Ÿ]
- **æ–‡æ¡£ç»´æŠ¤**: [å¼€å‘å›¢é˜Ÿ]

---

## éƒ¨ç½²è¯´æ˜

### 1. æ•°æ®åº“éƒ¨ç½²

**æ­¥éª¤**:

1. **å¤‡ä»½æ•°æ®åº“**ï¼ˆé‡è¦ï¼ï¼‰ï¼š
   ```bash
   mysqldump -u username -p database_name > backup_$(date +%Y%m%d_%H%M%S).sql
   ```

2. **æ‰§è¡ŒSQLè„šæœ¬**ï¼š
   ```bash
   # ç¬¬ä¸€æ­¥ï¼šæ‰§è¡Œè¯„ä»·ç³»ç»ŸåŸºç¡€è„šæœ¬
   mysql -u username -p database_name < jiayou-admin-service/src/main/resources/sql/6.rating_system.sql
   
   # ç¬¬äºŒæ­¥ï¼šæ‰§è¡Œä¿®æ”¹/åˆ é™¤ä¼˜åŒ–è„šæœ¬ï¼ˆv1.1.0 æ–°å¢ï¼‰
   mysql -u username -p database_name < jiayou-admin-service/src/main/resources/sql/7.rating_edit_delete_optimization.sql
   ```

3. **éªŒè¯è¡¨ç»“æ„**ï¼š
   ```sql
   -- æ£€æŸ¥ order_rating è¡¨ï¼ˆåŒ…å«æ–°å¢å­—æ®µï¼‰
   DESC order_rating;
   
   -- éªŒè¯æ–°å¢å­—æ®µ
   SELECT COLUMN_NAME, COLUMN_TYPE, COLUMN_COMMENT 
   FROM INFORMATION_SCHEMA.COLUMNS 
   WHERE TABLE_SCHEMA = DATABASE() 
   AND TABLE_NAME = 'order_rating' 
   AND COLUMN_NAME IN ('edit_count', 'edit_time', 'deleted_time');
   
   -- æ£€æŸ¥ product è¡¨è¯„åˆ†å­—æ®µ
   DESC product;
   
   -- æ£€æŸ¥ staff è¡¨è¯„åˆ†å­—æ®µ
   DESC staff;
   
   -- æ£€æŸ¥ rating_tag è¡¨
   DESC rating_tag;
   SELECT COUNT(*) FROM rating_tag; -- åº”è¯¥æœ‰26æ¡è®°å½•
   ```

**æ³¨æ„äº‹é¡¹**:
- âš ï¸ SQLè„šæœ¬ä¸åŒ…å« `IF NOT EXISTS`ï¼Œå¦‚æœè¡¨/å­—æ®µå·²å­˜åœ¨ä¼šæŠ¥é”™ï¼Œå¯å¿½ç•¥
- âš ï¸ å»ºè®®åœ¨æµ‹è¯•ç¯å¢ƒå…ˆæ‰§è¡Œï¼ŒéªŒè¯æ— è¯¯åå†éƒ¨ç½²ç”Ÿäº§ç¯å¢ƒ
- âš ï¸ æ‰§è¡Œå‰è¯·å¤‡ä»½æ•°æ®åº“
- ğŸ’¡ å¦‚æœå·²ç»éƒ¨ç½²äº†v1.0.0ï¼Œåªéœ€æ‰§è¡Œç¬¬7ä¸ªè„šæœ¬å³å¯

### 2. åº”ç”¨éƒ¨ç½²

**ä¾èµ–æ£€æŸ¥**:
- âœ… Redisï¼ˆç”¨äºåˆ†å¸ƒå¼é”ï¼‰
- âœ… Redissonï¼ˆå·²é…ç½®åœ¨é¡¹ç›®ä¸­ï¼‰
- âœ… Spring Boot 3.2.0
- âœ… MyBatis-Plus 3.5.7

**é…ç½®æ£€æŸ¥**:

1. Redisé…ç½®ï¼ˆ`application.yml`ï¼‰ï¼š
   ```yaml
   spring:
     data:
       redis:
         host: localhost
         port: 6379
         # å…¶ä»–é…ç½®...
   ```

2. å®šæ—¶ä»»åŠ¡é…ç½®ï¼ˆé»˜è®¤å·²å¯ç”¨ï¼‰ï¼š
   ```yaml
   spring:
     task:
       scheduling:
         enabled: true
   ```

**éƒ¨ç½²æ­¥éª¤**:

1. ç¼–è¯‘æ‰“åŒ…ï¼š
   ```bash
   mvn clean package -DskipTests
   ```

2. å¯åŠ¨åº”ç”¨ï¼š
   ```bash
   java -jar jiayou-miniprogram-service/target/jiayou-miniprogram-service.jar
   ```

3. éªŒè¯éƒ¨ç½²ï¼š
   - æ£€æŸ¥æ—¥å¿—ä¸­æ˜¯å¦æœ‰å®šæ—¶ä»»åŠ¡å¯åŠ¨æ—¥å¿—
   - è®¿é—® Swagger æ–‡æ¡£éªŒè¯æ¥å£ï¼š`http://localhost:8080/doc.html`
   - æµ‹è¯•è¯„ä»·æ¥å£

### 3. åŠŸèƒ½éªŒè¯

**æµ‹è¯•æ¸…å•**:

- [ ] æäº¤è®¢å•è¯„ä»·ï¼ˆåŒ…å«è¯¦ç»†è¯„åˆ†ã€æ ‡ç­¾ã€å›¾ç‰‡ï¼‰
- [ ] è·å–è¯„ä»·è¯¦æƒ…
- [ ] ä¿®æ”¹è¯„ä»·
- [ ] åˆ é™¤è¯„ä»·
- [ ] è·å–æˆ‘çš„è¯„ä»·åˆ—è¡¨
- [ ] ç‚¹èµè¯„ä»·
- [ ] è·å–è¯„ä»·æ ‡ç­¾åˆ—è¡¨
- [ ] è·å–å•†å“è¯„ä»·åˆ—è¡¨
- [ ] é˜¿å§¨å›å¤è¯„ä»·
- [ ] è·å–é˜¿å§¨è¯„ä»·åˆ—è¡¨
- [ ] è·å–é˜¿å§¨è¯„ä»·ç»Ÿè®¡
- [ ] å•†å“è¯„åˆ†å®šæ—¶æ›´æ–°ï¼ˆç­‰å¾…10åˆ†é’Ÿåæ£€æŸ¥ï¼‰
- [ ] é˜¿å§¨è¯„åˆ†å®šæ—¶æ›´æ–°ï¼ˆç­‰å¾…10åˆ†é’Ÿåæ£€æŸ¥ï¼‰

**æµ‹è¯•æ•°æ®å‡†å¤‡**:

```sql
-- 1. ç¡®ä¿æœ‰å·²å®Œæˆçš„è®¢å•
UPDATE `order` SET status = 'COMPLETED' WHERE id = 1;

-- 2. ç¡®ä¿æœ‰æ´»è·ƒçš„å•†å“
UPDATE product SET status = 'ACTIVE', is_on_sale = 1 WHERE id = 1;

-- 3. ç¡®ä¿æœ‰æ´»è·ƒçš„é˜¿å§¨
UPDATE staff SET status = 'ACTIVE', certification_status = 'APPROVED' WHERE id = 1;
```

---

## å·²çŸ¥é—®é¢˜

### 1. åŠŸèƒ½é™åˆ¶

| é—®é¢˜ | å½±å“ | ä¼˜å…ˆçº§ | è®¡åˆ’ä¿®å¤ç‰ˆæœ¬ |
|------|------|--------|-------------|
| å•†å“è¯„ä»·åˆ—è¡¨ç»Ÿè®¡åŠŸèƒ½æœªå®Œå…¨å®ç° | è¯„åˆ†åˆ†å¸ƒã€æ ‡ç­¾ç»Ÿè®¡ç­‰æ•°æ®ä¸å®Œæ•´ | P1 | v1.1.0 |
| ç®¡ç†ç«¯è¯„ä»·ç®¡ç†åŠŸèƒ½æœªå®ç° | æ— æ³•éšè—/æ˜¾ç¤ºè¯„ä»· | P2 | v1.2.0 |
| è¯„ä»·ä¸¾æŠ¥åŠŸèƒ½æœªå®ç° | æ— æ³•ä¸¾æŠ¥ä¸å®è¯„ä»· | P2 | v1.2.0 |
| è¯„ä»·è¶‹åŠ¿åˆ†ææœªå®ç° | æ— æ³•æŸ¥çœ‹è¯„åˆ†è¶‹åŠ¿å›¾ | P3 | v1.3.0 |

### 2. æ€§èƒ½é—®é¢˜

| é—®é¢˜ | å½±å“ | è§£å†³æ–¹æ¡ˆ | çŠ¶æ€ |
|------|------|---------|------|
| å®šæ—¶ä»»åŠ¡å¯èƒ½æ‰§è¡Œæ—¶é—´è¿‡é•¿ | å•†å“/é˜¿å§¨æ•°é‡å¤šæ—¶å¯èƒ½è¶…è¿‡10åˆ†é’Ÿ | åˆ†æ‰¹å¤„ç†æˆ–å¢åŠ æ‰§è¡Œé¢‘ç‡ | å¾…ä¼˜åŒ– |
| è¯„ä»·åˆ—è¡¨æŸ¥è¯¢æœªä¼˜åŒ– | æ•°æ®é‡å¤§æ—¶æŸ¥è¯¢æ…¢ | æ·»åŠ ç´¢å¼•ã€ä½¿ç”¨ç¼“å­˜ | å¾…ä¼˜åŒ– |
| å›¾ç‰‡ä¸Šä¼ æœªåšå‹ç¼© | å›¾ç‰‡è¿‡å¤§å½±å“åŠ è½½é€Ÿåº¦ | å‰ç«¯å‹ç¼©æˆ–åç«¯å‹ç¼© | å¾…ä¼˜åŒ– |

### 3. æ•°æ®ä¸€è‡´æ€§

| é—®é¢˜ | å½±å“ | è§£å†³æ–¹æ¡ˆ | çŠ¶æ€ |
|------|------|---------|------|
| è¯„åˆ†æ›´æ–°æœ‰å»¶è¿Ÿ | æäº¤è¯„ä»·åè¯„åˆ†ä¸ä¼šç«‹å³æ›´æ–° | æ­£å¸¸ï¼Œå®šæ—¶ä»»åŠ¡10åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡ | è®¾è®¡å¦‚æ­¤ |
| ç‚¹èµæ•°å¯èƒ½ä¸å‡†ç¡® | é«˜å¹¶å‘æ—¶å¯èƒ½å‡ºç°è®¡æ•°åå·® | ä½¿ç”¨ Redis è®¡æ•°å™¨ | å¾…ä¼˜åŒ– |

### 4. å®‰å…¨é—®é¢˜

| é—®é¢˜ | å½±å“ | è§£å†³æ–¹æ¡ˆ | çŠ¶æ€ |
|------|------|---------|------|
| æ•æ„Ÿè¯è¿‡æ»¤æœªå®ç° | å¯èƒ½å‡ºç°è¿è§„è¯„ä»·å†…å®¹ | æ¥å…¥æ•æ„Ÿè¯è¿‡æ»¤æœåŠ¡ | å¾…å®ç° |
| åˆ·è¯„é˜²èŒƒæœªå®ç° | å¯èƒ½å‡ºç°æ¶æ„åˆ·è¯„ | æ·»åŠ IP/è®¾å¤‡é™åˆ¶ã€è¡Œä¸ºåˆ†æ | å¾…å®ç° |
| å›¾ç‰‡å†…å®¹å®¡æ ¸æœªå®ç° | å¯èƒ½ä¸Šä¼ è¿è§„å›¾ç‰‡ | æ¥å…¥å›¾ç‰‡å®¡æ ¸æœåŠ¡ | å¾…å®ç° |

### 5. å…¼å®¹æ€§é—®é¢˜

| é—®é¢˜ | å½±å“ | è§£å†³æ–¹æ¡ˆ | çŠ¶æ€ |
|------|------|---------|------|
| SQLè„šæœ¬ä¸æ”¯æŒ `IF NOT EXISTS` | éƒ¨åˆ†æ•°æ®åº“ç‰ˆæœ¬æ‰§è¡Œå¤±è´¥ | å·²ç§»é™¤ `IF NOT EXISTS` | âœ… å·²ä¿®å¤ |
| è¯„ä»·å›¾ç‰‡æ ¼å¼é™åˆ¶ | æœªé™åˆ¶å›¾ç‰‡æ ¼å¼å’Œå¤§å° | æ·»åŠ æ ¼å¼å’Œå¤§å°éªŒè¯ | å¾…ä¼˜åŒ– |

### 6. å¾…ä¼˜åŒ–é¡¹

**çŸ­æœŸä¼˜åŒ–ï¼ˆ1ä¸ªæœˆå†…ï¼‰**:
- [ ] å®Œå–„å•†å“è¯„ä»·åˆ—è¡¨ç»Ÿè®¡åŠŸèƒ½
- [ ] ä¼˜åŒ–å®šæ—¶ä»»åŠ¡æ‰§è¡Œæ•ˆç‡
- [ ] æ·»åŠ è¯„ä»·åˆ—è¡¨ç¼“å­˜
- [ ] å®ç°æ•æ„Ÿè¯è¿‡æ»¤

**ä¸­æœŸä¼˜åŒ–ï¼ˆ3ä¸ªæœˆå†…ï¼‰**:
- [ ] å®ç°ç®¡ç†ç«¯è¯„ä»·ç®¡ç†
- [ ] å®ç°è¯„ä»·ä¸¾æŠ¥åŠŸèƒ½
- [ ] ä¼˜åŒ–ç‚¹èµè®¡æ•°å™¨
- [ ] å®ç°åˆ·è¯„é˜²èŒƒ

**é•¿æœŸä¼˜åŒ–ï¼ˆ6ä¸ªæœˆå†…ï¼‰**:
- [ ] å®ç°è¯„ä»·è¶‹åŠ¿åˆ†æ
- [ ] å®ç°å›¾ç‰‡å†…å®¹å®¡æ ¸
- [ ] å®ç°AIè¾…åŠ©è¯„ä»·ç”Ÿæˆ
- [ ] å®ç°è¯„ä»·è´¨é‡è¯„åˆ†

---

## æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰ç–‘é—®ï¼Œè¯·è”ç³»ï¼š
- **æŠ€æœ¯è´Ÿè´£äºº**: [æŠ€æœ¯å›¢é˜Ÿ]
- **äº§å“è´Ÿè´£äºº**: [äº§å“å›¢é˜Ÿ]
- **æ–‡æ¡£ç»´æŠ¤**: [å¼€å‘å›¢é˜Ÿ]

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.1.0  
**åˆ›å»ºæ—¥æœŸ**: 2025-10-13  
**æœ€åæ›´æ–°**: 2025-10-13  
**ä½œè€…**: å®¶æ”¿å¹³å°æŠ€æœ¯å›¢é˜Ÿ

