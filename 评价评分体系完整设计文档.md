# 家政平台评价评分体系完整设计文档

> **文档状态**: ✅ 已实现核心功能  
> **最后更新**: 2025-10-13  
> **实现进度**: 核心功能 100% | 增强功能 85%

## 📋 目录

1. [系统概述](#系统概述)
2. [数据库设计](#数据库设计)
3. [业务逻辑设计](#业务逻辑设计)
4. [接口设计](#接口设计)
5. [前端交互流程](#前端交互流程)
6. [评分计算规则](#评分计算规则)
7. [定时任务设计](#定时任务设计)
8. [实现清单](#实现清单)
9. [部署说明](#部署说明)
10. [已知问题](#已知问题)

---

## 系统概述

### 🎯 设计目标

构建一个完整的三级评价评分体系：
1. **用户评价订单** → 对单次服务进行评价
2. **商品评分** → 基于所有订单评价计算商品平均分
3. **阿姨评分** → 基于所有订单评价计算阿姨服务质量评分

### 📊 核心指标

| 评价对象 | 评分范围 | 更新频率 | 数据来源 |
|---------|---------|---------|---------|
| 订单评价 | 1-5分 | 实时 | 用户提交 |
| 商品评分 | 1.0-5.0分 | 每10分钟 | 订单评价聚合 |
| 阿姨评分 | 1.0-5.0分 | 每10分钟 | 订单评价聚合 |

### 🔄 数据流转

```
用户提交评价
    ↓
订单评价表 (order_rating)
    ↓
定时任务聚合计算
    ↓         ↓
商品评分更新  阿姨评分更新
(product表)  (staff表)
```

---

## 数据库设计

> **实现状态**: ✅ 已完成  
> **SQL脚本**: `jiayou-admin-service/src/main/resources/sql/6.rating_system.sql`

### 1. 订单评价表 (order_rating)

**实现状态**: ✅ 已完成（含修改/删除优化）

**SQL脚本**:
- 基础结构：`6.rating_system.sql`
- 修改/删除优化：`7.rating_edit_delete_optimization.sql`

**表结构优化**：

```sql
-- ========================================
-- 订单评价表结构优化（基础字段）
-- ========================================

-- 1. 添加缺失字段
ALTER TABLE `order_rating`
ADD COLUMN `product_id` BIGINT(20) NULL COMMENT '商品ID' AFTER `user_id`,
ADD COLUMN `content` VARCHAR(1000) NULL COMMENT '评价内容' AFTER `score`,
ADD COLUMN `images` VARCHAR(1000) NULL COMMENT '评价图片JSON数组' AFTER `content`,
ADD COLUMN `status` VARCHAR(20) DEFAULT 'PUBLISHED' COMMENT '评价状态: DRAFT-草稿, PUBLISHED-已发布, HIDDEN-已隐藏, DELETED-已删除' AFTER `images`,
ADD COLUMN `is_anonymous` TINYINT(1) DEFAULT 0 COMMENT '是否匿名: 0-否, 1-是' AFTER `status`,
ADD COLUMN `reply_content` VARCHAR(500) NULL COMMENT '商家回复内容' AFTER `is_anonymous`,
ADD COLUMN `reply_time` DATETIME NULL COMMENT '商家回复时间' AFTER `reply_content`;

-- 2. 添加详细评分维度
ALTER TABLE `order_rating`
ADD COLUMN `service_attitude_score` TINYINT(1) NULL COMMENT '服务态度评分: 1-5' AFTER `score`,
ADD COLUMN `service_quality_score` TINYINT(1) NULL COMMENT '服务质量评分: 1-5' AFTER `service_attitude_score`,
ADD COLUMN `punctuality_score` TINYINT(1) NULL COMMENT '准时性评分: 1-5' AFTER `service_quality_score`,
ADD COLUMN `cleanliness_score` TINYINT(1) NULL COMMENT '清洁度评分: 1-5' AFTER `punctuality_score`;

-- 3. 添加标签字段
ALTER TABLE `order_rating`
ADD COLUMN `tags` VARCHAR(500) NULL COMMENT '评价标签JSON数组，如["服务好","很专业","准时"]' AFTER `cleanliness_score`;

-- 4. 添加修改/删除相关字段（v1.1.0 新增）
ALTER TABLE `order_rating`
ADD COLUMN `edit_count` INT DEFAULT 0 COMMENT '修改次数' AFTER `status`,
ADD COLUMN `edit_time` DATETIME NULL COMMENT '最后编辑时间' AFTER `edit_count`,
ADD COLUMN `deleted_time` DATETIME NULL COMMENT '删除时间' AFTER `edit_time`;

-- 5. 添加索引
ALTER TABLE `order_rating`
ADD INDEX `idx_product_id` (`product_id`),
ADD INDEX `idx_status` (`status`),
ADD INDEX `idx_created_time` (`created_time`),
ADD INDEX `idx_edit_count` (`edit_count`);
```

**关键字段说明**:
- `status`: 新增 `DELETED` 状态，用于逻辑删除
- `edit_count`: 记录修改次数，限制为1次
- `edit_time`: 记录最后编辑时间，用于显示"已编辑"标签
- `deleted_time`: 记录删除时间，用于数据分析

### 2. 商品表 (product)

**实现状态**: ✅ 已完成

**已添加评分字段**：

```sql
-- product 表已有字段
-- rating DECIMAL(3,1) DEFAULT 5.0 COMMENT '商品评分（1.0-5.0）'
-- review_count INT DEFAULT 0 COMMENT '评价数量'
```

### 3. 阿姨表 (staff)

**实现状态**: ✅ 已完成

**添加评分字段**：

```sql
-- ========================================
-- 阿姨表评分字段
-- ========================================

ALTER TABLE `staff`
ADD COLUMN IF NOT EXISTS `rating` DECIMAL(3,1) DEFAULT 5.0 COMMENT '阿姨评分（1.0-5.0）' AFTER `status`,
ADD COLUMN IF NOT EXISTS `review_count` INT DEFAULT 0 COMMENT '评价数量' AFTER `rating`,
ADD COLUMN IF NOT EXISTS `service_attitude_rating` DECIMAL(3,1) DEFAULT 5.0 COMMENT '服务态度评分' AFTER `review_count`,
ADD COLUMN IF NOT EXISTS `service_quality_rating` DECIMAL(3,1) DEFAULT 5.0 COMMENT '服务质量评分' AFTER `service_attitude_rating`,
ADD COLUMN IF NOT EXISTS `punctuality_rating` DECIMAL(3,1) DEFAULT 5.0 COMMENT '准时性评分' AFTER `service_quality_rating`,
ADD COLUMN IF NOT EXISTS `cleanliness_rating` DECIMAL(3,1) DEFAULT 5.0 COMMENT '清洁度评分' AFTER `punctuality_rating`;

-- 添加索引
ALTER TABLE `staff`
ADD INDEX IF NOT EXISTS `idx_rating` (`rating`);
```

### 4. 评价标签表 (rating_tag)

**实现状态**: ✅ 已完成（包含26个预设标签）

**新增表**：

```sql
-- ========================================
-- 评价标签表
-- ========================================

CREATE TABLE IF NOT EXISTS `rating_tag` (
  `id` BIGINT(20) NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `tag_name` VARCHAR(50) NOT NULL COMMENT '标签名称',
  `tag_type` VARCHAR(20) NOT NULL COMMENT '标签类型: POSITIVE-正面, NEGATIVE-负面, NEUTRAL-中性',
  `category` VARCHAR(20) NOT NULL COMMENT '标签分类: SERVICE-服务, ATTITUDE-态度, QUALITY-质量, PUNCTUALITY-准时性',
  `icon` VARCHAR(200) NULL COMMENT '标签图标URL',
  `sort_order` INT DEFAULT 0 COMMENT '排序',
  `is_active` TINYINT(1) DEFAULT 1 COMMENT '是否启用: 0-禁用, 1-启用',
  `use_count` INT DEFAULT 0 COMMENT '使用次数',
  `created_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_tag_name` (`tag_name`),
  KEY `idx_tag_type` (`tag_type`),
  KEY `idx_category` (`category`),
  KEY `idx_sort_order` (`sort_order`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='评价标签表';

-- 初始化标签数据
INSERT INTO `rating_tag` (`tag_name`, `tag_type`, `category`, `sort_order`) VALUES
-- 正面标签
('服务好', 'POSITIVE', 'SERVICE', 1),
('很专业', 'POSITIVE', 'SERVICE', 2),
('态度好', 'POSITIVE', 'ATTITUDE', 3),
('很细心', 'POSITIVE', 'ATTITUDE', 4),
('质量高', 'POSITIVE', 'QUALITY', 5),
('很干净', 'POSITIVE', 'QUALITY', 6),
('准时到达', 'POSITIVE', 'PUNCTUALITY', 7),
('效率高', 'POSITIVE', 'SERVICE', 8),
('值得推荐', 'POSITIVE', 'SERVICE', 9),
('会再来', 'POSITIVE', 'SERVICE', 10),
-- 负面标签
('服务差', 'NEGATIVE', 'SERVICE', 11),
('不专业', 'NEGATIVE', 'SERVICE', 12),
('态度不好', 'NEGATIVE', 'ATTITUDE', 13),
('不细心', 'NEGATIVE', 'ATTITUDE', 14),
('质量差', 'NEGATIVE', 'QUALITY', 15),
('不干净', 'NEGATIVE', 'QUALITY', 16),
('迟到', 'NEGATIVE', 'PUNCTUALITY', 17),
('效率低', 'NEGATIVE', 'SERVICE', 18);
```

---

## 业务逻辑设计

### 1. 用户评价订单流程

```
1. 用户完成订单后，可进行评价
   ↓
2. 提交评价内容：
   - 综合评分（1-5分，必填）
   - 详细评分（服务态度、质量、准时性、清洁度，可选）
   - 文字评价（可选）
   - 图片（最多9张，可选）
   - 评价标签（可选）
   - 是否匿名（可选）
   ↓
3. 系统验证：
   - 订单是否已完成
   - 是否已评价过
   - 评分范围是否合法
   ↓
4. 保存评价记录
   ↓
5. 触发异步任务：
   - 更新商品评分
   - 更新阿姨评分
   - 发放积分奖励
   - 发送通知给阿姨
```

### 2. 商品评分计算逻辑

**计算公式**：

```
商品评分 = Σ(订单评价分数) / 评价总数

其中：
- 只统计状态为 PUBLISHED 的评价
- 保留1位小数
- 四舍五入
- 评分范围: 1.0 - 5.0
- 无评价时默认 5.0 分
```

**更新策略**：
- 定时任务：每10分钟更新一次
- 实时触发：用户提交评价后立即更新（可选）

### 3. 阿姨评分计算逻辑

**综合评分计算**：

```
阿姨综合评分 = Σ(订单评价分数) / 评价总数
```

**详细评分计算**：

```
服务态度评分 = Σ(service_attitude_score) / 有效评价数
服务质量评分 = Σ(service_quality_score) / 有效评价数
准时性评分 = Σ(punctuality_score) / 有效评价数
清洁度评分 = Σ(cleanliness_score) / 有效评价数
```

**更新策略**：
- 定时任务：每10分钟更新一次
- 实时触发：用户提交评价后立即更新（可选）

### 4. 评价奖励机制

**实现状态**: ✅ 已完成

**奖励规则**:

| 行为 | 奖励积分 | 条件 |
|-----|---------|------|
| 基础评价 | 5积分 | 提交评价 |
| 文字评价 | 10积分 | 文字评价 ≥ 10字 |
| 上传图片 | 5积分 | 至少1张图片 |
| 详细评分 | 5积分 | 填写所有详细评分 |
| 优质评价 | 20积分 | 文字 ≥ 50字 + 图片 ≥ 3张（替代其他奖励） |

**实现代码**:

```java
private int calculatePointsReward(OrderRatingRequest request) {
    int points = 5; // 基础评价奖励
    
    // 文字评价奖励（10字以上）
    if (request.getContent() != null && request.getContent().length() >= 10) {
        points += 10;
    }
    
    // 图片奖励（至少1张）
    if (request.getImages() != null && !request.getImages().isEmpty()) {
        points += 5;
    }
    
    // 详细评分奖励（填写所有详细评分）
    if (request.getServiceAttitudeScore() != null &&
        request.getServiceQualityScore() != null &&
        request.getPunctualityScore() != null &&
        request.getCleanlinessScore() != null) {
        points += 5;
    }
    
    // 优质评价奖励（50字以上 + 3张图片以上）
    if (request.getContent() != null && request.getContent().length() >= 50 &&
        request.getImages() != null && request.getImages().size() >= 3) {
        return 20; // 优质评价替代其他奖励
    }
    
    return points;
}
```

**积分发放**:
- 通过 `UserPointsService.addPoints()` 方法发放
- 积分来源标记为 `RATING_REWARD`
- 描述为 "订单评价"

---

## 接口设计

> **实现状态**: 核心接口已完成  
> **Controller**: `UserRatingController.java`, `StaffRatingController.java`  
> **Service**: `OrderRatingServiceImpl.java`, `RatingTagServiceImpl.java`

### 用户端接口

#### 1. 提交订单评价

**实现状态**: ✅ 已完成

**接口**: `POST /user/order/{orderId}/rating`

**描述**: 用户对已完成的订单进行评价

**权限**: 需要用户登录（通过 `MiniThreadLocal.getUserId()` 获取）

**请求体**: OrderRatingRequest
```json
{
  "score": 5,
  "content": "服务很好，阿姨很专业，家里打扫得很干净",
  "images": [
    "https://example.com/image1.jpg",
    "https://example.com/image2.jpg"
  ],
  "serviceAttitudeScore": 5,
  "serviceQualityScore": 5,
  "punctualityScore": 5,
  "cleanlinessScore": 5,
  "tags": ["服务好", "很专业", "准时到达"],
  "isAnonymous": false
}
```

**响应**:
```json
{
  "code": 200,
  "message": "评价成功",
  "data": {
    "ratingId": 123,
    "pointsReward": 20,
    "rewardReason": "优质评价奖励"
  }
}
```

#### 2. 获取订单评价详情

**实现状态**: ✅ 已完成

**接口**: `GET /user/order/{orderId}/rating`

**描述**: 获取指定订单的评价详情

**权限**: 需要用户登录

**响应**:
```json
{
  "code": 200,
  "message": "获取成功",
  "data": {
    "id": 123,
    "orderId": 456,
    "orderNo": "JY202410130001",
    "score": 5,
    "content": "服务很好，阿姨很专业",
    "images": ["url1", "url2"],
    "serviceAttitudeScore": 5,
    "serviceQualityScore": 5,
    "punctualityScore": 5,
    "cleanlinessScore": 5,
    "tags": ["服务好", "很专业"],
    "isAnonymous": false,
    "status": "PUBLISHED",
    "replyContent": "感谢您的好评",
    "replyTime": "2024-10-13T15:00:00",
    "createdTime": "2024-10-13T14:00:00",
    "staffInfo": {
      "staffId": 789,
      "staffName": "张阿姨",
      "avatar": "https://example.com/avatar.jpg"
    }
  }
}
```

#### 3. 修改订单评价

**实现状态**: ✅ 已完成（已优化）

**接口**: `PUT /user/order/{orderId}/rating`

**描述**: 修改已提交的评价

**权限**: 需要用户登录

**修改规则**:
- ⏰ **15天内**可修改（从评价创建时间算起）
- 🔢 **仅限1次**修改机会
- ❌ **综合评分不可修改**（保证核心指标稳定）
- ✅ 可修改：文字、图片、标签、详细评分、匿名状态
- 💡 修改后显示"已编辑"标签

**请求体**: OrderRatingRequest（注意：score 字段会被忽略）
```json
{
  "content": "修改后的评价内容",
  "images": ["url1", "url2"],
  "serviceAttitudeScore": 5,
  "serviceQualityScore": 5,
  "punctualityScore": 5,
  "cleanlinessScore": 5,
  "tags": ["服务好", "很专业"],
  "isAnonymous": false
}
```

**响应**:
```json
{
  "code": 200,
  "message": "修改成功"
}
```

**错误响应**:
```json
{
  "code": 400,
  "message": "评价修改期限已过（15天内可修改）"
}
// 或
{
  "code": 400,
  "message": "评价仅可修改1次，您已达到修改次数上限"
}
// 或
{
  "code": 400,
  "message": "已删除的评价无法修改"
}
```

#### 4. 删除订单评价

**实现状态**: ✅ 已完成（已优化为逻辑删除）

**接口**: `DELETE /user/order/{orderId}/rating`

**描述**: 删除已提交的评价

**权限**: 需要用户登录

**删除规则**:
- ⏰ **15天内**可删除（从评价创建时间算起）
- 💾 **逻辑删除**（数据保留，状态改为 DELETED）
- ❌ 删除后不可恢复
- 📊 不显示在评价列表中，不计入评分统计
- 🔒 后台保留记录用于数据分析和风控

**响应**:
```json
{
  "code": 200,
  "message": "删除成功"
}
```

**错误响应**:
```json
{
  "code": 400,
  "message": "评价删除期限已过（15天内可删除）"
}
// 或
{
  "code": 400,
  "message": "评价已删除"
}
```

#### 5. 获取我的评价列表

**实现状态**: ✅ 已完成

**接口**: `GET /user/ratings`

**描述**: 获取用户的所有评价记录

**权限**: 需要用户登录

**参数**:
- `page`: 页码，默认1
- `size`: 每页大小，默认10
- `status`: 状态筛选（PUBLISHED, HIDDEN）

**响应**:
```json
{
  "code": 200,
  "message": "获取成功",
  "data": {
    "records": [
      {
        "id": 123,
        "orderId": 456,
        "orderNo": "JY202410130001",
        "productName": "日常保洁",
        "score": 5,
        "content": "服务很好",
        "images": ["url1"],
        "tags": ["服务好"],
        "status": "PUBLISHED",
        "createdTime": "2024-10-13T14:00:00",
        "staffInfo": {
          "staffId": 789,
          "staffName": "张阿姨",
          "avatar": "url"
        }
      }
    ],
    "total": 50,
    "page": 1,
    "size": 10,
    "pages": 5
  }
}
```


#### 6. 获取评价标签列表

**实现状态**: ✅ 已完成

**接口**: `GET /user/ratings/tags`

**描述**: 获取可用的评价标签列表

**权限**: 无需认证

**参数**:
- `category`: 标签分类（SERVICE, ATTITUDE, QUALITY, PUNCTUALITY）

**响应**:
```json
{
  "code": 200,
  "message": "获取成功",
  "data": [
    {
      "id": 1,
      "tagName": "服务好",
      "tagType": "POSITIVE",
      "category": "SERVICE",
      "icon": "url"
    }
  ]
}
```

#### 7. 获取商品评价列表

**实现状态**: ✅ 已完成

**接口**: `GET /user/products/{productId}/ratings`

**描述**: 获取指定商品的评价列表

**权限**: 无需认证


**参数**:
- `page`: 页码，默认1
- `size`: 每页大小，默认10
- `scoreFilter`: 评分筛选（1-5，可选）
- `hasImages`: 是否有图片（true/false，可选）
- `sortBy`: 排序方式（TIME-时间, SCORE-评分, LIKE-点赞数）

**响应**:
```json
{
  "code": 200,
  "message": "获取成功",
  "data": {
    "summary": {
      "averageScore": 4.8,
      "totalCount": 100,
      "scoreDistribution": {
        "5": 80,
        "4": 15,
        "3": 3,
        "2": 1,
        "1": 1
      },
      "tagStatistics": [
        {"tagName": "服务好", "count": 50},
        {"tagName": "很专业", "count": 45}
      ]
    },
    "records": [
      {
        "id": 123,
        "score": 5,
        "content": "服务很好",
        "images": ["url1"],
        "tags": ["服务好"],
        "isAnonymous": false,
        "createdTime": "2024-10-13T14:00:00",
        "userInfo": {
          "nickname": "张先生",
          "avatar": "url"
        },
        "replyContent": "感谢支持",
        "replyTime": "2024-10-13T15:00:00"
      }
    ],
    "total": 100,
    "page": 1,
    "size": 10,
    "pages": 10
  }
}
```

### 阿姨端接口

#### 8. 获取我的评价列表

**实现状态**: ✅ 已完成

**接口**: `GET /staff/ratings`

**描述**: 获取阿姨收到的评价列表

**权限**: 需要阿姨登录（通过 `MiniThreadLocal.getUserId()` 获取staffId）

**参数**:
- `page`: 页码，默认1
- `size`: 每页大小，默认10
- `scoreFilter`: 评分筛选（1-5）

**响应**:
```json
{
  "code": 200,
  "message": "获取成功",
  "data": {
    "summary": {
      "averageScore": 4.8,
      "totalCount": 100,
      "serviceAttitudeRating": 4.9,
      "serviceQualityRating": 4.8,
      "punctualityRating": 4.7,
      "cleanlinessRating": 4.9,
      "scoreDistribution": {
        "5": 80,
        "4": 15,
        "3": 3,
        "2": 1,
        "1": 1
      }
    },
    "records": [
      {
        "id": 123,
        "orderId": 456,
        "orderNo": "JY202410130001",
        "productName": "日常保洁",
        "score": 5,
        "content": "服务很好",
        "images": ["url1"],
        "serviceAttitudeScore": 5,
        "serviceQualityScore": 5,
        "punctualityScore": 5,
        "cleanlinessScore": 5,
        "tags": ["服务好", "很专业"],
        "isAnonymous": false,
        "createdTime": "2024-10-13T14:00:00",
        "userInfo": {
          "nickname": "张先生",
          "avatar": "url"
        },
        "replyContent": null,
        "replyTime": null
      }
    ],
    "total": 100,
    "page": 1,
    "size": 10,
    "pages": 10
  }
}
```

#### 9. 回复评价

**实现状态**: ✅ 已完成

**接口**: `POST /staff/ratings/{ratingId}/reply`

**描述**: 阿姨回复用户评价

**权限**: 需要阿姨登录

**请求体**:
```json
{
  "replyContent": "感谢您的好评，期待下次为您服务"
}
```

**响应**:
```json
{
  "code": 200,
  "message": "回复成功"
}
```

#### 10. 获取评价统计

**实现状态**: ✅ 已完成

**接口**: `GET /staff/ratings/statistics`

**描述**: 获取阿姨的评价统计数据

**权限**: 需要阿姨登录

**参数**:
- `period`: 统计周期（WEEK-本周, MONTH-本月, YEAR-本年, ALL-全部）

**响应**:
```json
{
  "code": 200,
  "message": "获取成功",
  "data": {
    "period": "MONTH",
    "averageScore": 4.8,
    "totalCount": 50,
    "serviceAttitudeRating": 4.9,
    "serviceQualityRating": 4.8,
    "punctualityRating": 4.7,
    "cleanlinessRating": 4.9,
    "scoreDistribution": {
      "5": 40,
      "4": 8,
      "3": 1,
      "2": 1,
      "1": 0
    },
    "tagStatistics": [
      {"tagName": "服务好", "count": 30},
      {"tagName": "很专业", "count": 25},
      {"tagName": "准时到达", "count": 20}
    ],
    "trend": [
      {"date": "2024-10-01", "averageScore": 4.7, "count": 10},
      {"date": "2024-10-08", "averageScore": 4.8, "count": 15},
      {"date": "2024-10-15", "averageScore": 4.9, "count": 25}
    ]
  }
}
```

### 管理端接口

#### 11. 管理评价（隐藏/显示）

**实现状态**: ❌ 未实现（管理端功能待开发）

**接口**: `PUT /admin/ratings/{ratingId}/status`

**描述**: 管理员管理评价状态

**权限**: 需要管理员登录

**TODO**: 需要在 `jiayou-admin-service` 中实现

**请求体**:
```json
{
  "status": "HIDDEN",
  "reason": "违规内容"
}
```

**响应**:
```json
{
  "code": 200,
  "message": "操作成功"
}
```

---

## 前端交互流程

### 1. 用户评价订单流程

#### 页面结构

```
订单详情页
  ↓ 点击"评价"按钮
评价页面
  ├── 订单信息展示
  ├── 阿姨信息展示
  ├── 综合评分（必填）
  │   └── 星级选择器（1-5星）
  ├── 详细评分（可选）
  │   ├── 服务态度（1-5星）
  │   ├── 服务质量（1-5星）
  │   ├── 准时性（1-5星）
  │   └── 清洁度（1-5星）
  ├── 评价标签（可选）
  │   └── 标签选择器（多选）
  ├── 文字评价（可选）
  │   └── 文本输入框（最多500字）
  ├── 图片上传（可选）
  │   └── 最多9张图片
  ├── 匿名选项
  │   └── 勾选框
  └── 提交按钮
```

#### Vue.js 代码示例

```vue
<template>
  <view class="rating-page">
    <!-- 订单信息 -->
    <view class="order-info">
      <view class="order-no">订单号：{{ orderInfo.orderNo }}</view>
      <view class="service-name">{{ orderInfo.productName }}</view>
      <view class="service-time">服务时间：{{ orderInfo.serviceTime }}</view>
    </view>

    <!-- 阿姨信息 -->
    <view class="staff-info">
      <image :src="staffInfo.avatar" class="avatar"></image>
      <view class="staff-name">{{ staffInfo.name }}</view>
    </view>

    <!-- 综合评分 -->
    <view class="rating-section">
      <view class="section-title">综合评分 <text class="required">*</text></view>
      <view class="star-rating">
        <view 
          v-for="star in 5" 
          :key="star"
          class="star"
          :class="{ active: star <= form.score }"
          @click="setScore(star)"
        >
          ★
        </view>
      </view>
      <view class="score-desc">{{ scoreDescriptions[form.score] }}</view>
    </view>

    <!-- 详细评分 -->
    <view class="detail-rating">
      <view class="section-title">详细评分（可选）</view>
      
      <view class="rating-item">
        <text>服务态度</text>
        <view class="star-rating small">
          <view 
            v-for="star in 5" 
            :key="star"
            class="star"
            :class="{ active: star <= form.serviceAttitudeScore }"
            @click="form.serviceAttitudeScore = star"
          >
            ★
          </view>
        </view>
      </view>

      <view class="rating-item">
        <text>服务质量</text>
        <view class="star-rating small">
          <view 
            v-for="star in 5" 
            :key="star"
            class="star"
            :class="{ active: star <= form.serviceQualityScore }"
            @click="form.serviceQualityScore = star"
          >
            ★
          </view>
        </view>
      </view>

      <view class="rating-item">
        <text>准时性</text>
        <view class="star-rating small">
          <view 
            v-for="star in 5" 
            :key="star"
            class="star"
            :class="{ active: star <= form.punctualityScore }"
            @click="form.punctualityScore = star"
          >
            ★
          </view>
        </view>
      </view>

      <view class="rating-item">
        <text>清洁度</text>
        <view class="star-rating small">
          <view 
            v-for="star in 5" 
            :key="star"
            class="star"
            :class="{ active: star <= form.cleanlinessScore }"
            @click="form.cleanlinessScore = star"
          >
            ★
          </view>
        </view>
      </view>
    </view>

    <!-- 评价标签 -->
    <view class="tags-section">
      <view class="section-title">选择标签（可选）</view>
      <view class="tags-list">
        <view 
          v-for="tag in availableTags" 
          :key="tag.id"
          class="tag"
          :class="{ 
            active: form.tags.includes(tag.tagName),
            positive: tag.tagType === 'POSITIVE',
            negative: tag.tagType === 'NEGATIVE'
          }"
          @click="toggleTag(tag.tagName)"
        >
          {{ tag.tagName }}
        </view>
      </view>
    </view>

    <!-- 文字评价 -->
    <view class="content-section">
      <view class="section-title">
        文字评价（可选）
        <text class="tip">{{ form.content.length }}/500</text>
      </view>
      <textarea 
        v-model="form.content"
        placeholder="说说您的服务体验吧，10字以上可获得积分奖励"
        maxlength="500"
        class="content-input"
      ></textarea>
    </view>

    <!-- 图片上传 -->
    <view class="images-section">
      <view class="section-title">
        上传图片（可选）
        <text class="tip">最多9张，上传图片可获得积分奖励</text>
      </view>
      <view class="images-list">
        <view 
          v-for="(image, index) in form.images" 
          :key="index"
          class="image-item"
        >
          <image :src="image" mode="aspectFill"></image>
          <view class="delete-btn" @click="removeImage(index)">×</view>
        </view>
        <view 
          v-if="form.images.length < 9"
          class="upload-btn"
          @click="chooseImage"
        >
          <text>+</text>
        </view>
      </view>
    </view>

    <!-- 匿名选项 -->
    <view class="anonymous-section">
      <checkbox-group @change="onAnonymousChange">
        <label>
          <checkbox :checked="form.isAnonymous" />
          匿名评价
        </label>
      </checkbox-group>
    </view>

    <!-- 积分奖励提示 -->
    <view class="reward-tips">
      <view class="tip-item">
        <text class="icon">🎁</text>
        <text>文字评价10字以上：+10积分</text>
      </view>
      <view class="tip-item">
        <text class="icon">📷</text>
        <text>上传图片：+5积分</text>
      </view>
      <view class="tip-item">
        <text class="icon">⭐</text>
        <text>填写详细评分：+5积分</text>
      </view>
      <view class="tip-item">
        <text class="icon">💎</text>
        <text>优质评价（50字+3图）：+20积分</text>
      </view>
    </view>

    <!-- 提交按钮 -->
    <view class="submit-section">
      <button 
        class="submit-btn"
        :disabled="!canSubmit"
        @click="submitRating"
      >
        提交评价
      </button>
    </view>
  </view>
</template>

<script>
export default {
  data() {
    return {
      orderId: null,
      orderInfo: {},
      staffInfo: {},
      availableTags: [],
      form: {
        score: 5,
        serviceAttitudeScore: null,
        serviceQualityScore: null,
        punctualityScore: null,
        cleanlinessScore: null,
        content: '',
        images: [],
        tags: [],
        isAnonymous: false
      },
      scoreDescriptions: {
        1: '非常不满意',
        2: '不满意',
        3: '一般',
        4: '满意',
        5: '非常满意'
      }
    };
  },
  
  computed: {
    canSubmit() {
      return this.form.score > 0;
    }
  },
  
  onLoad(options) {
    this.orderId = options.orderId;
    this.loadOrderInfo();
    this.loadTags();
  },
  
  methods: {
    async loadOrderInfo() {
      try {
        const res = await this.$http.get(`/user/order/${this.orderId}`);
        this.orderInfo = res.data;
        this.staffInfo = res.data.staffInfo;
      } catch (error) {
        uni.showToast({
          title: '加载订单信息失败',
          icon: 'none'
        });
      }
    },
    
    async loadTags() {
      try {
        const res = await this.$http.get('/user/ratings/tags');
        this.availableTags = res.data;
      } catch (error) {
        console.error('加载标签失败', error);
      }
    },
    
    setScore(score) {
      this.form.score = score;
    },
    
    toggleTag(tagName) {
      const index = this.form.tags.indexOf(tagName);
      if (index > -1) {
        this.form.tags.splice(index, 1);
      } else {
        this.form.tags.push(tagName);
      }
    },
    
    chooseImage() {
      uni.chooseImage({
        count: 9 - this.form.images.length,
        success: (res) => {
          this.uploadImages(res.tempFilePaths);
        }
      });
    },
    
    async uploadImages(filePaths) {
      uni.showLoading({ title: '上传中...' });
      
      try {
        for (const filePath of filePaths) {
          const uploadRes = await this.$http.upload('/common/upload', {
            filePath: filePath,
            name: 'file',
            formData: { fileType: 'rating_image' }
          });
          
          this.form.images.push(uploadRes.data);
        }
        
        uni.hideLoading();
        uni.showToast({
          title: '上传成功',
          icon: 'success'
        });
      } catch (error) {
        uni.hideLoading();
        uni.showToast({
          title: '上传失败',
          icon: 'none'
        });
      }
    },
    
    removeImage(index) {
      this.form.images.splice(index, 1);
    },
    
    onAnonymousChange(e) {
      this.form.isAnonymous = e.detail.value.length > 0;
    },
    
    async submitRating() {
      if (!this.canSubmit) {
        return;
      }
      
      uni.showLoading({ title: '提交中...' });
      
      try {
        const res = await this.$http.post(
          `/user/order/${this.orderId}/rating`,
          this.form
        );
        
        uni.hideLoading();
        
        // 显示积分奖励
        if (res.data.pointsReward > 0) {
          uni.showModal({
            title: '评价成功',
            content: `感谢您的评价！获得 ${res.data.pointsReward} 积分奖励`,
            showCancel: false,
            success: () => {
              uni.navigateBack();
            }
          });
        } else {
          uni.showToast({
            title: '评价成功',
            icon: 'success',
            success: () => {
              setTimeout(() => {
                uni.navigateBack();
              }, 1500);
            }
          });
        }
      } catch (error) {
        uni.hideLoading();
        uni.showToast({
          title: error.message || '提交失败',
          icon: 'none'
        });
      }
    }
  }
};
</script>

<style lang="scss" scoped>
.rating-page {
  padding: 20rpx;
  background: #f5f5f5;
  min-height: 100vh;
}

.order-info {
  background: white;
  padding: 30rpx;
  border-radius: 20rpx;
  margin-bottom: 20rpx;
}

.staff-info {
  background: white;
  padding: 30rpx;
  border-radius: 20rpx;
  margin-bottom: 20rpx;
  display: flex;
  align-items: center;
  
  .avatar {
    width: 100rpx;
    height: 100rpx;
    border-radius: 50%;
    margin-right: 20rpx;
  }
}

.rating-section {
  background: white;
  padding: 30rpx;
  border-radius: 20rpx;
  margin-bottom: 20rpx;
  
  .star-rating {
    display: flex;
    justify-content: center;
    margin: 20rpx 0;
    
    .star {
      font-size: 60rpx;
      color: #ddd;
      margin: 0 10rpx;
      cursor: pointer;
      
      &.active {
        color: #ff9900;
      }
    }
  }
  
  .score-desc {
    text-align: center;
    color: #666;
    font-size: 28rpx;
  }
}

.detail-rating {
  background: white;
  padding: 30rpx;
  border-radius: 20rpx;
  margin-bottom: 20rpx;
  
  .rating-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin: 20rpx 0;
    
    .star-rating.small .star {
      font-size: 40rpx;
      margin: 0 5rpx;
    }
  }
}

.tags-section {
  background: white;
  padding: 30rpx;
  border-radius: 20rpx;
  margin-bottom: 20rpx;
  
  .tags-list {
    display: flex;
    flex-wrap: wrap;
    gap: 20rpx;
    margin-top: 20rpx;
    
    .tag {
      padding: 10rpx 30rpx;
      border-radius: 40rpx;
      border: 2rpx solid #ddd;
      font-size: 28rpx;
      
      &.active {
        border-color: #ff9900;
        background: #fff7e6;
        color: #ff9900;
      }
      
      &.positive {
        border-color: #52c41a;
        
        &.active {
          background: #f6ffed;
          color: #52c41a;
        }
      }
      
      &.negative {
        border-color: #ff4d4f;
        
        &.active {
          background: #fff1f0;
          color: #ff4d4f;
        }
      }
    }
  }
}

.content-section {
  background: white;
  padding: 30rpx;
  border-radius: 20rpx;
  margin-bottom: 20rpx;
  
  .content-input {
    width: 100%;
    min-height: 200rpx;
    padding: 20rpx;
    border: 2rpx solid #eee;
    border-radius: 10rpx;
    margin-top: 20rpx;
  }
}

.images-section {
  background: white;
  padding: 30rpx;
  border-radius: 20rpx;
  margin-bottom: 20rpx;
  
  .images-list {
    display: flex;
    flex-wrap: wrap;
    gap: 20rpx;
    margin-top: 20rpx;
    
    .image-item {
      position: relative;
      width: 200rpx;
      height: 200rpx;
      
      image {
        width: 100%;
        height: 100%;
        border-radius: 10rpx;
      }
      
      .delete-btn {
        position: absolute;
        top: -10rpx;
        right: -10rpx;
        width: 40rpx;
        height: 40rpx;
        background: red;
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 30rpx;
      }
    }
    
    .upload-btn {
      width: 200rpx;
      height: 200rpx;
      border: 2rpx dashed #ddd;
      border-radius: 10rpx;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 60rpx;
      color: #999;
    }
  }
}

.anonymous-section {
  background: white;
  padding: 30rpx;
  border-radius: 20rpx;
  margin-bottom: 20rpx;
}

.reward-tips {
  background: #fff7e6;
  padding: 30rpx;
  border-radius: 20rpx;
  margin-bottom: 20rpx;
  
  .tip-item {
    display: flex;
    align-items: center;
    margin: 10rpx 0;
    font-size: 26rpx;
    color: #666;
    
    .icon {
      margin-right: 10rpx;
    }
  }
}

.submit-section {
  padding: 30rpx 0;
  
  .submit-btn {
    width: 100%;
    background: linear-gradient(135deg, #ff9900, #ff6600);
    color: white;
    border-radius: 50rpx;
    height: 90rpx;
    line-height: 90rpx;
    font-size: 32rpx;
    
    &[disabled] {
      background: #ddd;
    }
  }
}

.section-title {
  font-size: 30rpx;
  font-weight: bold;
  margin-bottom: 10rpx;
  
  .required {
    color: red;
  }
  
  .tip {
    font-size: 24rpx;
    color: #999;
    font-weight: normal;
    margin-left: 10rpx;
  }
}
</style>
```

### 2. 查看商品评价流程

#### 页面结构

```
商品详情页
  ↓ 点击"用户评价"标签
评价列表页
  ├── 评价统计摘要
  │   ├── 平均评分
  │   ├── 评价总数
  │   ├── 评分分布图
  │   └── 热门标签
  ├── 筛选条件
  │   ├── 评分筛选（全部/5星/4星/3星/2星/1星）
  │   ├── 有图筛选
  │   └── 排序方式（时间/评分/点赞数）
  └── 评价列表
      └── 评价卡片
          ├── 用户信息
          ├── 评分
          ├── 评价内容
          ├── 评价图片
          ├── 评价标签
          ├── 点赞按钮
          └── 商家回复
```

### 3. 阿姨查看评价流程

#### 页面结构

```
阿姨个人中心
  ↓ 点击"我的评价"
评价统计页
  ├── 评价概览
  │   ├── 综合评分
  │   ├── 评价总数
  │   ├── 详细评分（服务态度、质量、准时性、清洁度）
  │   └── 评分趋势图
  ├── 周期选择（本周/本月/本年/全部）
  └── 评价列表
      └── 评价卡片
          ├── 订单信息
          ├── 用户信息
          ├── 评分详情
          ├── 评价内容
          ├── 评价图片
          ├── 评价标签
          └── 回复按钮
```

---

## 评分计算规则

### 1. 商品评分计算

**定时任务**: `ProductRatingUpdateTask`

**执行频率**: 每10分钟（cron: `0 */10 * * * ?`）

**计算逻辑**:

```java
// 1. 查询所有在售商品
List<Product> products = productMapper.selectList(
    new LambdaQueryWrapper<Product>()
        .eq(Product::getStatus, "ACTIVE")
        .eq(Product::getIsOnSale, true)
);

// 2. 对每个商品计算评分
for (Product product : products) {
    // 查询该商品的所有已发布评价
    List<OrderRating> ratings = orderRatingMapper.selectList(
        new LambdaQueryWrapper<OrderRating>()
            .eq(OrderRating::getProductId, product.getId())
            .eq(OrderRating::getStatus, "PUBLISHED")
    );
    
    if (!ratings.isEmpty()) {
        // 计算平均分
        double totalScore = ratings.stream()
            .mapToDouble(r -> r.getScore() != null ? r.getScore().doubleValue() : 0)
            .sum();
        
        BigDecimal avgRating = BigDecimal.valueOf(totalScore / ratings.size())
            .setScale(1, RoundingMode.HALF_UP);
        
        // 确保评分在 1.0 - 5.0 之间
        if (avgRating.compareTo(BigDecimal.ONE) < 0) {
            avgRating = BigDecimal.ONE;
        } else if (avgRating.compareTo(new BigDecimal("5.0")) > 0) {
            avgRating = new BigDecimal("5.0");
        }
        
        // 更新商品评分和评价数量
        product.setRating(avgRating);
        product.setReviewCount(ratings.size());
    } else {
        // 没有评价时默认5.0分
        product.setRating(new BigDecimal("5.0"));
        product.setReviewCount(0);
    }
    
    product.setUpdatedTime(LocalDateTime.now());
    productMapper.updateById(product);
}
```

### 2. 阿姨评分计算

**定时任务**: `StaffRatingUpdateTask`

**执行频率**: 每10分钟（cron: `0 */10 * * * ?`）

**计算逻辑**:

```java
// 1. 查询所有活跃阿姨
List<Staff> staffList = staffMapper.selectList(
    new LambdaQueryWrapper<Staff>()
        .eq(Staff::getStatus, StatusConstants.General.ACTIVE)
        .eq(Staff::getCertificationStatus, "CERTIFIED")
);

// 2. 对每个阿姨计算评分
for (Staff staff : staffList) {
    // 查询该阿姨的所有已发布评价
    List<OrderRating> ratings = orderRatingMapper.selectList(
        new LambdaQueryWrapper<OrderRating>()
            .eq(OrderRating::getStaffId, staff.getId())
            .eq(OrderRating::getStatus, "PUBLISHED")
    );
    
    if (!ratings.isEmpty()) {
        // 计算综合评分
        double totalScore = ratings.stream()
            .mapToDouble(r -> r.getScore() != null ? r.getScore().doubleValue() : 0)
            .sum();
        
        BigDecimal avgRating = BigDecimal.valueOf(totalScore / ratings.size())
            .setScale(1, RoundingMode.HALF_UP);
        
        // 计算详细评分
        BigDecimal serviceAttitudeRating = calculateDetailScore(
            ratings, OrderRating::getServiceAttitudeScore
        );
        BigDecimal serviceQualityRating = calculateDetailScore(
            ratings, OrderRating::getServiceQualityScore
        );
        BigDecimal punctualityRating = calculateDetailScore(
            ratings, OrderRating::getPunctualityScore
        );
        BigDecimal cleanlinessRating = calculateDetailScore(
            ratings, OrderRating::getCleanlinessScore
        );
        
        // 更新阿姨评分
        staff.setRating(avgRating);
        staff.setReviewCount(ratings.size());
        staff.setServiceAttitudeRating(serviceAttitudeRating);
        staff.setServiceQualityRating(serviceQualityRating);
        staff.setPunctualityRating(punctualityRating);
        staff.setCleanlinessRating(cleanlinessRating);
    } else {
        // 没有评价时默认5.0分
        staff.setRating(new BigDecimal("5.0"));
        staff.setReviewCount(0);
        staff.setServiceAttitudeRating(new BigDecimal("5.0"));
        staff.setServiceQualityRating(new BigDecimal("5.0"));
        staff.setPunctualityRating(new BigDecimal("5.0"));
        staff.setCleanlinessRating(new BigDecimal("5.0"));
    }
    
    staff.setUpdatedTime(LocalDateTime.now());
    staffMapper.updateById(staff);
}

// 辅助方法：计算详细评分
private BigDecimal calculateDetailScore(
    List<OrderRating> ratings, 
    Function<OrderRating, Byte> scoreGetter
) {
    List<Byte> scores = ratings.stream()
        .map(scoreGetter)
        .filter(Objects::nonNull)
        .collect(Collectors.toList());
    
    if (scores.isEmpty()) {
        return new BigDecimal("5.0");
    }
    
    double avg = scores.stream()
        .mapToDouble(Byte::doubleValue)
        .average()
        .orElse(5.0);
    
    return BigDecimal.valueOf(avg).setScale(1, RoundingMode.HALF_UP);
}
```

### 3. 积分奖励计算

**实现状态**: ✅ 已完成

**触发时机**: 用户提交评价后

**计算逻辑**:

```java
// 位置: OrderRatingServiceImpl.java
private int calculatePointsReward(OrderRatingRequest request) {
    int points = 5; // 基础评价奖励
    
    // 文字评价奖励（10字以上）
    if (request.getContent() != null && request.getContent().length() >= 10) {
        points += 10;
    }
    
    // 图片奖励（至少1张）
    if (request.getImages() != null && !request.getImages().isEmpty()) {
        points += 5;
    }
    
    // 详细评分奖励（填写所有详细评分）
    if (request.getServiceAttitudeScore() != null &&
        request.getServiceQualityScore() != null &&
        request.getPunctualityScore() != null &&
        request.getCleanlinessScore() != null) {
        points += 5;
    }
    
    // 优质评价奖励（50字以上 + 3张图片以上）
    if (request.getContent() != null && request.getContent().length() >= 50 &&
        request.getImages() != null && request.getImages().size() >= 3) {
        return 20; // 优质评价替代其他奖励
    }
    
    return points;
}
```

**积分发放实现**:

```java
// 计算积分奖励
int pointsReward = calculatePointsReward(request);

// 发放积分
if (pointsReward > 0) {
    userPointsService.addPoints(
        userId, 
        pointsReward, 
        "订单评价", 
        "RATING_REWARD"
    );
}

// 返回结果
Map<String, Object> result = new HashMap<>();
result.put("ratingId", rating.getId());
result.put("pointsReward", pointsReward);
result.put("rewardReason", pointsReward >= 20 ? "优质评价奖励" : "评价奖励");
return result;
```

---

## 定时任务设计

> **实现状态**: ✅ 已完成  
> **分布式锁**: 使用 `@DistributedLock` 注解（基于 Redisson）

### 1. 商品评分更新任务

**实现状态**: ✅ 已完成

**类名**: `ProductRatingUpdateTask`

**路径**: `jiayou-miniprogram-service/src/main/java/com/jiayou/miniprogram/task/ProductRatingUpdateTask.java`

**配置**:
- **执行频率**: 每10分钟
- **Cron表达式**: `0 */10 * * * ?`
- **分布式锁**: `product:rating:update`
- **锁过期时间**: 590秒（9分50秒）

**实现要点**:
- 只更新在售商品（`status=ACTIVE` 且 `is_on_sale=true`）
- 只统计已发布的评价（`status=PUBLISHED`）
- 无评价时默认5.0分
- 保留1位小数，四舍五入
- 评分范围限制在 1.0-5.0

### 2. 阿姨评分更新任务

**实现状态**: ✅ 已完成

**类名**: `StaffRatingUpdateTask`

**路径**: `jiayou-miniprogram-service/src/main/java/com/jiayou/miniprogram/task/StaffRatingUpdateTask.java`

**配置**:
- **执行频率**: 每10分钟
- **Cron表达式**: `0 */10 * * * ?`
- **分布式锁**: `staff:rating:update`
- **锁过期时间**: 590秒（9分50秒）

**实现要点**:
- 只更新活跃且已认证的阿姨（`status=ACTIVE` 且 `certification_status=APPROVED`）
- 计算综合评分和4个详细评分维度
- 只统计已发布的评价
- 无评价时默认5.0分

### 3. 定时任务监控

**监控指标**:
- 任务执行时长
- 更新商品/阿姨数量
- 失败次数
- 异常日志

**告警规则**:
- 执行时长超过5分钟
- 连续3次失败
- 更新数量为0

---

## 实现清单

> **总体进度**: 核心功能 100% | 增强功能 85%  
> **最后更新**: 2025-10-13

### 📦 数据库变更

- [x] ✅ 优化 `order_rating` 表结构（添加详细评分、标签、图片等字段）
- [x] ✅ 添加 `product` 表评分字段（rating, review_count）
- [x] ✅ 添加 `staff` 表评分字段（rating, review_count, 4个详细评分）
- [x] ✅ 创建 `rating_tag` 评价标签表
- [x] ✅ 初始化标签数据（26个预设标签）

**SQL脚本**: `jiayou-admin-service/src/main/resources/sql/6.rating_system.sql`

### 🔧 实体类 (Entity)

**路径**: `jiayou-common/src/main/java/com/jiayou/common/entity/`

- [x] ✅ `OrderRating.java` - 订单评价实体（已优化，包含详细评分和标签）
- [x] ✅ `RatingTag.java` - 评价标签实体
- [x] ✅ `Product.java` - 添加评分字段（rating, reviewCount）
- [x] ✅ `Staff.java` - 添加评分字段（rating, reviewCount, 4个详细评分）

### 📝 DTO类

**路径**: `jiayou-miniprogram-service/src/main/java/com/jiayou/miniprogram/dto/`

#### 请求DTO
- [x] ✅ `OrderRatingRequest.java` - 提交评价请求
- [x] ✅ `RatingReplyRequest.java` - 回复评价请求
- [x] ✅ `RatingQueryRequest.java` - 查询评价请求（继承 PageRequest）

#### 响应DTO
- [x] ✅ `OrderRatingResponse.java` - 评价详情响应
- [x] ✅ `ProductRatingListResponse.java` - 商品评价列表响应（包含统计摘要）
- [ ] ⚠️ `RatingStatisticsResponse.java` - 评价统计响应（部分实现在 ProductRatingListResponse 中）

### 🗄️ Mapper接口

**路径**: `jiayou-common/src/main/java/com/jiayou/common/mapper/`

- [x] ✅ `OrderRatingMapper.java` - 订单评价Mapper
- [x] ✅ `RatingTagMapper.java` - 评价标签Mapper

### 🔨 Service层

**路径**: `jiayou-miniprogram-service/src/main/java/com/jiayou/miniprogram/service/`

#### 接口
- [x] ✅ `OrderRatingService.java` - 订单评价服务接口（11个方法）
- [x] ✅ `RatingTagService.java` - 评价标签服务接口

#### 实现
- [x] ✅ `OrderRatingServiceImpl.java` - 订单评价服务实现
  - ✅ 提交评价（含积分奖励）
  - ✅ 获取评价详情
  - ✅ 修改评价（15天内、1次限制、评分不可改）
  - ✅ 删除评价（15天内、逻辑删除）
  - ✅ 获取我的评价列表（排除已删除）
  - ✅ 获取商品评价列表
  - ✅ 阿姨回复评价
  - ✅ 获取阿姨评价列表
  - ✅ 获取阿姨评价统计
- [x] ✅ `RatingTagServiceImpl.java` - 评价标签服务实现

### 🎮 Controller层

**路径**: `jiayou-miniprogram-service/src/main/java/com/jiayou/miniprogram/controller/`

- [x] ✅ `UserRatingController.java` - 用户评价控制器（7个接口）
  - POST `/user/order/{orderId}/rating` - 提交评价
  - GET `/user/order/{orderId}/rating` - 获取评价详情
  - PUT `/user/order/{orderId}/rating` - 修改评价
  - DELETE `/user/order/{orderId}/rating` - 删除评价
  - GET `/user/ratings` - 我的评价列表
  - GET `/user/ratings/tags` - 获取标签列表
  - GET `/user/products/{productId}/ratings` - 商品评价列表
  
- [x] ✅ `StaffRatingController.java` - 阿姨评价控制器（3个接口）
  - GET `/staff/ratings` - 阿姨评价列表
  - POST `/staff/ratings/{ratingId}/reply` - 回复评价
  - GET `/staff/ratings/statistics` - 评价统计

### ⏰ 定时任务

**路径**: `jiayou-miniprogram-service/src/main/java/com/jiayou/miniprogram/task/`

- [x] ✅ `ProductRatingUpdateTask.java` - 商品评分更新任务
  - 执行频率：每10分钟
  - 分布式锁：`product:rating:update`
  
- [x] ✅ `StaffRatingUpdateTask.java` - 阿姨评分更新任务
  - 执行频率：每10分钟
  - 分布式锁：`staff:rating:update`

### 🔐 分布式锁

**路径**: `jiayou-miniprogram-service/src/main/java/com/jiayou/miniprogram/lock/`

- [x] ✅ `DistributedLock.java` - 分布式锁注解
- [x] ✅ `DistributedLockAspect.java` - 分布式锁AOP实现（基于 Redisson）

### 📚 文档更新

- [x] ✅ 更新 `小程序API接口文档.md`（添加11个评价相关接口）
- [x] ✅ 创建 `评价评分体系完整设计文档.md`（本文档）
- [x] ✅ 更新 `接口开发进度跟踪.md`（总接口数 +11）

### 🔧 错误码

**路径**: `jiayou-common/src/main/java/com/jiayou/common/result/ResultCode.java`

- [x] ✅ 添加评价相关错误码（2100-2199）
  - `RATING_NOT_FOUND` (2100) - 评价不存在
  - `RATING_ALREADY_EXISTS` (2101) - 订单已评价
  - `RATING_EDIT_EXPIRED` (2102) - 评价修改期限已过
  - `RATING_DELETE_EXPIRED` (2103) - 评价删除期限已过
  - `RATING_SUBMIT_FAILED` (2104) - 评价提交失败

---

## 🎯 开发优先级

### P0 - 核心功能（必须实现）

1. ✅ 数据库表结构优化
2. ✅ 实体类创建和优化
3. ✅ 用户提交评价接口
4. ✅ 获取评价详情接口
5. ✅ 获取商品评价列表接口
6. ✅ 阿姨评分更新定时任务

### P1 - 重要功能（优先实现）

1. ✅ 获取我的评价列表接口
2. ✅ 阿姨回复评价接口
3. ✅ 评价标签管理
4. ✅ 积分奖励机制
5. ✅ 评价统计接口

### P2 - 增强功能（后续实现）

1. ✅ 修改评价接口
2. ✅ 删除评价接口
3. ⬜ 评价举报功能
4. ⬜ 管理端评价管理

---

## 📊 预期效果

### 用户端

1. **提升用户参与度**
   - 积分奖励机制激励用户评价
   - 多维度评分提供更详细的反馈
   - 图片和标签让评价更生动

2. **增强信任度**
   - 真实评价展示服务质量
   - 评分分布图直观展示口碑
   - 商家回复增强互动

### 阿姨端

1. **提升服务质量**
   - 详细评分帮助发现改进点
   - 评价趋势图展示进步
   - 标签统计明确优势和不足

2. **增强职业认同**
   - 好评激励提升服务积极性
   - 评分排名促进良性竞争
   - 回复评价增强与用户互动

### 平台端

1. **提升平台口碑**
   - 高质量评价吸引新用户
   - 评分体系增强平台公信力
   - 数据分析优化运营策略

2. **优化资源配置**
   - 评分数据辅助阿姨推荐
   - 服务质量监控及时预警
   - 用户偏好分析指导产品优化

---

## 🔐 安全与风控

### 1. 评价真实性保障

- **订单关联验证**: 只有完成的订单才能评价
- **一单一评**: 每个订单只能评价一次
- **时效限制**: 订单完成后30天内可评价
- **修改限制**: 评价提交后15天内可修改，仅限1次
- **评分保护**: 综合评分不可修改，保证核心指标稳定
- **逻辑删除**: 删除的评价数据保留，用于风控分析

### 2. 恶意评价防范

- **敏感词过滤**: 自动过滤违规内容
- **举报机制**: 用户可举报不实评价
- **人工审核**: 低分评价人工复核
- **黑名单机制**: 恶意评价用户拉黑

### 3. 刷评防范

- **IP限制**: 同一IP短时间内评价次数限制
- **设备限制**: 同一设备短时间内评价次数限制
- **行为分析**: 异常评价行为检测
- **评价质量评分**: 低质量评价降权

---

## 📈 数据分析与优化

### 1. 评价数据分析

- **评价率统计**: 订单完成后评价率
- **评分分布**: 各星级评价占比
- **标签热度**: 高频标签统计
- **评价趋势**: 评价数量和评分趋势

### 2. 服务质量监控

- **阿姨评分排名**: 定期评分排名
- **低分预警**: 评分下降预警
- **投诉关联**: 评价与投诉关联分析
- **服务改进**: 基于评价的改进建议

### 3. 用户行为分析

- **评价偏好**: 用户评价习惯分析
- **标签偏好**: 用户关注点分析
- **图片上传率**: 图片评价占比
- **匿名率**: 匿名评价占比

---

## 🚀 后续优化方向

### 短期优化（1-3个月）

1. **评价质量提升**
   - AI辅助评价内容生成
   - 评价模板推荐
   - 语音转文字评价

2. **互动增强**
   - 评价点赞功能
   - 评价评论功能
   - 优质评价推荐

3. **数据可视化**
   - 评价数据大屏
   - 个人评价报告
   - 服务质量报告

### 中期优化（3-6个月）

1. **智能推荐**
   - 基于评价的阿姨推荐
   - 基于评价的服务推荐
   - 个性化评价标签

2. **社交化**
   - 评价分享功能
   - 评价排行榜
   - 优质评价官认证

3. **激励机制**
   - 评价勋章系统
   - 评价等级体系
   - 专属评价权益

### 长期优化（6-12个月）

1. **AI赋能**
   - 评价情感分析
   - 服务质量预测
   - 智能客服回复

2. **生态建设**
   - 评价开放平台
   - 第三方评价接入
   - 跨平台评价互认

3. **国际化**
   - 多语言评价支持
   - 国际化评分标准
   - 跨境评价体系

---

## 📞 技术支持

如有疑问，请联系：
- **技术负责人**: [技术团队]
- **产品负责人**: [产品团队]
- **文档维护**: [开发团队]

---

## 部署说明

### 1. 数据库部署

**步骤**:

1. **备份数据库**（重要！）：
   ```bash
   mysqldump -u username -p database_name > backup_$(date +%Y%m%d_%H%M%S).sql
   ```

2. **执行SQL脚本**：
   ```bash
   # 第一步：执行评价系统基础脚本
   mysql -u username -p database_name < jiayou-admin-service/src/main/resources/sql/6.rating_system.sql
   
   # 第二步：执行修改/删除优化脚本（v1.1.0 新增）
   mysql -u username -p database_name < jiayou-admin-service/src/main/resources/sql/7.rating_edit_delete_optimization.sql
   ```

3. **验证表结构**：
   ```sql
   -- 检查 order_rating 表（包含新增字段）
   DESC order_rating;
   
   -- 验证新增字段
   SELECT COLUMN_NAME, COLUMN_TYPE, COLUMN_COMMENT 
   FROM INFORMATION_SCHEMA.COLUMNS 
   WHERE TABLE_SCHEMA = DATABASE() 
   AND TABLE_NAME = 'order_rating' 
   AND COLUMN_NAME IN ('edit_count', 'edit_time', 'deleted_time');
   
   -- 检查 product 表评分字段
   DESC product;
   
   -- 检查 staff 表评分字段
   DESC staff;
   
   -- 检查 rating_tag 表
   DESC rating_tag;
   SELECT COUNT(*) FROM rating_tag; -- 应该有26条记录
   ```

**注意事项**:
- ⚠️ SQL脚本不包含 `IF NOT EXISTS`，如果表/字段已存在会报错，可忽略
- ⚠️ 建议在测试环境先执行，验证无误后再部署生产环境
- ⚠️ 执行前请备份数据库
- 💡 如果已经部署了v1.0.0，只需执行第7个脚本即可

### 2. 应用部署

**依赖检查**:
- ✅ Redis（用于分布式锁）
- ✅ Redisson（已配置在项目中）
- ✅ Spring Boot 3.2.0
- ✅ MyBatis-Plus 3.5.7

**配置检查**:

1. Redis配置（`application.yml`）：
   ```yaml
   spring:
     data:
       redis:
         host: localhost
         port: 6379
         # 其他配置...
   ```

2. 定时任务配置（默认已启用）：
   ```yaml
   spring:
     task:
       scheduling:
         enabled: true
   ```

**部署步骤**:

1. 编译打包：
   ```bash
   mvn clean package -DskipTests
   ```

2. 启动应用：
   ```bash
   java -jar jiayou-miniprogram-service/target/jiayou-miniprogram-service.jar
   ```

3. 验证部署：
   - 检查日志中是否有定时任务启动日志
   - 访问 Swagger 文档验证接口：`http://localhost:8080/doc.html`
   - 测试评价接口

### 3. 功能验证

**测试清单**:

- [ ] 提交订单评价（包含详细评分、标签、图片）
- [ ] 获取评价详情
- [ ] 修改评价
- [ ] 删除评价
- [ ] 获取我的评价列表
- [ ] 点赞评价
- [ ] 获取评价标签列表
- [ ] 获取商品评价列表
- [ ] 阿姨回复评价
- [ ] 获取阿姨评价列表
- [ ] 获取阿姨评价统计
- [ ] 商品评分定时更新（等待10分钟后检查）
- [ ] 阿姨评分定时更新（等待10分钟后检查）

**测试数据准备**:

```sql
-- 1. 确保有已完成的订单
UPDATE `order` SET status = 'COMPLETED' WHERE id = 1;

-- 2. 确保有活跃的商品
UPDATE product SET status = 'ACTIVE', is_on_sale = 1 WHERE id = 1;

-- 3. 确保有活跃的阿姨
UPDATE staff SET status = 'ACTIVE', certification_status = 'APPROVED' WHERE id = 1;
```

---

## 已知问题

### 1. 功能限制

| 问题 | 影响 | 优先级 | 计划修复版本 |
|------|------|--------|-------------|
| 商品评价列表统计功能未完全实现 | 评分分布、标签统计等数据不完整 | P1 | v1.1.0 |
| 管理端评价管理功能未实现 | 无法隐藏/显示评价 | P2 | v1.2.0 |
| 评价举报功能未实现 | 无法举报不实评价 | P2 | v1.2.0 |
| 评价趋势分析未实现 | 无法查看评分趋势图 | P3 | v1.3.0 |

### 2. 性能问题

| 问题 | 影响 | 解决方案 | 状态 |
|------|------|---------|------|
| 定时任务可能执行时间过长 | 商品/阿姨数量多时可能超过10分钟 | 分批处理或增加执行频率 | 待优化 |
| 评价列表查询未优化 | 数据量大时查询慢 | 添加索引、使用缓存 | 待优化 |
| 图片上传未做压缩 | 图片过大影响加载速度 | 前端压缩或后端压缩 | 待优化 |

### 3. 数据一致性

| 问题 | 影响 | 解决方案 | 状态 |
|------|------|---------|------|
| 评分更新有延迟 | 提交评价后评分不会立即更新 | 正常，定时任务10分钟更新一次 | 设计如此 |
| 点赞数可能不准确 | 高并发时可能出现计数偏差 | 使用 Redis 计数器 | 待优化 |

### 4. 安全问题

| 问题 | 影响 | 解决方案 | 状态 |
|------|------|---------|------|
| 敏感词过滤未实现 | 可能出现违规评价内容 | 接入敏感词过滤服务 | 待实现 |
| 刷评防范未实现 | 可能出现恶意刷评 | 添加IP/设备限制、行为分析 | 待实现 |
| 图片内容审核未实现 | 可能上传违规图片 | 接入图片审核服务 | 待实现 |

### 5. 兼容性问题

| 问题 | 影响 | 解决方案 | 状态 |
|------|------|---------|------|
| SQL脚本不支持 `IF NOT EXISTS` | 部分数据库版本执行失败 | 已移除 `IF NOT EXISTS` | ✅ 已修复 |
| 评价图片格式限制 | 未限制图片格式和大小 | 添加格式和大小验证 | 待优化 |

### 6. 待优化项

**短期优化（1个月内）**:
- [ ] 完善商品评价列表统计功能
- [ ] 优化定时任务执行效率
- [ ] 添加评价列表缓存
- [ ] 实现敏感词过滤

**中期优化（3个月内）**:
- [ ] 实现管理端评价管理
- [ ] 实现评价举报功能
- [ ] 优化点赞计数器
- [ ] 实现刷评防范

**长期优化（6个月内）**:
- [ ] 实现评价趋势分析
- [ ] 实现图片内容审核
- [ ] 实现AI辅助评价生成
- [ ] 实现评价质量评分

---

## 技术支持

如有疑问，请联系：
- **技术负责人**: [技术团队]
- **产品负责人**: [产品团队]
- **文档维护**: [开发团队]

---

**文档版本**: v1.1.0  
**创建日期**: 2025-10-13  
**最后更新**: 2025-10-13  
**作者**: 家政平台技术团队

